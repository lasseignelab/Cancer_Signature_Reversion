---
title: "220118_GBM_SignatureSearch"
author: "Jennifer Fisher"
date: "1/18/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    Conduct Signature Reversion on GBM samples with both the DESeq2 approach and the transfer learning approach
    
    Finished psedocode on:
    220118
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker/Singularity: 
    rstudio_cancer_dr
    
    Directory of operations: 
    "/home/rstudio"
    
    Scripts being edited for operations:
    One SignatureSearch function needed adjust for new LINCS datbase, and Tau values needed to added
    
    Data being used: 
    GBM gene expression alaysis output and the latent variable output
    
    Papers and tools:
    SignatureSearch. LINCS method for signature reversion 

# STEPS
### Set working directory 
### load in data
```{r}
GBM_GTEX_limma_res <- readRDS("~/output/TF_L_GBM/220804_GBM_GTEX_limma_res.rds")
recount3_plier <- readRDS("~/data/recount3/recount3_plier_wo.rds")
deseq_results <- read.csv("~/output/deseq2_gbm/220927_deseq2_gbm_normal_gtx_res.csv", sep=",")
```

```{r}
tpm_df <- readRDS("~/output/recount3_gbm_gtex_tpm_df.rds")
metadata <- readRDS("~/output/recount3_gbm_gtex_metadata.rds")
```

### Analysis
```{r}
library(signatureSearch)
library(signatureSearchData)
library(HDF5Array)
library(magrittr)
library(dplyr)
library(recount3)
library(ggplot2)
library(viridis)
library(tidyr)
library(ggpubr)
library(gprofiler2)
library(gplots)
library(ComplexHeatmap)
library(RColorBrewer)
library(circlize)
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
source("/home/rstudio/script/plier_util.R")
source("/home/rstudio/script/test_LV_differences.R")
library(stringr)
library(readr)
```

organize the LINCS data
```{r eval=FALSE}
meta42 <- readr::read_tsv("~/data/LINCS_210914_LEVEL3/siginfo_beta.txt")
dose <- "10 uM"
## filter rows by 'pert_type' as compound, 10uM concentration, and 24h treatment time
#meta42_filter <- sig_filter(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```
filter the LINCS data to 10uM and 24 hour treatment and save it 
```{r eval=FALSE}
meta42_filter <- sig_filter_JLF(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```

```{r eval =FALSE}
gctx <- "~/data/LINCS_LEVEL5_220118/level5_beta_trt_cp_n720216x12328.gctx"
gctx2h5(gctx, cid=meta42_filter$sig_id, new_cid=meta42_filter$pert_cell_factor,
        h5file="~/data/lincs_2020.h5", by_ncol=5000, overwrite=TRUE)
```

```{r eval=FALSE}
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
```

```{r eval=FALSE}
se_asssay<- assay(se)
```

set this path for downstream analysis
```{r eval=FALSE}
db_path <- "~/data/lincs_2020.h5"
```

## signature reversion for DESeq2 GBM vs control 
add genes symbols to the DESeq2 output
```{r}
human_projects<- available_projects()
#get a random project data
test<- create_rse(human_projects[(human_projects$project == "SRP118922"),])
gene_info <- test@rowRanges
rm(test)
```
```{r}
dim(as.data.frame(gene_info))
```

```{r}
identical(gene_info$gene_id, rownames(deseq_results))
```

```{r}
deseq_results$Symbol<- gene_info$gene_name
```

identify the top genes
```{r}
deseq_results<- deseq_results[complete.cases(deseq_results),]
deseq_results_sig <- deseq_results[deseq_results$padj < 0.05 & abs(deseq_results$log2FoldChange) > 2,]
```
target is around 90-120 genes for a signature.
```{r}
downset<- deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange < -4.2]
upset<- deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange > 4.2 ] 
```

convert gene symbols to LINCS genes
```{r}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```

```{r}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```

```{r}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval=FALSE}
deseq_gbm_list<- list(up= upset_v2, down= downset_v2)
```
save gene signature
```{r eval=FALSE}
saveRDS(deseq_gbm_list,"~/output/deseq2_gbm/SR_gene_list_gbm_deseq2.rds")
```

signature reversion
```{r eval=FALSE}
set.seed(101)
qsig_lincs_deseq2_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```
37 / 37 genes in up set share identifiers with reference database
68 / 68 genes in down set share identifiers with reference database

```{r eval=FALSE}
set.seed(101)
lincs_deseq_gbm <- gess_lincs(qsig_lincs_deseq2_res, sortby="NCS", workers=2)
#result(lincs)
```

```{r eval=FALSE}
lincs_deseq_gbm_res <- result(lincs_deseq_gbm)
```
other brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r eval=FALSE}
write.csv(lincs_deseq_gbm_res, file= "~/output/deseq2_gbm/220928_SR_LINCS_GBM_DESEQ2_RES.csv" )
```

```{r eval=FALSE}
lincs_deseq_gbm_res_GI1 <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell == "GI1",]
```

```{r eval=FALSE}
GI1_taudf <- readRDS("~/data/GI1_taudf.rds")
```

```{r eval=FALSE}
tau_test<- tau_scores(lincs_deseq_gbm_res_GI1, GI1_taudf)
```
Tau (Ï„) that ranges from -100 to +100 

```{r eval=FALSE}
lincs_deseq_gbm_res_GI1$jlf_tau<- tau_test
```
```{r eval=FALSE}
write.csv(lincs_deseq_gbm_res_GI1, file= "~/output/deseq2_gbm/220928_lincs_deseq_gbm_res_GI1_tau.csv" )
```

```{r eval=FALSE}
lincs_deseq_gbm_res_GI1_top <- lincs_deseq_gbm_res_GI1[lincs_deseq_gbm_res_GI1$WTCS_FDR <0.05 & lincs_deseq_gbm_res_GI1$NCS <0,]
```


```{r eval=FALSE}
lincs_deseq_gbm_res_GI1_top_order <- lincs_deseq_gbm_res_GI1_top[order(-lincs_deseq_gbm_res_GI1_top$NCS),]
lincs_deseq_gbm_res_GI1_top$pert <- factor(lincs_deseq_gbm_res_GI1_top$pert, levels = lincs_deseq_gbm_res_GI1_top_order$pert)
```


filter by tau and fda approved
```{r eval=FALSE}
lincs_deseq_gbm_res_GI1_top_tau<- lincs_deseq_gbm_res_GI1_top[lincs_deseq_gbm_res_GI1_top$jlf_tau < -80, ]
```

```{r eval=FALSE}
lincs_deseq_gbm_res_GI1_top_tau$FDA <-FDA_APPROVAL_CHECK(as.character(lincs_deseq_gbm_res_GI1_top_tau$pert))
```

```{r eval=FALSE}
FDA_CT_table<- read.csv("~/data/SearchResults.csv")
lincs_deseq_gbm_res_GI1_top_tau$GBM_CT<- clinical_trial_check(as.character(lincs_deseq_gbm_res_GI1_top_tau$pert), FDA_CT_table)
```

```{r eval=FALSE}
lincs_deseq_gbm_res_GI1_top_candidates<- lincs_deseq_gbm_res_GI1_top_tau[lincs_deseq_gbm_res_GI1_top_tau$FDA == TRUE,]
```


```{r eval=FALSE}
p<-ggplot(data=lincs_deseq_gbm_res_GI1_top_candidates , aes(x=pert, y=NCS, fill=jlf_tau, shape= GBM_CT)) +
  geom_bar(stat="identity", color= "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/deseq2_gbm/220928_ggplot_deseq2_tau_gbm_candidates.pdf")
```

```{r}
knitr::include_graphics("~/output/deseq2_gbm/220928_ggplot_deseq2_tau_gbm_candidates.pdf")
```

```{r eval=FALSE}
write.csv(lincs_deseq_gbm_res_GI1_top_candidates, file = "~/output/deseq2_gbm/220928_SR_LINCS_GBM_DESEQ2_RES_all.csv")
```

look brain tumor data
```{r eval=FALSE}
lincs_deseq_gbm_res_brain_tumor <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r eval=FALSE}
lincs_deseq_gbm_res_brain_tumor_top <- lincs_deseq_gbm_res_brain_tumor[lincs_deseq_gbm_res_brain_tumor$WTCS_FDR <0.05 & lincs_deseq_gbm_res_brain_tumor$NCS <0,]
```

```{r eval=FALSE}
lincs_deseq_gbm_res_brain_tumor_top_order <- lincs_deseq_gbm_res_brain_tumor_top[order(-lincs_deseq_gbm_res_brain_tumor_top$NCS),]
lincs_deseq_gbm_res_brain_tumor_top$pert <- factor(lincs_deseq_gbm_res_brain_tumor_top$pert, levels = unique(lincs_deseq_gbm_res_brain_tumor_top_order$pert))
```


```{r eval=FALSE}
g<-ggplot(data=lincs_deseq_gbm_res_brain_tumor_top , aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g + coord_flip() + scale_color_viridis_d()
```
GBM cell line drug target enrichment
```{r eval=FALSE}
hyperG_k_res <- dsea_hyperG(drugs = lincs_deseq_gbm_res_GI1_top_candidates$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2<- result(hyperG_k_res)
```

```{r eval=FALSE}
write.csv(hyperG_k_res_v2, file= "~/output/deseq2_gbm/220928_SR_LINCS_GBM_gbm_cell_drug_pathway_RES.csv" )
```

```{r eval=FALSE}
#false discovery rate
hyperG_k_res_v2$logqvalue<- -log(hyperG_k_res_v2$qvalue)
```

```{r eval=FALSE}
hyperG_k_res_v2$Description<- factor(hyperG_k_res_v2$Description, levels= hyperG_k_res_v2$Description)
```

```{r eval=FALSE}
gbm.2<-ggplot(data=hyperG_k_res_v2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity", color= "black") +ylim(0, 8)
gbm.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
ggsave("~/output/deseq2_gbm/220928_ggplot_deseq2_tau_gbm_candidates_kegg_pathways.pdf")
```

```{r}
knitr::include_graphics("~/output/deseq2_gbm/220928_ggplot_deseq2_tau_gbm_candidates_kegg_pathways.pdf")
```

drug target enrichment with Go terms
```{r eval=FALSE}
hyperG_res_go <- dsea_hyperG(drugs=lincs_deseq_gbm_res_GI1_top$pert, type="GO", ont="ALL")
hyperG_res_go<- result(hyperG_res_go )
```

```{r eval=FALSE}
write.csv(hyperG_res_go, file= "~/output/deseq2_gbm/220928_SR_LINCS_GBM_gbm_cell_drug_Go_terms_RES.csv" )
```

PRISM plotting

```{r eval=FALSE}
prism_gbm_cell_lines <- read.csv("~/output/220808_prism_gbm_candidates.csv")
```

```{r eval=FALSE}
primary_gbm_res_sub <-prism_gbm_cell_lines[ prism_gbm_cell_lines$Var2 %in%  lincs_deseq_gbm_res_GI1_top_candidates$pert,]
write.csv(primary_gbm_res_sub , file= "~/output/TF_L_GBM/220928_prism_deseq2_candidates_gbm.csv" )
```

```{r eval=FALSE}
#primary_paad_res_sub$Var2 <- factor(primary_paad_res_sub$Var2, levels=unique(primary_paad_res_sub$Var2))
primary_gbm_res_sub$Var2 <- factor(primary_gbm_res_sub$Var2, levels=unique(primary_gbm_res_sub$Var2[order(primary_gbm_res_sub$log_fold_change)]))
ggplot(primary_gbm_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() + geom_point()+ geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/TF_L_GBM/220928_ggplot_deseq2_candidates_prism_screen1.png")
```

```{r}
knitr::include_graphics("~/output/TF_L_GBM/220928_ggplot_deseq2_candidates_prism_screen1.png")
```


look at the number of sensitive cell lines
```{r eval=FALSE}
drug_list <- as.vector(unique(primary_gbm_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_gbm_res_sub$Sensitive[primary_gbm_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity",  color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/TF_L_GBM/220928_ggplot_deseq2_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
knitr::include_graphics("~/output/TF_L_GBM/220928_ggplot_deseq2_candidates_prism_screen1_sensitive_cell_lines.png")
```

Determine if the median log fold change is lower than random drug selection. 
```{r eval=FALSE}
deseq2_PRISM_test<- PRISM_testing(101,"GI1",  lincs_deseq_gbm_res_GI1_top_candidates$pert, drug_senstive_precentage_all_drugs)
```
```{r eval=FALSE}
deseq2_PRISM_test
```

	Wilcoxon signed rank test with continuity correction

data:  fraction

V = 5275294, p-value < 2.2e-16

alternative hypothesis: true location is less than 0.9166667


determine if there are more drug from clinical trials than compared to random 
```{r eval=FALSE}
len<- length( lincs_deseq_gbm_res_GI1_top_candidates$pert)
num_clin <- nrow( lincs_deseq_gbm_res_GI1_top_candidates[ lincs_deseq_gbm_res_GI1_top_candidates$GBM_CT == TRUE,])
fract<- num_clin/len
deseq2_CT_test_res <- clinical_trial_testing(101, "GI1", len, fract, FDA_CT_table)
```

```{r eval=FALSE}
deseq2_CT_test_res 
```

	Wilcoxon signed rank test with continuity correction

data:  fraction_adj

V = 81737, p-value < 2.2e-16

alternative hypothesis: true location is less than 0.3076923

LINCS pathways & Drug targets for all the candidates
```{r eval=FALSE}
deseq_results<- cbind(rownames(deseq_results), deseq_results)
for (i in 1:nrow( lincs_deseq_gbm_res_GI1_top_candidates) ){
  targets<- as.vector(unlist( strsplit(lincs_deseq_gbm_res_GI1_top_candidates$t_gn_sym[i], "; ")))
  #print(targets)
  try(drug_analysis(  lincs_deseq_gbm_res_GI1_top_candidates$pert[i], targets, as.data.frame(tpm_df) , metadata$status, deseq_results, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/deseq2_gbm/220928_candidate_plots/"))
}
```


## signature reversion for Transfer Learning GBM vs control 

look at the range of the fold change
```{r}
hist(GBM_GTEX_limma_res$limma$logFC)
```

Wanting to look at the lvs that are show extreme differences 
```{r}
sd <- sd(GBM_GTEX_limma_res$limma$logFC)
mean(GBM_GTEX_limma_res$limma$logFC) - (3*sd)
mean(GBM_GTEX_limma_res$limma$logFC) + (3*sd)
```
+/- 0.2 seems to be a good threshold

```{r}
GBM_GTEX_limma_res_sig <- GBM_GTEX_limma_res$limma[GBM_GTEX_limma_res$limma$adj.P.Val <0.05 & abs(GBM_GTEX_limma_res$limma$logFC)> 0.2,]
```

```{r}
SIG_LVs <- GBM_GTEX_limma_res_sig$LV
SIG_LVs
```

5,11,17,42,43,147,187, 223, 382 are the significant latent variables. n= 9

how many genes to use the disease signatures?
```{r eval=FALSE}
sig_Z_mt <- recount3_plier$Z[,c(5,11,17,42,43,147,187, 223, 382)]
colnames(sig_Z_mt) <- SIG_LVs
```

see if there is a cut off
```{r eval=FALSE}
p <- c(70,80,90,95,98,100)/100
hist(sig_Z_mt[,1])
quantile(sig_Z_mt[,1], p)
hist(sig_Z_mt[,2])
quantile(sig_Z_mt[,2], p)
hist(sig_Z_mt[,3])
quantile(sig_Z_mt[,3], p)
hist(sig_Z_mt[,4])
quantile(sig_Z_mt[,4], p)
hist(sig_Z_mt[,5])
quantile(sig_Z_mt[,5], p)
hist(sig_Z_mt[,6])
quantile(sig_Z_mt[,6], p)
hist(sig_Z_mt[,7])
quantile(sig_Z_mt[,7],p)
hist(sig_Z_mt[,8])
quantile(sig_Z_mt[,8],p)
hist(sig_Z_mt[,9])
quantile(sig_Z_mt[,9],p)
```
no cut off 

look at the top genes. Note that some unique features of this dimension reduction approach are its penalties for 1)  latent variables to reflect annotated pathways such as KEGG and 2) most genes have a zero weight meaning that only a fraction of genes has a high and significant gene weight via the L1 and L2 penalties in the loss function of this algorithm. Also the top genes for the latent variables are unique. 
```{r eval=FALSE}
topgene_1 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,1])][1:25]
topgene_2 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,2])][1:25]
topgene_3 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,3])][1:25]
topgene_4 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,4])][1:25]
topgene_5 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,5])][1:25]
topgene_6 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,6])][1:25]
topgene_7 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,7])][1:25]
topgene_8 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,8])][1:25]
topgene_9 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,9])][1:25]

topgenes<- unique(c(topgene_1, topgene_2,topgene_3, topgene_4, topgene_5, topgene_6, topgene_7, topgene_8, topgene_9))
```

The code above was re ran at 25 genes, 50, 10 genes for each latent variable. Noted below is the total gene and the number of unique genes. 10 genes was not enough genes for signature reversion disease signature (it need to be around 100). 50 genes had a large overlap between genes n= 39. more than 8.5% while 25 was about 6%
#25
```{r}
225-211
```
#50
```{r}
450-411
```

plot heatmap

```{r}
GBM_GTEX_B_MATRIX <- readRDS("~/output/TF_L_GBM/220804_GBM_GTEX_B_MATRIX.rds")
GBM_GTEX_metadata <- readRDS("~/output/TF_L_GBM/GBM_GTEX_metadata.rds")
```
```{r}
GBM_GTEX_B_MATRIX_sig <- GBM_GTEX_B_MATRIX[c(5,11,17,42,43,147,187, 223, 382),]
```


```{r}
column_ha = HeatmapAnnotation(Sample=GBM_GTEX_metadata$status, col = list(Sample = c("Primary Tumor" = "#440154FF", "Solid Tissue Normal" = "#228C8DFF")))
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "black", "yellow"))
#matrix<- t(GBM_GTEX_B_MATRIX_sig)
Heatmap(as.matrix(GBM_GTEX_B_MATRIX_sig), nam= "LV Score",  col = col_fun, show_column_names = FALSE, clustering_distance_rows= "euclidean",
             clustering_distance_columns=  "euclidean",
             clustering_method_rows = "ward.D2" ,
             clustering_method_columns="ward.D2", top_annotation = column_ha, row_names_gp = gpar(fontsize = 9, fontface="bold"))
```





use the shrinkage log fold change from DESeq2 to determine if genes are up or down regulated in disease
```{r eval=FALSE}
lv_genes_deseq_filtered <- deseq_results[deseq_results$Symbol %in% topgenes,]
```

```{r eval=FALSE}
write.csv(lv_genes_deseq_filtered , file= "~/output/TF_L_GBM/220804_lv_genes_deseq_filtered.csv" )
```

```{r eval=FALSE}
upset<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange > 0]
downset<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange < 0 ]
```

```{r eval=FALSE}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```

```{r eval=FALSE}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r eval=FALSE}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval=FALSE}
tfl_gbm_list<- list(up= upset_v2, down= downset_v2)
```

```{r eval=FALSE}
saveRDS(tfl_gbm_list,"~/output/TF_L_GBM/22004_SR_gene_list_gbm_tfl.rds")
```

signature reversion for GBM transfer learning 
```{r eval=FALSE}
set.seed(101)
qsig_lincs_transfer_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```
53/ 53 genes in up set share identifiers with reference database
54 / 54 genes in down set share identifiers with reference database

```{r eval=FALSE}
set.seed(101)
lincs_transfer_gbm <- gess_lincs(qsig_lincs_transfer_res, sortby="NCS", tau=FALSE, workers=1)
#result(lincs)
```


```{r eval=FALSE}
lincs_transfer_gbm_res <- result(lincs_transfer_gbm)
```
brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r eval=FALSE}
lincs_transfer_gbm_res_GI1 <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell == "GI1",]
```

```{r eval=FALSE}
tau_test<- tau_scores(lincs_transfer_gbm_res_GI1, GI1_taudf)
```

```{r eval=FALSE}
lincs_transfer_gbm_res_GI1$jlf_tau<-tau_test
```

filter the results
```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top <- lincs_transfer_gbm_res_GI1[lincs_transfer_gbm_res_GI1$WTCS_FDR <0.05 & lincs_transfer_gbm_res_GI1$NCS <0,]
```

```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top_order <- lincs_transfer_gbm_res_GI1_top[order(-lincs_transfer_gbm_res_GI1_top$NCS),]
lincs_transfer_gbm_res_GI1_top$pert <- factor(lincs_transfer_gbm_res_GI1_top$pert, levels = lincs_transfer_gbm_res_GI1_top_order$pert)
```

plotting the results
```{r eval=FALSE}
p<-ggplot(data=lincs_transfer_gbm_res_GI1_top[1:30,] , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")
```


```{r eval=FALSE}
write.csv(lincs_transfer_gbm_res , file= "~/output/TF_L_GBM/220808_SR_LINCS_GBM_TRL_RES.csv" )
```

-80 is the cut off
```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top_v2 <- lincs_transfer_gbm_res_GI1_top[ abs(lincs_transfer_gbm_res_GI1_top$jlf_tau) > 80,]
```

FDA_APPROVAL_CHECK
```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top$fda_approval <- FDA_APPROVAL_CHECK( as.character(lincs_transfer_gbm_res_GI1_top$pert))
```

```{r eval=FALSE}
clinical_trial_GBM <- read_csv("~/data/SearchResults.csv")
```
clinical_trial_check
```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top$clinical_trial_GBM <- clinical_trial_check(as.character(lincs_transfer_gbm_res_GI1_top$pert), clinical_trial_GBM)
```

```{r eval=FALSE}
write.csv(lincs_transfer_gbm_res_GI1_top, file=  "~/output/TF_L_GBM/220808_SR_LINCS_GBM_top_RES.csv" )
```


```{r eval=FALSE}
lincs_transfer_gbm_res_GI1_top_top_fda<- lincs_transfer_gbm_res_GI1_top[lincs_transfer_gbm_res_GI1_top$fda_approval ,]
lincs_transfer_gbm_res_GI1_top_top_fda<- lincs_transfer_gbm_res_GI1_top_top_fda[lincs_transfer_gbm_res_GI1_top_top_fda$jlf_tau < -80,]

lincs_transfer_gbm_res_GI1_top_order <- lincs_transfer_gbm_res_GI1_top_top_fda[order(-lincs_transfer_gbm_res_GI1_top_top_fda$NCS),]
lincs_transfer_gbm_res_GI1_top_top_fda$pert <- factor(lincs_transfer_gbm_res_GI1_top_top_fda$pert, levels = lincs_transfer_gbm_res_GI1_top_order$pert)
p<-ggplot(data=lincs_transfer_gbm_res_GI1_top_top_fda, aes(x=pert, y=NCS, fill=jlf_tau, shape= clinical_trial_GBM)) +
  geom_bar(stat="identity", color = "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/TF_L_GBM/220808_ggplot_tf_l_tau_gbm_approved_candidates.png")
```

```{r}
knitr::include_graphics("~/output/TF_L_GBM/220808_ggplot_tf_l_tau_gbm_approved_candidates.png")
```

```{r eval=FALSE}
write.csv(lincs_transfer_gbm_res_GI1_top_top_fda, file = "~/output/TF_L_GBM/220808_SR_LINCS_GBM_top_RES_all.csv")
```


```{r eval=FALSE}
hyperG_k_res.2 <- dsea_hyperG(drugs = lincs_transfer_gbm_res_GI1_top_top_fda$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2.2<- result(hyperG_k_res.2)
```

```{r eval=FALSE}
write.csv(hyperG_k_res_v2.2 , file=  "~/output/TF_L_GBM/220808_SR_LINCS_GBM_top_drug_pathway_RES.csv" )
```

```{r eval=FALSE}

#false discovery rate
hyperG_k_res_v2.2$logqvalue<- -log(hyperG_k_res_v2.2$qvalue)

hyperG_k_res_v2.2$Description<- factor(hyperG_k_res_v2.2$Description, levels= hyperG_k_res_v2.2$Description)

gbm.2.2<-ggplot(data=hyperG_k_res_v2.2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity" , color = "black")
gbm.2.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
ggsave("~/output/TF_L_GBM/220808_ggplot_tf_l_tau_gbm_approved_candidates_kegg.png")
```

```{r}
knitr::include_graphics("~/output/TF_L_GBM/220808_ggplot_tf_l_tau_gbm_approved_candidates_kegg.png")
```

look at the brain tumor cell types 
```{r eval=FALSE}
lincs_transfer_gbm_res_brain_tumor <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r eval=FALSE}
lincs_transfer_gbm_res_brain_tumor_top  <- lincs_transfer_gbm_res_brain_tumor[lincs_transfer_gbm_res_brain_tumor$pert %in% lincs_transfer_gbm_res_GI1_top_top_fda$pert,]
```

```{r eval=FALSE}
lincs_transfer_gbm_res_brain_tumor_top$pert <- factor(lincs_transfer_gbm_res_brain_tumor_top$pert, levels = unique(lincs_transfer_gbm_res_GI1_top_top_fda$pert))
```

```{r eval=FALSE}
g.2<-ggplot(data= lincs_transfer_gbm_res_brain_tumor_top, aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g.2 + coord_flip() + scale_color_viridis_d()
```
hard to get an idea if this drug response is common across brain tumor cell lines


PRISM plotting

```{r eval=FALSE}
prism_gbm_cell_lines <- read.csv("~/output/220808_prism_gbm_candidates.csv")
```

```{r eval=FALSE}
primary_gbm_res_sub <-prism_gbm_cell_lines[ prism_gbm_cell_lines$Var2 %in% lincs_transfer_gbm_res_GI1_top_top_fda$pert,]
write.csv(primary_gbm_res_sub , file= "~/output/TF_L_GBM/220808_prism_tfl_candidates_gbm.csv" )
```

```{r eval=FALSE}
#primary_paad_res_sub$Var2 <- factor(primary_paad_res_sub$Var2, levels=unique(primary_paad_res_sub$Var2))
primary_gbm_res_sub$Var2 <- factor(primary_gbm_res_sub$Var2, levels=unique(primary_gbm_res_sub$Var2[order(primary_gbm_res_sub$log_fold_change)]))
ggplot(primary_gbm_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() + geom_point()+ geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/TF_L_GBM/220808_ggplot_TFL_candidates_prism_screen1.png")
```
```{r}
knitr::include_graphics("~/output/TF_L_GBM/220808_ggplot_TFL_candidates_prism_screen1.png")
```

look at the number of sensitive cell lines
```{r eval=FALSE}
drug_list <- as.vector(unique(primary_gbm_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_gbm_res_sub$Sensitive[primary_gbm_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity",  color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/TF_L_GBM/220808_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
knitr::include_graphics("~/output/TF_L_GBM/220808_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```

Determine if the median log fold change is lower than random drug selection. 
```{r eval=FALSE}
tfl_PRISM_test<- PRISM_testing(101,"GI1", lincs_transfer_gbm_res_GI1_top_top_fda$pert, drug_senstive_precentage_all_drugs)
```
```{r eval=FALSE}
tfl_PRISM_test
```

determine if there are more drug from clinical trials than compared to random 
```{r eval=FALSE}
len<- length(lincs_transfer_gbm_res_GI1_top_top_fda$pert)
num_clin <- nrow(lincs_transfer_gbm_res_GI1_top_top_fda[lincs_transfer_gbm_res_GI1_top_top_fda$clinical_trial_GBM == TRUE,])
fract<- num_clin/len
TFL_CT_test_res <- clinical_trial_testing(101, "GI1", len, fract, FDA_CT_table)
```

```{r eval=FALSE}
TFL_CT_test_res 
```


LINCS pathways & Drug targets for all the candidates
```{r eval=FALSE}
for (i in 1:nrow(lincs_transfer_gbm_res_GI1_top_top_fda) ){
  targets<- as.vector(unlist(strsplit(lincs_transfer_gbm_res_GI1_top_top_fda$t_gn_sym[i], "; ")))
  #print(targets)
  drug_analysis( lincs_transfer_gbm_res_GI1_top_top_fda$pert[i], targets, as.data.frame(tpm_df) , metadata$status, deseq_results, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/TF_L_GBM/220808_candidate_plots/")
}
```


### Save Data
done within the script 

### Save Figures
done within the script 
    
# END
    Location of final scripts:
    script 
    
    Location of data produced:
    output
    
    Dates when operations were done:
    220118
    
## Versions
```{r}
sessionInfo()
```

