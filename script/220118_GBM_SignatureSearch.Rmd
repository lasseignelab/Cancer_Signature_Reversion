---
title: "220118_GBM_SignatureSearch"
author: "Jennifer Fisher"
date: "1/18/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    Conduct Signature Reversion on GBM samples with both the DESeq2 approach and the transfer learning approach
    
    Finished psedocode on:
    220118
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker/Singularity: 
    rstudio_tf_dr_v3
    
    Directory of operations: 
    "/home/rstudio"
    
    Scripts being edited for operations:
    One SignatureSearch function needed adjust for new LINCS datbase, and Tau values needed to added
    
    Data being used: 
    GBM gene expression alaysis output and the latent variable output
    
    Papers and tools:
    SignatureSearch. LINCS method for signature reversion 

# STEPS
### Set working directory 
### load in data
```{r}
GBM_GTEX_limma_res <- readRDS("~/output/TF_L_GBM/GBM_GTEX_limma_res.rds")
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
deseq_results <- read.csv("~/output/deseq2_gbm/Deseq2_gbm_normal_gtx_res.csv", sep=",")
```


### Analysis
```{r}
library(signatureSearch)
library(signatureSearchData)
library(HDF5Array)
library(magrittr)
library(dplyr)
library(recount3)
library(ggplot2)
 library(viridis)
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
source("/home/rstudio/script/plier_util.R")
source("/home/rstudio/script/test_LV_differences.R")
```

organize the LINCS data
```{r}
meta42 <- readr::read_tsv("~/data/LINCS_210914_LEVEL3/siginfo_beta.txt")
dose <- "10 uM"
## filter rows by 'pert_type' as compound, 10uM concentration, and 24h treatment time
#meta42_filter <- sig_filter(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```
filter the LINCS data to 10uM and 24 hour treatment and save it 
```{r}
meta42_filter <- sig_filter_JLF(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```

```{r eval =FALSE}
gctx <- "~/data/LINCS_LEVEL5_220118/level5_beta_trt_cp_n720216x12328.gctx"
gctx2h5(gctx, cid=meta42_filter$sig_id, new_cid=meta42_filter$pert_cell_factor,
        h5file="~/data/lincs_2020.h5", by_ncol=5000, overwrite=TRUE)
```

```{r}
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
```
set this path for downstream analysis
```{r}
db_path <- "~/data/lincs_2020.h5"
```

## signature reversion for DESeq2 GBM vs control 
add genes symbols to the DESeq2 output
```{r}
human_projects<- available_projects()
#get a random project data
test<- create_rse(human_projects[(human_projects$project == "SRP118922"),])
gene_info <- test@rowRanges
rm(test)
```
```{r}
dim(as.data.frame(gene_info))
```

```{r}
identical(gene_info$gene_id, rownames(deseq_results))
```

```{r}
deseq_results$Symbol<- gene_info$gene_name
```

identify the top genes
```{r}
deseq_results<- deseq_results[complete.cases(deseq_results),]
deseq_results_sig <- deseq_results[deseq_results$padj < 0.05 & abs(deseq_results$log2FoldChange) > 2,]
```

```{r}
downset<- deseq_results_sig$Symbol[order(deseq_results_sig$log2FoldChange)] [1:700]
upset<- deseq_results_sig$Symbol[order(-deseq_results_sig$log2FoldChange)] [1:700]
```

convert gene symbols to LINCS genes
```{r}
downset_v2 <- match_to_LINCS_genes(upset)
upset_v2 <- match_to_LINCS_genes(downset)
```

```{r}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```

```{r}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r}
deseq_gbm_list<- list(up= upset_v2, down= downset_v2)
```
save gene signature
```{r}
saveRDS(deseq_gbm_list,"~/output/deseq2_gbm/SR_gene_list_gbm_deseq2.rds")
```

signature reversion
```{r}
set.seed(101)
qsig_lincs_deseq2_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```

```{r}
rm(se, recount3_plier_gbm)
gc()
```

```{r}
set.seed(101)
lincs_deseq_gbm <- gess_lincs(qsig_lincs_deseq2_res, sortby="NCS", workers=1)
#result(lincs)
```

```{r}
lincs_deseq_gbm_res <- result(lincs_deseq_gbm)
```
brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r}
write.csv(lincs_deseq_gbm_res, file= "~/output/deseq2_gbm/220427_SR_LINCS_GBM_DESEQ2_RES.csv" )
```

```{r}
lincs_deseq_gbm_res_GI1 <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell == "GI1",]
```

```{r}
GI1_taudf <- readRDS("~/data/GI1_taudf.rds")
```

```{r}
tau_test<- tau_scores(lincs_deseq_gbm_res_GI1, GI1_taudf)
```
Tau (Ï„) that ranges from -100 to +100 

```{r}
lincs_deseq_gbm_res_GI1$jlf_tau<- tau_test
```
```{r}
write.csv(lincs_deseq_gbm_res_GI1, file= "~/output/deseq2_gbm/220427_lincs_deseq_gbm_res_GI1_tau.csv" )
```

```{r}
lincs_deseq_gbm_res_GI1_top <- lincs_deseq_gbm_res_GI1[lincs_deseq_gbm_res_GI1$WTCS_FDR <0.05 & lincs_deseq_gbm_res_GI1$NCS <0,]
```


```{r}
lincs_deseq_gbm_res_GI1_top_order <- lincs_deseq_gbm_res_GI1_top[order(-lincs_deseq_gbm_res_GI1_top$NCS),]
lincs_deseq_gbm_res_GI1_top$pert <- factor(lincs_deseq_gbm_res_GI1_top$pert, levels = lincs_deseq_gbm_res_GI1_top_order$pert)
```


```{r}
p<-ggplot(data=lincs_deseq_gbm_res_GI1_top , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")
```

filter by tau and fda approved

```{r}
lincs_deseq_gbm_res_GI1_top_tau<- lincs_deseq_gbm_res_GI1_top[lincs_deseq_gbm_res_GI1_top$jlf_tau < -80, ]
```

```{r}
lincs_deseq_gbm_res_GI1_top_tau$FDA <-FDA_APPROVAL_CHECK(lincs_deseq_gbm_res_GI1_top_tau$pert)
```

```{r}
FDA_CT_table<- read.csv("~/data/SearchResults.csv")
lincs_deseq_gbm_res_GI1_top_tau$GBM_CT<- clinical_trial_check(lincs_deseq_gbm_res_GI1_top_tau$pert, FDA_CT_table)
```

```{r}
lincs_deseq_gbm_res_GI1_top_candidates<- lincs_deseq_gbm_res_GI1_top_tau[lincs_deseq_gbm_res_GI1_top_tau$FDA == TRUE,]
```


```{r}
p<-ggplot(data=lincs_deseq_gbm_res_GI1_top_candidates , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")

ggsave("~/output/deseq2_gbm/220427_ggplot_deseq2_tau_gbm_candidates.pdf")
```


```{r}
lincs_deseq_gbm_res_brain_tumor <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r}
lincs_deseq_gbm_res_brain_tumor_top <- lincs_deseq_gbm_res_brain_tumor[lincs_deseq_gbm_res_brain_tumor$WTCS_FDR <0.05 & lincs_deseq_gbm_res_brain_tumor$NCS <0,]
```

```{r}
lincs_deseq_gbm_res_brain_tumor_top_order <- lincs_deseq_gbm_res_brain_tumor_top[order(-lincs_deseq_gbm_res_brain_tumor_top$NCS),]
lincs_deseq_gbm_res_brain_tumor_top$pert <- factor(lincs_deseq_gbm_res_brain_tumor_top$pert, levels = unique(lincs_deseq_gbm_res_brain_tumor_top_order$pert))
```


```{r}
g<-ggplot(data=lincs_deseq_gbm_res_brain_tumor_top , aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g + coord_flip()
```

GBM cell line drug target enrichment
```{r}
hyperG_k_res <- dsea_hyperG(drugs = lincs_deseq_gbm_res_GI1_top_candidates$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2, file= "~/output/deseq2_gbm/220427_SR_LINCS_GBM_gbm_cell_drug_pathway_RES.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2$logqvalue<- -log(hyperG_k_res_v2$qvalue)
```

```{r}
hyperG_k_res_v2$Description<- factor(hyperG_k_res_v2$Description, levels= hyperG_k_res_v2$Description)
```

```{r}
gbm.2<-ggplot(data=hyperG_k_res_v2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity") +ylim(0, 8)
gbm.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
ggsave("~/output/deseq2_gbm/220207_ggplot_deseq2_tau_gbm_candidates_kegg_pathways.pdf")
```
drug target enrichment with Go terms
```{r}
hyperG_res_go <- dsea_hyperG(drugs=lincs_deseq_gbm_res_GI1_top$pert, type="GO", ont="ALL")
hyperG_res_go<- result(hyperG_res_go )
```

```{r}
write.csv(hyperG_res_go, file= "~/output/deseq2_gbm/220207_SR_LINCS_GBM_gbm_cell_drug_Go_terms_RES.csv" )
```


## signature reversion for Transfer Learning GBM vs control 

look at the range of the fold change
```{r}
hist(GBM_GTEX_limma_res$limma$logFC)
```
0.2 seems to be a good cut off 

```{r}
GBM_GTEX_limma_res_sig <- GBM_GTEX_limma_res$limma[GBM_GTEX_limma_res$limma$adj.P.Val <0.05 & abs(GBM_GTEX_limma_res$limma$logFC)> 0.2,]
```

```{r}
SIG_LVs <- GBM_GTEX_limma_res_sig$LV
```

```{r}
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
```

```{r}
recount3_plier_gbm$Z[1:5,1:5]
dim(recount3_plier_gbm$Z)
```
5,11,17,42,43,44,147,187, 216, 223 are the signficant latent variables. n= 10

how many genes to use the disease signatures?
```{r}
sig_Z_mt <- recount3_plier_gbm$Z[,c(5,11,17,42,43,44,147,187, 216, 223)]
colnames(sig_Z_mt) <- SIG_LVs
```

see if there is a cutt off
```{r}
p <- c(70,80,90,95,98,100)/100
hist(sig_Z_mt[,1])
quantile(sig_Z_mt[,1], p)
hist(sig_Z_mt[,2])
quantile(sig_Z_mt[,2], p)
hist(sig_Z_mt[,3])
quantile(sig_Z_mt[,3], p)
hist(sig_Z_mt[,4])
quantile(sig_Z_mt[,4], p)
hist(sig_Z_mt[,5])
quantile(sig_Z_mt[,5], p)
hist(sig_Z_mt[,6])
quantile(sig_Z_mt[,6], p)
hist(sig_Z_mt[,7])
quantile(sig_Z_mt[,7],p)
hist(sig_Z_mt[,8])
quantile(sig_Z_mt[,8],p)
hist(sig_Z_mt[,9])
quantile(sig_Z_mt[,9],p)
hist(sig_Z_mt[,10])
quantile(sig_Z_mt[,10],p)
```
no cut off 

look at the top genes. Note that some unique features of this dimension reduction approach are its penalties for 1)  latent variables to reflect annotated pathways such as KEGG and 2) most genes have a zero weight meaning that only a fraction of genes has a high and significant gene weight via the L1 and L2 penalties in the loss function of this algorithm. Also the top genes for the latent variables are unique. 
```{r}
topgene_1 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,1])][1:25]
topgene_2 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,2])][1:25]
topgene_3 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,3])][1:25]
topgene_4 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,4])][1:25]
topgene_5 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,5])][1:25]
topgene_6 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,6])][1:25]
topgene_7 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,7])][1:25]
topgene_8 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,8])][1:25]
topgene_9 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,9])][1:25]
topgene_10 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,10])][1:25]
```

```{r}
topgenes<- unique(c(topgene_1, topgene_2,topgene_3, topgene_4, topgene_5, topgene_6, topgene_7, topgene_8, topgene_9, topgene_10 ))
```

The code above was re ran at 25 genes, 50, 10 genes for each latent variable. Noted below is the total gene and the number of unique genes. 10 genes was not enough genes for signature reversion disease signature (it need to be around 100). 50 genes had a large overlap between genes n= 41. more than 8% while 25 was less than 5 %
#25
```{r}
250-238
```
#50
```{r}
500-459
```
#10
```{r}
100-98
```

use the shrinkage log fold change from DESeq2 to determine if genes are up or down regulated in disease
```{r}
lv_genes_deseq_filtered <- deseq_results[deseq_results$Symbol %in% topgenes,]
```

```{r}
write.csv(lv_genes_deseq_filtered , file= "~/output/TF_L_GBM/220207lv_genes_deseq_filtered.csv" )
```

```{r}
uplist<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange > 0]
downlist<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange < 0 ]
```

```{r}
downset_v2 <- match_to_LINCS_genes(upset)
upset_v2 <- match_to_LINCS_genes(downset)
```

```{r}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r}
tfl_gbm_list<- list(up= upset_v2, down= downset_v2)
```

```{r}
saveRDS(tfl_gbm_list,"~/output/TF_L_GBM/SR_gene_list_gbm_tfl.rds")
```

signature reversion for GBM transfer learning 
```{r}
set.seed(101)
qsig_lincs_transfer_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```

```{r}
set.seed(101)
lincs_transfer_gbm <- gess_lincs(qsig_lincs_transfer_res, sortby="NCS", tau=FALSE, workers=1)
#result(lincs)
```


```{r}
lincs_transfer_gbm_res <- result(lincs_transfer_gbm)
```
brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r}
lincs_transfer_gbm_res_GI1 <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell == "GI1",]
```


```{r}
tau_test<- tau_scores(lincs_transfer_gbm_res_GI1, GI1_taudf)
```

```{r}
lincs_transfer_gbm_res_GI1$jlf_tau<-tau_test
```

filter the results
```{r}
lincs_transfer_gbm_res_GI1_top <- lincs_transfer_gbm_res_GI1[lincs_transfer_gbm_res_GI1$WTCS_FDR <0.05 & lincs_transfer_gbm_res_GI1$NCS <0,]
```
```{r}
lincs_transfer_gbm_res_GI1_top_order <- lincs_transfer_gbm_res_GI1_top[order(-lincs_transfer_gbm_res_GI1_top$NCS),]
lincs_transfer_gbm_res_GI1_top$pert <- factor(lincs_transfer_gbm_res_GI1_top$pert, levels = lincs_transfer_gbm_res_GI1_top_order$pert)
```

plotting the results
```{r}
p<-ggplot(data=lincs_transfer_gbm_res_GI1_top[1:30,] , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")
```

```{r}
ggplot_deseq2_tau_gbm_candidates <- p + coord_flip()  +xlab("LINCS Small Molecules") + ylab("Normalized Connectivity Score") +labs(fill = "Tau [-100,100]")
ggplot_deseq2_tau_gbm_candidates 
ggsave("~/output/TF_L_GBM/220207_ggplot_transfer_tau_gbm_candidates.pdf")
```

```{r}
write.csv(lincs_transfer_gbm_res_GI1_top, file= "~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau.csv" )
```

look at the brain tumor cell types 
```{r}
lincs_transfer_gbm_res_brain_tumor <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top <- lincs_transfer_gbm_res_brain_tumor[lincs_transfer_gbm_res_brain_tumor$WTCS_FDR <0.05 & lincs_transfer_gbm_res_brain_tumor$NCS <0,]
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top_order <- lincs_transfer_gbm_res_brain_tumor_top[order(-lincs_transfer_gbm_res_brain_tumor_top$NCS),]
lincs_transfer_gbm_res_brain_tumor_top$pert <- factor(lincs_transfer_gbm_res_brain_tumor_top$pert, levels = unique(lincs_transfer_gbm_res_brain_tumor_top_order$pert))
```


```{r}
top_drugs<- unique(lincs_transfer_gbm_res_brain_tumor_top$pert[1:40])
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top_v2<- lincs_transfer_gbm_res_brain_tumor_top[lincs_transfer_gbm_res_brain_tumor_top$pert %in% top_drugs,]
```


```{r}
g.2<-ggplot(data= lincs_transfer_gbm_res_brain_tumor_top_v2, aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g.2 + coord_flip()
```


```{r}
write.csv(lincs_transfer_gbm_res , file= "~/output/TF_L_GBM/220127_SR_LINCS_GBM_TRL_RES.csv" )
```

-80 is the cut off
```{r}
lincs_transfer_gbm_res_GI1_top_v2 <- lincs_transfer_gbm_res_GI1_top[ abs(lincs_transfer_gbm_res_GI1_top$jlf_tau) > 80,]
```

GBM cell line drug target enrichment
```{r}
hyperG_k_res <- dsea_hyperG(drugs = lincs_transfer_gbm_res_GI1_top_v2$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2, file= "~/output/TF_L_GBM/220127_SR_LINCS_GBM_gbm_cell_drug_pathway_RES_TAU.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2$logqvalue<- -log(hyperG_k_res_v2$qvalue)
```

```{r}
hyperG_k_res_v2$Description<- factor(hyperG_k_res_v2$Description, levels= hyperG_k_res_v2$Description)
```

```{r}
gbm.2<-ggplot(data=hyperG_k_res_v2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity")
gbm.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
```
```{r}
hyperG_res_go <- dsea_hyperG(drugs=lincs_transfer_gbm_res_GI1_top_v2$pert, type="GO", ont="ALL")
hyperG_res_go<- result(hyperG_res_go )
```

```{r}
write.csv(hyperG_res_go, file= "~/output/TF_L_GBM/220207_SR_LINCS_GBM_gbm_cell_drug_Go_terms_RES.csv" )
```

brain tumors drug target enrichment
```{r}
hyperG_k_res.2 <- dsea_hyperG(drugs = lincs_transfer_gbm_res_brain_tumor_top$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2.2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2.2 , file=  "~/output/TF_L_GBM/220127_SR_LINCS_GBM_brain_cell_drug_pathway_RES.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2.2$logqvalue<- -log(hyperG_k_res_v2.2$qvalue)
```

```{r}
hyperG_k_res_v2.2$Description<- factor(hyperG_k_res_v2.2$Description, levels= hyperG_k_res_v2.2$Description)
```

```{r}
gbm.2.2<-ggplot(data=hyperG_k_res_v2.2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity")
gbm.2.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
```


### Save Data
done within the script 

### Save Figures
done within the script 
    
# END
    Location of final scripts:
    script 
    
    Location of data produced:
    output
    
    Dates when operations were done:
    220118
    
## Versions
```{r}
sessionInfo()
```

