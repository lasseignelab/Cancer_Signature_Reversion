---
title: "220118_GBM_SignatureSearch"
author: "Jennifer Fisher"
date: "1/18/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    Conduct Signature Reversion on GBM samples with both the DESeq2 approach and the transfer learning approach
    
    Finished psedocode on:
    220118
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Directory of operations: 
    "/home/rstudio"
    
    Scripts being edited for operations:
    One SignatureSearch function needed adjust for new LINCS datbase, and Tau values needed to added
    
    Data being used: 
    GBM gene expressionalaysis output and tHE latent variable output
    
    Papers and tools:
    SignatureSearch. lINCS method fro signature reversion 

# STEPS
### Set working directory 
### load in data
```{r}
GBM_GTEX_limma_res <- readRDS("~/output/TF_L_GBM/GBM_GTEX_limma_res.rds")
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
```


```{r}
deseq_results <- read.csv("~/output/deseq2_gbm/Deseq2_gbm_normal_gtx_res.csv", sep=",")
```


### Analysis
```{r}
library(signatureSearch)
```

```{r}
library(signatureSearchData)
```

```{r}

meta42 <- readr::read_tsv("~/data/LINCS_210914_LEVEL3/siginfo_beta.txt")
dose <- "10 uM"
## filter rows by 'pert_type' as compound, 10uM concentration, and 24h treatment time
#meta42_filter <- sig_filter(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```

```{r}
sig_filter_JLF<- function (meta, pert_type = "trt_cp", dose, time = "24 h") {
    meta %<>% dplyr::filter(pert_type == pert_type & pert_idose == 
        dose & pert_itime == time)
    meta %<>% bind_cols(alt_id = paste(meta$cmap_name, meta$cell_iname, 
        sep = "_")) %>% bind_cols(pert_cell_factor = paste(meta$cmap_name, 
        meta$cell_iname, meta$pert_type, sep = "__")) %>% distinct(alt_id, 
        .keep_all = TRUE)
    return(meta)
}
```

```{r}
library(magrittr)
library(dplyr)
meta42_filter <- sig_filter_JLF(meta42, pert_type="trt_cp", dose=dose, time="24 h") 
```


```{r eval =FALSE}
library(signatureSearch)
gctx <- "~/data/LINCS_LEVEL5_220118/level5_beta_trt_cp_n720216x12328.gctx"
gctx2h5(gctx, cid=meta42_filter$sig_id, new_cid=meta42_filter$pert_cell_factor,
        h5file="~/data/lincs_2020.h5", by_ncol=5000, overwrite=TRUE)
```

```{r}
library(signatureSearch)
library(HDF5Array)
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
```


```{r}
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
```

```{r}
db_path <- "~/data/lincs_2020.h5"
```




Genes
```{r}
#SRP118922
library(recount3)
human_projects<- available_projects()
test<- create_rse(human_projects[(human_projects$project == "SRP118922"),])
gene_info <- test@rowRanges
rm(test)
```

```{r}
dim(as.data.frame(gene_info))
```

```{r}
identical(gene_info$gene_id, rownames(deseq_results))
```

```{r}
deseq_results$Symbol<- gene_info$gene_name
```

```{r}
deseq_results<- deseq_results[complete.cases(deseq_results),]
deseq_results_sig <- deseq_results[deseq_results$padj < 0.05 & abs(deseq_results$log2FoldChange) > 2,]
```

```{r}
downset<- deseq_results_sig$Symbol[order(deseq_results_sig$log2FoldChange)] [1:700]
upset<- deseq_results_sig$Symbol[order(-deseq_results_sig$log2FoldChange)] [1:700]
```



```{r}
#upset<-deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange >0]
#downset<- deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange <0]
```
```{r}
gene_info_LINCS<- read.table("~/data/LINCS_210914_LEVEL3/geneinfo_beta.txt", sep="\t", header=TRUE)
```

```{r}
upset_v2<- c()
for (i in 1:length(upset)){
  possibleError <- tryCatch(
      gene_info_LINCS$gene_id[upset[i] == gene_info_LINCS$gene_symbol],
      error=function(e) e
  )
  if(length(possibleError)> 0){
    #REAL WORK
    upset_v2[i]<- gene_info_LINCS$gene_id[upset[i] == gene_info_LINCS$gene_symbol]
  }else{
    upset_v2[i]<- NA
  }
  
}
names(upset_v2)<- upset
```

```{r}
downset_v2<- c()
for (i in 1:length(downset)){
  possibleError <- tryCatch(
      gene_info_LINCS$gene_id[downset[i] == gene_info_LINCS$gene_symbol],
      error=function(e) e
  )
  if(length(possibleError)> 0){
    #REAL WORK
    downset_v2[i]<- gene_info_LINCS$gene_id[downset[i] == gene_info_LINCS$gene_symbol]
  }else{
    downset_v2[i]<- NA
  }
  
}
names(downset_v2)<- downset
```

```{r}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```


```{r}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r}
deseq_gbm_list<- list(up= upset_v2, down= downset_v2)
```

```{r}
saveRDS(deseq_gbm_list,"~/output/deseq2_gbm/SR_gene_list_gbm_deseq2.rds")
```


```{r}
set.seed(101)
qsig_lincs_deseq2_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```

```{r}
rm(se)
gc()
```
```{r}
rm(recount3_plier_gbm)
gc()
```

```{r}
set.seed(101)
lincs_deseq_gbm <- gess_lincs(qsig_lincs_deseq2_res, sortby="NCS", workers=1)
#result(lincs)
```



```{r}
lincs_deseq_gbm_res <- result(lincs_deseq_gbm)
```
brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r}
write.csv(lincs_deseq_gbm_res, file= "~/output/deseq2_gbm/220427_SR_LINCS_GBM_DESEQ2_RES.csv" )
```

```{r}
lincs_deseq_gbm_res_GI1 <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell == "GI1",]
```

```{r}
GI1_taudf <- readRDS("~/data/GI1_taudf.rds")
```


```{r}
tau_scores<- function(results_df, tau_score_df){
  #download the tau values 
  #scores <- readRDS(tau_score_file)
  results_df$id <- paste(results_df$pert, results_df$cell, results_df$type, sep= "__")
  #print(results_df$id)
  tau_list<- c()
  for (i in 1:nrow(results_df)){
    #print( results_df$id[i])
    #print(colnames(tau_score_df) == results_df$id[i])
    index <- grepl(results_df$pert[i], colnames(tau_score_df))
   scores <- tau_score_df[,colnames(tau_score_df) == results_df$id[i]]
   #print(scores)
      tmpsum <- sum( abs(scores) < abs(results_df$NCS[i]))
      secd<- (tmpsum/length(scores)) *100
      tau<- secd* sign( results_df$NCS[i])
      #print(tau)
   tau_list[i]<- tau
  }
  return(tau_list)
}
```

```{r}
tau_test<- tau_scores(lincs_deseq_gbm_res_GI1, GI1_taudf)
```
#Tau (Ï„) that ranges from -100 to +100 

```{r}
lincs_deseq_gbm_res_GI1$jlf_tau<- tau_test
```
```{r}
write.csv(lincs_deseq_gbm_res_GI1, file= "~/output/deseq2_gbm/220427_lincs_deseq_gbm_res_GI1_tau.csv" )
```

```{r}
lincs_deseq_gbm_res_GI1_top <- lincs_deseq_gbm_res_GI1[lincs_deseq_gbm_res_GI1$WTCS_FDR <0.05 & lincs_deseq_gbm_res_GI1$NCS <0,]
```

```{r}
library(ggplot2)
 library(viridis)
```

```{r}
lincs_deseq_gbm_res_GI1_top_order <- lincs_deseq_gbm_res_GI1_top[order(-lincs_deseq_gbm_res_GI1_top$NCS),]
lincs_deseq_gbm_res_GI1_top$pert <- factor(lincs_deseq_gbm_res_GI1_top$pert, levels = lincs_deseq_gbm_res_GI1_top_order$pert)
```


```{r}
p<-ggplot(data=lincs_deseq_gbm_res_GI1_top , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")
```

filter by tau and fda approved

```{r}
lincs_deseq_gbm_res_GI1_top_tau<- lincs_deseq_gbm_res_GI1_top[lincs_deseq_gbm_res_GI1_top$jlf_tau < -80, ]
```



```{r}
fda_info <- read.table("~/data/fda_product_info_df.csv" )
```

```{r}
FDA_CT_table<- read.csv("~/data/SearchResults.csv")
```


```{r}
value <- c()
for (j in 1:32){
    res <- grep(lincs_deseq_gbm_res_GI1_top_tau$pert[j], fda_info$ActiveIngredient, ignore.case=TRUE )
    if ( length(res) >0){
      #print(test[j])
      value[j]<- TRUE
    }else{
      value[j]<- FALSE
    }
    
}
table(value)
lincs_deseq_gbm_res_GI1_top_tau$FDA <-value
```


```{r}
value <- c()
for (j in 1:32){
    res <- grep(lincs_deseq_gbm_res_GI1_top_tau$pert[j], FDA_CT_table$Interventions, ignore.case=TRUE )
    if ( length(res) >0){
      #print(test[j])
      value[j]<- TRUE
    }else{
      value[j]<- FALSE
    }
    
}
table(value)
lincs_deseq_gbm_res_GI1_top_tau$GBM_CT<- value
```

```{r}
lincs_deseq_gbm_res_GI1_top_candidates<- lincs_deseq_gbm_res_GI1_top_tau[lincs_deseq_gbm_res_GI1_top_tau$FDA == TRUE,]
```


```{r}
p<-ggplot(data=lincs_deseq_gbm_res_GI1_top_candidates , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")

ggsave("~/output/deseq2_gbm/220427_ggplot_deseq2_tau_gbm_candidates.pdf")
```


```{r}
lincs_deseq_gbm_res_brain_tumor <- lincs_deseq_gbm_res[lincs_deseq_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r}
lincs_deseq_gbm_res_brain_tumor_top <- lincs_deseq_gbm_res_brain_tumor[lincs_deseq_gbm_res_brain_tumor$WTCS_FDR <0.05 & lincs_deseq_gbm_res_brain_tumor$NCS <0,]
```

```{r}
lincs_deseq_gbm_res_brain_tumor_top_order <- lincs_deseq_gbm_res_brain_tumor_top[order(-lincs_deseq_gbm_res_brain_tumor_top$NCS),]
lincs_deseq_gbm_res_brain_tumor_top$pert <- factor(lincs_deseq_gbm_res_brain_tumor_top$pert, levels = unique(lincs_deseq_gbm_res_brain_tumor_top_order$pert))
```


```{r}
g<-ggplot(data=lincs_deseq_gbm_res_brain_tumor_top , aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g + coord_flip()
```

GBM cell line
```{r}
hyperG_k_res <- dsea_hyperG(drugs = lincs_deseq_gbm_res_GI1_top_candidates$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2, file= "~/output/deseq2_gbm/220427_SR_LINCS_GBM_gbm_cell_drug_pathway_RES.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2$logqvalue<- -log(hyperG_k_res_v2$qvalue)
```

```{r}
hyperG_k_res_v2$Description<- factor(hyperG_k_res_v2$Description, levels= hyperG_k_res_v2$Description)
```

```{r}
gbm.2<-ggplot(data=hyperG_k_res_v2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity") +ylim(0, 8)
gbm.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
ggsave("~/output/deseq2_gbm/220207_ggplot_deseq2_tau_gbm_candidates_kegg_pathways.pdf")
```

```{r}
hyperG_res_go <- dsea_hyperG(drugs=lincs_deseq_gbm_res_GI1_top$pert, type="GO", ont="ALL")
hyperG_res_go<- result(hyperG_res_go )
```

```{r}
write.csv(hyperG_res_go, file= "~/output/deseq2_gbm/220207_SR_LINCS_GBM_gbm_cell_drug_Go_terms_RES.csv" )
```


LVs 

```{r}
GBM_GTEX_limma_res_sig <- GBM_GTEX_limma_res$limma[GBM_GTEX_limma_res$limma$adj.P.Val <0.05 & abs(GBM_GTEX_limma_res$limma$logFC)> 0.2,]
```

```{r}
hist(GBM_GTEX_limma_res$limma$logFC)
```

```{r}
rm("hyperG_k_res_v2" ,  "gene_info" , "hyperG_k_res"   )
```


```{r}
SIG_LVs <- GBM_GTEX_limma_res_sig$LV
```

```{r}
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
```

```{r}
recount3_plier_gbm$Z[1:5,1:5]
dim(recount3_plier_gbm$Z)
```
5,11,17,42,43,44,147,187, 216, 223

```{r}
sig_Z_mt <- recount3_plier_gbm$Z[,c(5,11,17,42,43,44,147,187, 216, 223)]
colnames(sig_Z_mt) <- SIG_LVs
```

```{r}
p <- c(70,80,90,95,98,100)/100
hist(sig_Z_mt[,1])
quantile(sig_Z_mt[,1], p)
hist(sig_Z_mt[,2])
quantile(sig_Z_mt[,2], p)
hist(sig_Z_mt[,3])
quantile(sig_Z_mt[,3], p)
hist(sig_Z_mt[,4])
quantile(sig_Z_mt[,4], p)
hist(sig_Z_mt[,5])
quantile(sig_Z_mt[,5], p)
hist(sig_Z_mt[,6])
quantile(sig_Z_mt[,6], p)
hist(sig_Z_mt[,7])
quantile(sig_Z_mt[,7],p)
hist(sig_Z_mt[,8])
quantile(sig_Z_mt[,8],p)
hist(sig_Z_mt[,9])
quantile(sig_Z_mt[,9],p)
hist(sig_Z_mt[,10])
quantile(sig_Z_mt[,10],p)
```
top 100 
```{r}
topgene_1 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,1])][1:25]
topgene_2 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,2])][1:25]
topgene_3 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,3])][1:25]
topgene_4 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,4])][1:25]
topgene_5 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,5])][1:25]
topgene_6 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,6])][1:25]
topgene_7 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,7])][1:25]
topgene_8 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,8])][1:25]
topgene_9 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,9])][1:25]
topgene_10 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,10])][1:25]
```

```{r}
topgenes<- unique(c(topgene_1, topgene_2,topgene_3, topgene_4, topgene_5, topgene_6, topgene_7, topgene_8, topgene_9, topgene_10 ))
```
#25
```{r}
250-238
```
#50
```{r}
500-459
```
#10
```{r}
100-98
```


```{r}
lv_genes_deseq_filtered <- deseq_results[deseq_results$Symbol %in% topgenes,]
```

```{r}
write.csv(lv_genes_deseq_filtered , file= "~/output/TF_L_GBM/220207lv_genes_deseq_filtered.csv" )
```


```{r}
test<- lv_genes_deseq_filtered[lv_genes_deseq_filtered$padj <0.05,]
```

```{r}
238-183
```

```{r}
test<- lv_genes_deseq_filtered[lv_genes_deseq_filtered$padj <0.05 & abs(lv_genes_deseq_filtered$log2FoldChange) > 2,]
```

```{r}
238-110
```
~54% 

```{r}
uplist<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange > 0]
downlist<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange < 0 ]
```

```{r}
gene_info_LINCS<- read.table("~/data/LINCS_210914_LEVEL3/geneinfo_beta.txt", sep="\t", header=TRUE)
```

```{r}
upset<- uplist
upset_v2<- c()
for (i in 1:length(upset)){
  possibleError <- tryCatch(
      gene_info_LINCS$gene_id[upset[i] == gene_info_LINCS$gene_symbol],
      error=function(e) e
  )
  if(length(possibleError)> 0){
    #REAL WORK
    upset_v2[i]<- gene_info_LINCS$gene_id[upset[i] == gene_info_LINCS$gene_symbol]
  }else{
    upset_v2[i]<- NA
  }
  
}
names(upset_v2)<- upset
```

```{r}
downset<- downlist
downset_v2<- c()
for (i in 1:length(downset)){
  possibleError <- tryCatch(
      gene_info_LINCS$gene_id[downset[i] == gene_info_LINCS$gene_symbol],
      error=function(e) e
  )
  if(length(possibleError)> 0){
    #REAL WORK
    downset_v2[i]<- gene_info_LINCS$gene_id[downset[i] == gene_info_LINCS$gene_symbol]
  }else{
    downset_v2[i]<- NA
  }
  
}
names(downset_v2)<- downset
```

```{r}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r}
tfl_gbm_list<- list(up= upset_v2, down= downset_v2)
```

```{r}
saveRDS(tfl_gbm_list,"~/output/TF_L_GBM/SR_gene_list_gbm_tfl.rds")
```


```{r}
set.seed(101)
qsig_lincs_transfer_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```

```{r}
set.seed(101)
lincs_transfer_gbm <- gess_lincs(qsig_lincs_transfer_res, sortby="NCS", tau=FALSE, workers=1)
#result(lincs)
```


```{r}
lincs_transfer_gbm_res <- result(lincs_transfer_gbm)
```
brain tumor cell lines 
SHSY5Y- neuroblastoma
LN229- astrocytoma
SKNSH- neuroblastoma
U251MG- astrocytoma
YH13- astrocytoma
GI1- glioblastoma

```{r}
lincs_transfer_gbm_res_GI1 <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell == "GI1",]
```


```{r}
tau_test<- tau_scores(lincs_transfer_gbm_res_GI1, GI1_taudf)
```

```{r}
lincs_transfer_gbm_res_GI1$jlf_tau<-tau_test
```


```{r}
lincs_transfer_gbm_res_GI1_top <- lincs_transfer_gbm_res_GI1[lincs_transfer_gbm_res_GI1$WTCS_FDR <0.05 & lincs_transfer_gbm_res_GI1$NCS <0,]
```
```{r}
lincs_transfer_gbm_res_GI1_top_order <- lincs_transfer_gbm_res_GI1_top[order(-lincs_transfer_gbm_res_GI1_top$NCS),]
lincs_transfer_gbm_res_GI1_top$pert <- factor(lincs_transfer_gbm_res_GI1_top$pert, levels = lincs_transfer_gbm_res_GI1_top_order$pert)
```


```{r}
#p.2<-ggplot(data=lincs_transfer_gbm_res_GI1_top[1:30,] , aes(x=pert, y=NCS)) +
 # geom_bar(stat="identity")
#p.2 + coord_flip()
p<-ggplot(data=lincs_transfer_gbm_res_GI1_top[1:30,] , aes(x=pert, y=NCS, fill=jlf_tau)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1)
p + coord_flip()  + xlab("Normalized Connectivity Score") + ylab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]")
```

```{r}
ggplot_deseq2_tau_gbm_candidates <- p + coord_flip()  +xlab("LINCS Small Molecules") + ylab("Normalized Connectivity Score") +labs(fill = "Tau [-100,100]")
ggplot_deseq2_tau_gbm_candidates 
ggsave("~/output/TF_L_GBM/220207_ggplot_transfer_tau_gbm_candidates.pdf")
```

```{r}
write.csv(lincs_transfer_gbm_res_GI1_top, file= "~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau.csv" )
```

```{r}
lincs_transfer_gbm_res_brain_tumor <- lincs_transfer_gbm_res[lincs_transfer_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top <- lincs_transfer_gbm_res_brain_tumor[lincs_transfer_gbm_res_brain_tumor$WTCS_FDR <0.05 & lincs_transfer_gbm_res_brain_tumor$NCS <0,]
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top_order <- lincs_transfer_gbm_res_brain_tumor_top[order(-lincs_transfer_gbm_res_brain_tumor_top$NCS),]
lincs_transfer_gbm_res_brain_tumor_top$pert <- factor(lincs_transfer_gbm_res_brain_tumor_top$pert, levels = unique(lincs_transfer_gbm_res_brain_tumor_top_order$pert))
```


```{r}
top_drugs<- unique(lincs_transfer_gbm_res_brain_tumor_top$pert[1:40])
```

```{r}
lincs_transfer_gbm_res_brain_tumor_top_v2<- lincs_transfer_gbm_res_brain_tumor_top[lincs_transfer_gbm_res_brain_tumor_top$pert %in% top_drugs,]
```


```{r}
g.2<-ggplot(data= lincs_transfer_gbm_res_brain_tumor_top_v2, aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g.2 + coord_flip()
```




```{r}
write.csv(lincs_transfer_gbm_res , file= "~/output/TF_L_GBM/220127_SR_LINCS_GBM_TRL_RES.csv" )
```

-79 is the cut off
```{r}
lincs_transfer_gbm_res_GI1_top_v2 <- lincs_transfer_gbm_res_GI1_top[ abs(lincs_transfer_gbm_res_GI1_top$jlf_tau) > 79,]
```


GBM cell line
```{r}
hyperG_k_res <- dsea_hyperG(drugs = lincs_transfer_gbm_res_GI1_top_v2$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2, file= "~/output/TF_L_GBM/220127_SR_LINCS_GBM_gbm_cell_drug_pathway_RES_TAU.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2$logqvalue<- -log(hyperG_k_res_v2$qvalue)
```

```{r}
hyperG_k_res_v2$Description<- factor(hyperG_k_res_v2$Description, levels= hyperG_k_res_v2$Description)
```

```{r}
gbm.2<-ggplot(data=hyperG_k_res_v2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity")
gbm.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
```
```{r}
hyperG_res_go <- dsea_hyperG(drugs=lincs_transfer_gbm_res_GI1_top_v2$pert, type="GO", ont="ALL")
hyperG_res_go<- result(hyperG_res_go )
```

```{r}
write.csv(hyperG_res_go, file= "~/output/TF_L_GBM/220207_SR_LINCS_GBM_gbm_cell_drug_Go_terms_RES.csv" )
```

brain tumors 
```{r}
hyperG_k_res.2 <- dsea_hyperG(drugs = lincs_transfer_gbm_res_brain_tumor_top$pert, type = "KEGG", 
                            pvalueCutoff = 1, qvalueCutoff = 1, 
                            minGSSize = 10, maxGSSize = 2000)
hyperG_k_res_v2.2<- result(hyperG_k_res)
```

```{r}
write.csv(hyperG_k_res_v2.2 , file=  "~/output/TF_L_GBM/220127_SR_LINCS_GBM_brain_cell_drug_pathway_RES.csv" )
```

```{r}
#false discovery rate
hyperG_k_res_v2.2$logqvalue<- -log(hyperG_k_res_v2.2$qvalue)
```

```{r}
hyperG_k_res_v2.2$Description<- factor(hyperG_k_res_v2.2$Description, levels= hyperG_k_res_v2.2$Description)
```

```{r}
gbm.2.2<-ggplot(data=hyperG_k_res_v2.2[1:30,] , aes(x=Description, y=Count, fill=logqvalue )) +
  geom_bar(stat="identity")
gbm.2.2 + coord_flip() + ylab("Number of Drugs") + xlab("KEGG Pathways") +labs(fill = "-log(q-value)")
```



Compare DESeq genes and Lv genes
```{r}
upset<-deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange >0]
downset<- deseq_results_sig$Symbol[deseq_results_sig$log2FoldChange <0]

uplist_lv<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange > 0]
downlist_lv<- lv_genes_deseq_filtered$Symbol[lv_genes_deseq_filtered$log2FoldChange < 0 ]
```

```{r}
length(setdiff(upset, uplist_lv)) #5080
length(setdiff( uplist_lv,upset)) #68
68/132
```

```{r}
length(setdiff(downset, downlist_lv)) #3221
length(setdiff( downlist_lv,downset)) #60
```

```{r}
length(intersect(upset, uplist_lv))
length(intersect(downset, downlist_lv))
```
```{r}
library(gprofiler2)
```

```{r}
deseq2_upset_pathway_results <- gost(query = upset, 
                organism = "hsapiens", ordered_query = FALSE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
```

```{r}
gostplot(deseq2_upset_pathway_results, capped = TRUE, interactive = TRUE)
```

```{r}
deseq2_downset_pathway_results <- gost(query = downset, 
                organism = "hsapiens", ordered_query = FALSE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
```

```{r}
gostplot(deseq2_downset_pathway_results, capped = TRUE, interactive = TRUE)
```

```{r}
lv_upset_pathway_results <- gost(query = uplist_lv, 
                organism = "hsapiens", ordered_query = FALSE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
```

```{r}
gostplot(lv_upset_pathway_results , capped = TRUE, interactive = TRUE)
```

```{r}
lv_downset_pathway_results <- gost(query = downlist_lv, 
                organism = "hsapiens", ordered_query = FALSE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
```

```{r}
gostplot(lv_downset_pathway_results , capped = TRUE, interactive = TRUE)
```


### Save Data
done within the script 

### Save Figures

    
# END
    Location of final scripts:
    script 
    
    Location of data produced:
    output
    
    Dates when operations were done:
    
    
## Versions
```{r}
sessionInfo()
```

