---
title: "220323_PLIER_LVs"
author: "Jennifer Fisher"
date: "3/23/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    quick summary 
    
    Finished psedocode on: 
    220323
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_leanring_R03
    
    Docker:
    jenfisher7/rstudio_tf_dr_v3
    
    Directory of operations: 
    /home/rstudio/ "Docker"
    
    Scripts being edited for operations: 
    NA
    
    Data being used:
    For this analysis, the human protein-protein interaction (PPI) networks were downloaded from the STRING database (March 2022; version 11.5). This database contains known and predicted protein-protein interactions that include direct and indirect associations.
    Also the limma, deseq2, and transfere leanring results for GBM
    
    Papers and tools: 
    igrpah was used for PPI network analysis. 
    gPROFILER2 was used for pathway analysis.

# STEPS
### Set working directory 
### load in data
```{r}
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
```
### Analysis
```{r}
Z_mtx<- recount3_plier_gbm$Z
```

```{r}
rm(recount3_plier_gbm)
gc()
```

test 3 genes

```{r}
hist(Z_mtx[1,])
hist(Z_mtx[100,])
hist(Z_mtx[1000,])
```
usually low for each these genes. 


histogram of median
```{r}
gene_med_weights <- rowMedians(Z_mtx)
```
```{r}
hist(gene_med_weights)
```

```{r}
gene_avg_weight <- rowMeans(Z_mtx)
```

```{r}
hist(gene_avg_weight)
```

```{r}
gene_max_weight <- rowMax(Z_mtx)
```

```{r}
hist(gene_max_weight)
```
```{r}
hist(Z_mtx)
```


heatmap
```{r}
dim(Z_mtx)
```

```{r}
plot(gene_avg_weight, gene_max_weight)
```
```{r}
plot(gene_avg_weight, gene_med_weights)
```
there are genes that mostlyhave zero weights with an outlier 
interesting that are some genes where is seems like they are similar 

```{r}
gene_diff_test <- gene_avg_weight - gene_med_weights
```

```{r}
hist(gene_diff_test)
```
```{r}
table(gene_diff_test <0.02)
```

```{r}
plot(gene_max_weight, gene_diff_test)
```


```{r}
corr <- gene_diff_test <0.02
```

```{r}
max_plotting<- cbind(gene_avg_weight, corr)
```

```{r}
gene_std_weights <- rowSds(Z_mtx)
```

```{r}
hist(gene_std_weights)
```
```{r}
plot(gene_avg_weight, gene_std_weights)
```

```{r}
plot(gene_med_weights, gene_std_weights)
```


```{r}
library(gplots)
```

```{r}
heatmap.2(Z_mtx)
```
```{r}
gene_sp <- cor(t(Z_mtx), method= "spearman")
```

```{r}
gene_sp_Avg <- rowMeans(gene_sp)
```

```{r}
hist(gene_sp_Avg)
```
no correlation between weights and other genes


```{r}
ppi <- read.delim("~/data/9606.protein.links.v11.5.txt" , sep= " ", header = TRUE)
```

high confidence - 0.7

```{r}
ppi$combined_score<- ppi$combined_score /1000
```

```{r}
ppi$combined_score<- ifelse(ppi$protein1 == ppi$protein2, 1, ppi$combined_score)
```

```{r}
hist(ppi$combined_score)
```
```{r}
ppi_protein_info<- t(as.data.frame( strsplit(readLines("~/data/9606.protein.info.v11.5.txt"), "\t")))
ppi_protein_info <- as.data.frame(ppi_protein_info)
```

```{r}
ppi<- ppi[ppi$combined_score >0.7,]
```


```{r}
protein1_symbols <- c()
protein2_symbols<- c()
for (i in 1:length(ppi$protein1)){
  #print(i)
  protein1_symbols[i]<- ppi_protein_info$V2[ppi$protein1[i] == ppi_protein_info$V1]
  protein2_symbols[i]<-ppi_protein_info$V2[ppi$protein2[i] == ppi_protein_info$V1]
}
scores<- ppi$combined_score
symbol_ppi_table <- cbind(protein1_symbols, protein2_symbols, scores)
```

```{r}
saveRDS(symbol_ppi_table, "~/string_ppi_symbol.rds")
```

```{r}
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
Z_mtx<- recount3_plier_gbm$Z
rm(recount3_plier_gbm)
gc()
```

```{r}
ppi_stringi <- readRDS("~/string_ppi_symbol.rds")
```

```{r}
ppi_stringi_df <- as.data.frame(ppi_stringi)
library(igraph)
g <- graph_from_data_frame(ppi_stringi_df , directed=FALSE)
```

```{r}
string_ppi_degree<- degree(g)
string_ppi_betweenness<- betweenness(g)

```

```{r}
string_ppi_eign_cent <- eigen_centrality(g)
```

```{r}
string_ppi_eign_cent_vector <- string_ppi_eign_cent$vector
```

```{r}
string_ppi_details <-data.frame(degree= string_ppi_degree, betweenness= string_ppi_betweenness, eign_cent= string_ppi_eign_cent_vector)
```

```{r}
plot(string_ppi_details$degree, string_ppi_betweenness)
```
```{r}
plot(string_ppi_details$degree, string_ppi_details$eign_cent)
```

```{r}
plot(string_ppi_details$betweenness, string_ppi_details$eign_cent)
```
```{r eval=False}
saveRDS(string_ppi_details, "~/string_ppi_metrics.rds")
```

```{r}
#compare all the lvs GENE list 

#5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100
top_genes_num <- seq(from=2 , to= 100, by=2)
fraction <- c()
for (i in 1:length(top_genes_num)){
  gene_list<- c()
  num<- top_genes_num[i]
  for (j in 1:ncol(Z_mtx)) {
    topgene<- rownames(Z_mtx)[order(-Z_mtx[,j])][1:num]
    gene_list <- c(gene_list, topgene)
  }
  top <- length(unique(gene_list))
  bottom<- num *ncol(Z_mtx)
  fraction[i]<- top/bottom
}
```

```{r}
plot(top_genes_num, fraction)
```



```{r}
lv_topgene_data<- data.frame(Number= top_genes_num, Unique_fraction =fraction)
```

```{r}
library(ggplot2)
ggplot(lv_topgene_data, aes(x= Number, y= Unique_fraction))+geom_point()+theme_classic()+ geom_line(aes(y=0.80))+ geom_line(aes(x=10))
```


```{r}

  gene_list<- c()
  num<- top_genes_num[i]
  for (j in 1:ncol(Z_mtx)) {
    topgene<- rownames(Z_mtx)[order(-Z_mtx[,j])][1:10]
    gene_list <- c(gene_list, topgene)
  }
```

```{r}
length(gene_list)
```


```{r}
library(dplyr)

string_ppi_details$top_10_weights <- rownames(string_ppi_details) %in% gene_list
```

```{r}
library(ggplot2)
```


```{r}
ggplot(string_ppi_details, aes(x=top_10_weights, y=degree, fill=top_10_weights )) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Degree",x="Top 10 Weight?", y = "PPI Degree", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$degree_log<- log(string_ppi_details$degree)
```

```{r}
ggplot(string_ppi_details, aes(x=top_10_weights, y=degree_log, fill=top_10_weights )) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Degree",x="Top 10 Weight?", y = "PPI log(Degree)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```
```{r}
plot(string_ppi_details$degree, string_ppi_details$degree_log)
```


```{r}
ggplot(string_ppi_details, aes(x=top_10_weights, y=betweenness, fill=top_10_weights)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Betweeness",x="Top 10 Weight?", y = "PPI Betweeness", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$log_betweness <- log(string_ppi_details$betweenness)
ggplot(string_ppi_details, aes(x=top_10_weights, y=log_betweness , fill=top_10_weights)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Betweeness",x="Top 10 Weight?", y = "PPI log(Betweeness)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```
```{r}
plot(string_ppi_details$betweenness, string_ppi_details$log_betweness)
```

```{r}
ggplot(string_ppi_details, aes(x=top_10_weights, y=eign_cent, fill=top_10_weights)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Eigenvector Centrality Scores",x="Top 10 Weight?", y = "PPI Eigenvector Centrality Scores", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$eign_cent_log <- log(string_ppi_details$eign_cent)
ggplot(string_ppi_details, aes(x=top_10_weights, y=eign_cent_log, fill=top_10_weights)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Eigenvector Centrality Scores",x="Top 10 Weight?", y = "PPI log(Eigenvector Centrality Scores)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```
```{r}
plot(string_ppi_details$eign_cent, string_ppi_details$eign_cent_log)
```


```{r}
#
string_ppi_details_true <- string_ppi_details[string_ppi_details$top_10_weights == TRUE,]
string_ppi_details_false <- string_ppi_details[string_ppi_details$top_10_weights == FALSE,]

```

```{r}
test1 <- wilcox.test(string_ppi_details_true$degree, string_ppi_details_false$degree)
```

```{r}
p.adjust(test1$p.value, method= "bonferroni", n= 3)
```


```{r}
test2<- wilcox.test(string_ppi_details_true$betweenness, string_ppi_details_false$betweenness)
```

```{r}
p.adjust(test2$p.value, method= "bonferroni", n= 3)
```


```{r}
test3<- wilcox.test(string_ppi_details_true$eign_cent, string_ppi_details_false$eign_cent)
```

```{r}
p.adjust(test3$p.value, method= "bonferroni", n= 3)
```

```{r}
dim(string_ppi_details)
```



now deseq2 vs transfer leanring genes
three groups?
Kruskal-Wallis one-way ANOVA??

downlaod the gene list from plier

5,11,17,42,43,44,147,187, 216, 223

```{r}
GBM_GTEX_limma_res <- readRDS("~/output/TF_L_GBM/GBM_GTEX_limma_res.rds")
```

```{r}
GBM_GTEX_limma_res_sig <- GBM_GTEX_limma_res$limma[GBM_GTEX_limma_res$limma$adj.P.Val <0.05 & abs(GBM_GTEX_limma_res$limma$logFC)> 0.2,]
SIG_LVs<- GBM_GTEX_limma_res_sig$LV
```


```{r}
sig_Z_mt <- Z_mtx[,c(5,11,17,42,43,44,147,187, 216, 223)]
colnames(sig_Z_mt) <- SIG_LVs
```
top 100 
```{r}
topgene_1 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,1])][1:25]
topgene_2 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,2])][1:25]
topgene_3 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,3])][1:25]
topgene_4 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,4])][1:25]
topgene_5 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,5])][1:25]
topgene_6 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,6])][1:25]
topgene_7 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,7])][1:25]
topgene_8 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,8])][1:25]
topgene_9 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,9])][1:25]
topgene_10 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,10])][1:25]
```

```{r}
topgenes<- unique(c(topgene_1, topgene_2,topgene_3, topgene_4, topgene_5, topgene_6, topgene_7, topgene_8, topgene_9, topgene_10 ))
```

```{r}
deseq_results <- read.csv("~/output/deseq2_gbm/Deseq2_gbm_normal_gtx_res.csv", sep=",")
```

Genes
```{r}
#SRP118922
library(recount3)
human_projects<- available_projects()
test<- create_rse(human_projects[(human_projects$project == "SRP118922"),])
gene_info <- test@rowRanges
rm(test)
```

```{r}
deseq_results$Symbol<- gene_info$gene_name
```

```{r}
deseq_results<- deseq_results[complete.cases(deseq_results),]
deseq_results_sig <- deseq_results[deseq_results$padj < 0.05 & abs(deseq_results$log2FoldChange) > 2,]
```

```{r}
deseq2_genes <- deseq_results_sig$Symbol
```

remove genes not in latent variables 
```{r}
deseq2_genes_v2 <- deseq2_genes[deseq2_genes %in% rownames(Z_mtx)]
```

```{r}
both_genes<- deseq2_genes_v2[deseq2_genes_v2 %in% topgenes]
```

```{r}
deseq2_genes_f<- deseq2_genes_v2[! deseq2_genes_v2 %in% both_genes]
transfer_learning_f <- topgenes[! topgenes %in% both_genes]
```

```{r}
string_ppi_details$gbm_example <- ifelse(rownames(string_ppi_details) %in% deseq2_genes_f, "DESeq2", ifelse(rownames(string_ppi_details) %in% both_genes, "Both", ifelse(rownames(string_ppi_details)%in% transfer_learning_f, "Transfer Learning", "NA")) )
```



```{r}
table(string_ppi_details$gbm_example)
```


```{r}
ggplot(string_ppi_details, aes(x=gbm_example, y=degree_log, fill=gbm_example )) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Degree",x="Sig?", y = "PPI log(Degree)", color= "Top 10 Weight?") + scale_colour_manual(values = c("#440154FF", "#31688EFF", "#35B779FF" ,"#FDE725FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$log_betweness <- log(string_ppi_details$betweenness)
ggplot(string_ppi_details, aes(x=gbm_example, y=log_betweness , fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Betweeness",x="Sig?", y = "PPI log(Betweeness)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF", "#31688EFF", "#35B779FF" ,"#FDE725FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$eign_cent_log <- log(string_ppi_details$eign_cent)
ggplot(string_ppi_details, aes(x=gbm_example, y=eign_cent_log, fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Eigenvector Centrality Scores",x="Sig?", y = "PPI log(Eigenvector Centrality Scores)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF", "#31688EFF", "#35B779FF" ,"#FDE725FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
kruskal.test(degree ~ gbm_example, data = string_ppi_details)
```

```{r}
pairwise.wilcox.test(string_ppi_details$degree, string_ppi_details$gbm_example,
                 p.adjust.method = "bonferroni")
```

```{r}
kruskal.test(betweenness~ gbm_example, data = string_ppi_details)
```

```{r}
pairwise.wilcox.test(string_ppi_details$betweenness, string_ppi_details$gbm_example,
                 p.adjust.method = "bonferroni")
```

```{r}
kruskal.test(eign_cent~ gbm_example, data = string_ppi_details)
```

```{r}
pairwise.wilcox.test(string_ppi_details$eign_cent, string_ppi_details$gbm_example,
                 p.adjust.method = "bonferroni")
```


```{r}
string_ppi_details_v2 <- string_ppi_details[!string_ppi_details$gbm_example == "NA",]
```

```{r}
ggplot(string_ppi_details_v2, aes(x=gbm_example, y=degree_log, fill=gbm_example )) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Degree",x="Sig?", y = "PPI log(Degree)", color= "Top 10 Weight?") + scale_colour_manual(values = c("#440154FF", "#31688EFF", "#35B779FF" ), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
#string_ppi_details$log_betweness <- log(string_ppi_details$betweenness)
ggplot(string_ppi_details_v2, aes(x=gbm_example, y=log_betweness , fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Betweeness",x="Sig?", y = "PPI log(Betweeness)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF", "#31688EFF", "#35B779FF" ), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$eign_cent_log <- log(string_ppi_details$eign_cent)
ggplot(string_ppi_details_v2, aes(x=gbm_example, y=eign_cent_log, fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Eigenvector Centrality Scores",x="Sig?", y = "PPI log(Eigenvector Centrality Scores)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF", "#31688EFF", "#35B779FF" ), aesthetics = c("colour", "fill"))+ theme_minimal()
```




```{r}
string_ppi_details_v3 <- string_ppi_details[string_ppi_details$gbm_example == "Both",]
```

```{r}
string_ppi_details_v3$gbm_example <- rep("DESeq2", 108)
string_ppi_details_v4<- string_ppi_details_v3
string_ppi_details_v4$gbm_example<- rep("Transfer Learning", 108)
```

```{r}
string_ppi_details_v5 <- rbind(string_ppi_details_v2, string_ppi_details_v3, string_ppi_details_v4)
string_ppi_details_v5<- string_ppi_details_v5[!string_ppi_details_v5$gbm_example == "Both",]
```

```{r}
ggplot(string_ppi_details_v5, aes(x=gbm_example, y=degree_log, fill=gbm_example )) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Degree",x="Sig?", y = "PPI log(Degree)", color= "Top 10 Weight?") + scale_colour_manual(values = c("#440154FF","#228C8DFF" ), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
#string_ppi_details$log_betweness <- log(string_ppi_details$betweenness)
ggplot(string_ppi_details_v5, aes(x=gbm_example, y=log_betweness , fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Betweeness",x="Sig?", y = "PPI log(Betweeness)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF" ), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$eign_cent_log <- log(string_ppi_details$eign_cent)
ggplot(string_ppi_details_v5, aes(x=gbm_example, y=eign_cent_log, fill=gbm_example)) + 
  geom_violin()+ geom_point() +labs(title="LV PPI Eigenvector Centrality Scores",x="Sig?", y = "PPI log(Eigenvector Centrality Scores)", color= "Top 10 Weight?") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```






add the limma gene set list 

```{r}
GBM_GTEX_gene_limma_res <- readRDS("~/output/limma_gbm/220421_GBM_GTEX_gene_limma_res.rds")
```


```{r}
GBM_gene_limma_sig<- GBM_GTEX_gene_limma_res$limma[abs(GBM_GTEX_gene_limma_res$limma$logFC) > 2 & GBM_GTEX_gene_limma_res$limma$adj.P.Val < 0.05,]
```
filter to genes only in latent varaibles 

GBM_gene_limma_sig
```{r}
limma_genes_v2 <- GBM_gene_limma_sig$LV[GBM_gene_limma_sig$LV %in% rownames(Z_mtx)]
```


compare gene list across different methods

```{r}
library(VennDiagram)
```
```{r}
# Prepare a palette of 3 colors with R colorbrewer:
myCol <- c("#440154FF" , "#31688EFF" ,"#35B779FF")
```

```{r}
venn.diagram(
        x = list(limma_genes_v2, deseq2_genes_v2, topgenes),
        category.names = c("limma" , "DESeq2" , "Transfer Learning"),
        filename = '~/output/gene_gbm_venn_diagramm.png',
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 480 , 
        width = 480 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .4,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.3,
        cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
)
```


pathway analysis for each unique gene set
```{r}
un_tf_genes <- setdiff(topgenes, c(limma_genes_v2, deseq2_genes_v2))
```

```{r}
deseq_results<- deseq_results[complete.cases(deseq_results),]
up_genes<- deseq_results$Symbol[deseq_results$log2FoldChange >0]
down_genes<- deseq_results$Symbol[deseq_results$log2FoldChange <0]
```


```{r}
pathway_geneset_analysis<- function(geneset , method ){
  #get up down gene set 
  up <- geneset[geneset %in% up_genes]
  #print(up)
  down <- geneset[geneset %in% down_genes]
 downset_pathway_results <- gost(query = down, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = rownames(Z_mtx), 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  downset_pathway_results<- downset_pathway_results$result
  
  upset_pathway_results <- gost(query = up, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = rownames(Z_mtx), 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  upset_pathway_results<- upset_pathway_results$result
  
  pathway_results<- rbind(upset_pathway_results, downset_pathway_results)
  pathway_results$set<- c(rep("Up", nrow(upset_pathway_results)), rep("Down", nrow(downset_pathway_results)))
  file_name<- paste0("~/output/gbm_",  method, "_gene_pathways.csv")
  write.csv2(as.data.frame(pathway_results[,-14]), file_name )
  
  file_name<- paste0("~/output/gbm_", method, "_gene_pathways.png")
  if(nrow(pathway_results)<50){
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value))+geom_tile()+scale_fill_viridis(direction=-1)+theme_classic()+ labs(title=name,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
    
  }else{
    pathway_results<- pathway_results[pathway_results$source %in% c("KEGG","REAC","GO:MF" ),]
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value)) + geom_tile()+ scale_fill_viridis(direction=-1)+ theme_classic() + labs(title=method,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
  }
  ggsave(file_name, width = 12, height = 14)
}
```

note due to the overlapping of genes between the different methods. A direct statistical test can not be done due to the independence assumption. 

pathways analysi of genes from limma and DESEQ2
```{r}
library(gprofiler2)
#no signifcant pathways
#pathway_geneset_analysis(un_tf_genes, "transfer_learning")
```

```{r}
pathway_geneset_analysis(limma_genes_v2, "limma")
```

```{r}
pathway_geneset_analysis(deseq2_genes_v2, "DESeq2")
```


```{r}
lima_ppi <- string_ppi_details[rownames(string_ppi_details) %in% limma_genes_v2,]
deseq2_ppi <- string_ppi_details[rownames(string_ppi_details) %in% deseq2_genes_v2,]
transfer_ppi <- string_ppi_details[rownames(string_ppi_details) %in% topgenes,]
ppi_details_sig_3_methods <- rbind(lima_ppi ,deseq2_ppi , transfer_ppi)
ppi_details_sig_3_methods$method <- c(rep("limma", nrow(lima_ppi)), rep("DESeq2", nrow(deseq2_ppi)), rep("Transfer Learning", nrow(transfer_ppi)))
```

```{r}
ggplot(ppi_details_sig_3_methods, aes(x=method , y=degree_log, fill=method )) + 
  geom_violin()+ geom_point() +labs(title="PPI Degree",x="Signficant Genes in Method", y = "PPI log(Degree)", color= "Method") + scale_colour_manual(values = c("#440154FF" , "#31688EFF" ,"#35B779FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
#string_ppi_details$log_betweness <- log(string_ppi_details$betweenness)
ggplot(ppi_details_sig_3_methods, aes(x=method, y=log_betweness , fill=method)) + 
  geom_violin()+ geom_point() +labs(title="PPI Betweeness",x="Signficant Genes in Method", y = "PPI log(Betweeness)", color= "Method") + scale_colour_manual(values =  c("#440154FF" , "#31688EFF" ,"#35B779FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```

```{r}
string_ppi_details$eign_cent_log <- log(string_ppi_details$eign_cent)
ggplot(ppi_details_sig_3_methods, aes(x=method, y=eign_cent_log, fill=method)) + 
  geom_violin()+ geom_point() +labs(title="PPI Eigenvector Centrality Scores",x="Signficant Genes in Method", y = "PPI log(Eigenvector Centrality Scores)", color= "Method") + scale_colour_manual(values =  c("#440154FF" , "#31688EFF" ,"#35B779FF"), aesthetics = c("colour", "fill"))+ theme_minimal()
```


To compare the different centrality metrics for the GBM output genes from limma, deseq2, and the transfer learning approach. For each method, I randomly selected the same number of genes and calculated the median of each of the three log2 transformed centrality metrics. This was done 100,000 times. A one-way t-test was conducted to determine if the genes determined if one of the methods had a higher median of the centrality metrics than by chance. We used this approach over a comparison of one method vs another via Wilcox test and ANOVA due to the assumption of independence because of the overlap of genes between methods. 


```{r}
network_metric_anaylsis<- function(geneset, method){
  #calculate the median for each metric for method
  degree_med <- median(string_ppi_details$degree_log[ rownames(string_ppi_details) %in% geneset ])
  print(degree_med)
  betweenness_med <- median(string_ppi_details$log_betweness[ rownames(string_ppi_details) %in% geneset ])
  print(betweenness_med)
  eign_cent_med <- median(string_ppi_details$eign_cent_log[ rownames(string_ppi_details) %in% geneset ])
  print(eign_cent_med)
  
  random_degree_med <- c()
  random_betweenness_med<- c()
  random_eign_cent_med<- c() 
  
  for( i in 1:100000){
    sub_genes <- rownames(Z_mtx)[sample(1:nrow(Z_mtx), length(geneset))]
    sub_ppi <- string_ppi_details[rownames(string_ppi_details) %in% sub_genes,]
    random_degree_med[i] <- median(sub_ppi$degree_log)
    random_betweenness_med[i] <- median(sub_ppi$log_betweness)
    random_eign_cent_med[i] <- median(sub_ppi$eign_cent_log)
  }
  #print(hist(random_degree_med))
  #print("wilcox degree")
  #print(random_degree_med[1:5])
  print(t.test(random_degree_med,mu= degree_med, alternative = "less" ))
   
  #print(hist(random_betweenness_med))
 # print("wilcox betweenness")
  print(t.test(random_betweenness_med,mu=betweenness_med, alternative = "less" ))
  
  #print(hist(random_eign_cent_med))
  #print("wilcox betweenness")
  print(t.test(random_eign_cent_med, mu=eign_cent_med, alternative ="less"))
  
  #degree
  
    #Print plot   
  
  #betweeness 
  
    #Print plot
  
  #eignvector 
    #print plot 
  
  
}
```

```{r}
network_metric_anaylsis(topgenes)
```

```{r}
network_metric_anaylsis(limma_genes_v2)
```

```{r}
network_metric_anaylsis(deseq2_genes_v2)
```


download the gene list from deseq2 

interesction between 

remove from the different list 


comments, comments

### Save Data
### Save Figures
    
# END
    Location of final scripts:
    scripts
    
    Location of data produced:
    output
    
    Dates when operations were done:
    220323-220426
    
## Versions
```{r}
sessionInfo()
```

