---
title: "220405_limma_GBM"
author: "Jennifer Fisher"
date: "4/5/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    Apply limma differential gene expression analysis to GBM and GTEx controls to identify genes that differential expressed between tumor and control gene expression profiles. The differential expressed gene were used to signature reversion. 
    
    Finished psedocode on: 
    220405
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker/Singularity: 
    rstudio_cancer_dr
    
    Directory of operations:
    "/home/rstudio"
    
    Scripts being edited for operations:
    using some modified scripts from MultiPLIER paper
    
    Data being used: 
    TCGA GBM data and GTEx Brain samples
    
    Papers and tools: 
    limma 
    MultiPLIER

# STEPS
### Set working directory 
### load in data
```{r}
library(recount3)
library(SummarizedExperiment)
library(dplyr)
library(signatureSearch)
library(signatureSearchData)
library(HDF5Array)
library(magrittr)
library(dplyr)
library(recount3)
library(ggplot2)
 library(viridis)
library(tidyr)
library(ggpubr)
library(gprofiler2)
```
load in function scripts 
```{r}
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
source("/home/rstudio/script/plier_util.R")
source("/home/rstudio/script/test_LV_differences.R")
```

```{r}
all_metadata<- readRDS("~/data/recount3_GBM_GTEx_BRAIN_metadata.rds")
```

normalize count data by tpm

```{r}
feature_info <- readRDS("~/data/recount3/recount3_fix_download/feature_info.rds")
tpm_table<- readRDS("~/output/recount3_gbm_gtex_tpm_df.rds")
```

```{r}
tpm_df <- as.data.frame(tpm_table)
```

### Analysis

## limma analysis 

transfrom TPM for limma differential gene expression
```{r}
TPM <- log2(as.matrix(tpm_df) + 1)
```

                          
```{r eval= FALSE}
#adjust metadata for the function
sampleinfo<- cbind(colnames(tpm_df), as.character(all_metadata$status), as.character(all_metadata$database))
colnames(sampleinfo) <- c("Sample", "Tumor","database")
sampleinfo<- as.data.frame(sampleinfo)
database<- all_metadata$database
names(database)<- colnames(tpm_df)
```

```{r eval= FALSE}
limma_gene_TCGA_BH <- LVTestWrapperJLF_v2(b.matrix=TPM , sample.info.df= sampleinfo, phenotype.col= "Tumor", blocking= database, file.lead= "220421_limma_TCGA_GTEX_T_vs_NT", plot.dir= "~/output/limma_gbm/", results.dir= "~/output/limma_gbm/", use.bonferroni= FALSE, sig.threshold = 0.05)
```


```{r eval=FALSE}
saveRDS(limma_gene_TCGA_BH , file= "~/output/limma_gbm/220421_GBM_GTEX_gene_limma_res.rds")
```




## signaturesearch 
get the limma results
```{r eval= FALSE}
GBM_GTEX_gene_limma_res <- readRDS("~/output/limma_gbm/220421_GBM_GTEX_gene_limma_res.rds")
```

get LINCS 2020 Level 5 data
```{r}
library(signatureSearch)
library(HDF5Array)
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
```

```{r eval= FALSE}
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
db_path <- "~/data/lincs_2020.h5"
```

```{r eval= FALSE}
limma_results<- GBM_GTEX_gene_limma_res$limma
```

get the top up and down regulated genes; use the top ~100 from the up and down regulated genes
```{r eval= FALSE}
limma_results<- limma_results[complete.cases(limma_results),]
limma_results_sig <- limma_results[limma_results$adj.P.Val < 0.05 & abs(limma_results$logFC) > 2,]
```

```{r eval= FALSE}
upset<-limma_results_sig$LV[order(-limma_results_sig$logFC)]
downset<- limma_results_sig$LV[order(limma_results_sig$logFC)]
upset<- upset[1:200]
downset<- downset[1:200]
```
convert gene symbols to LINCS genes
```{r eval= FALSE}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```

```{r eval= FALSE}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r eval= FALSE}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval= FALSE}
limma_gbm_list<- list(up= upset_v2, down= downset_v2)
```
save the input gene signature. 
```{r eval= FALSE}
saveRDS(limma_gbm_list,"~/output/limma_gbm/SR_gene_list_gbm_limma.rds")
```

run signature reversion for limma GBM vs Control
```{r eval= FALSE}
set.seed(101)
qsig_lincs_limma_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```

```{r eval= FALSE}
set.seed(101)
lincs_limma_gbm <- gess_lincs(qsig_lincs_limma_res, sortby="NCS", workers=1)
#result(lincs)
```

```{r eval= FALSE}
lincs_limma_gbm_res <- result(lincs_limma_gbm)
```
```{r eval= FALSE}
write.csv(lincs_limma_gbm_res , file= "~/output/limma_gbm/220421_SR_LINCS_GBM_LIMMA_RES.csv" )
```


tau calc 

```{r eval= FALSE}
lincs_limma_gbm_res_GI1 <- lincs_limma_gbm_res[lincs_limma_gbm_res$cell == "GI1",]
```

```{r eval= FALSE}
GI1_taudf <- readRDS("~/data/GI1_taudf.rds")
```

```{r eval= FALSE}
tau_test<- tau_scores(lincs_limma_gbm_res_GI1, GI1_taudf)
```

```{r eval= FALSE}
lincs_limma_gbm_res_GI1$jlf_tau<-tau_test
```

```{r eval= FALSE}
limma_sig_drugs <- lincs_limma_gbm_res_GI1[lincs_limma_gbm_res_GI1$WTCS_Pval <0.05 & lincs_limma_gbm_res_GI1$NCS <0 & as.numeric(lincs_limma_gbm_res_GI1$jlf_tau) < -80, ] 
```

drug analysis

```{r eval= FALSE}
#FDA_APPROVAL_CHECK
limma_sig_drugs$fda_database<- FDA_APPROVAL_CHECK(limma_sig_drugs$pert)
```

```{r eval= FALSE}
limma_sig_drugs_fda <-limma_sig_drugs[ limma_sig_drugs$fda_database == TRUE,]
```


```{r eval= FALSE}
FDA_CT_table<- read.csv("~/data/SearchResults.csv")
limma_sig_drugs_fda$GBM_CT<- clinical_trial_check(as.character(limma_sig_drugs_fda$pert), FDA_CT_table)
```


```{r eval= FALSE}
limma_sig_drugs_fda_order <- limma_sig_drugs_fda[order(-limma_sig_drugs_fda$NCS),]
limma_sig_drugs_fda$pert <- factor(limma_sig_drugs_fda$pert, levels = limma_sig_drugs_fda_order$pert)
```


```{r eval= FALSE}
p<-ggplot(data=limma_sig_drugs_fda , aes(x=pert, y=NCS, fill=jlf_tau, shape= GBM_CT)) +
  geom_bar(stat="identity", color= "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")
ggsave("~/output/limma_gbm/2200421_ggplot_limma_tau_gbm_approved_candidates.png")
```
```{r}
knitr::include_graphics("~/output/limma_gbm/2200421_ggplot_limma_tau_gbm_approved_candidates.png")
```


```{r eval= FALSE}
write.csv(limma_sig_drugs_fda , file = "~/output/limma_GBM/220808_SR_LINCS_GBM_top_RES_all.csv")
```


look at the brain tumor cell types 
```{r eval= FALSE}
lincs_limma_gbm_res_brain_tumor <- lincs_limma_gbm_res[lincs_limma_gbm_res$cell %in% c("GI1","SHSY5Y", "LN229","SKNSH", "U251MG","YH13")   ,]
```

```{r eval= FALSE}
lincs_limma_gbm_res_brain_tumor_top  <- lincs_limma_gbm_res_brain_tumor[lincs_limma_gbm_res_brain_tumor$pert %in% limma_sig_drugs_fda$pert,]
```

```{r eval= FALSE}
lincs_limma_gbm_res_brain_tumor_top$pert <- factor(lincs_limma_gbm_res_brain_tumor_top$pert, levels = unique(lincs_limma_gbm_res_brain_tumor_top$pert))
```

```{r eval= FALSE}
g.2<-ggplot(data= lincs_limma_gbm_res_brain_tumor_top , aes(x=pert, y=NCS, color=cell)) +
  geom_point(stat="identity", size = 3)
g.2 + coord_flip() + scale_color_viridis_d()
```
hard to get an idea if this drug response is common across brain tumor cell lines


PRISM plotting

```{r eval= FALSE}
prism_gbm_cell_lines <- read.csv("~/output/220808_prism_gbm_candidates.csv")
```

```{r eval= FALSE}
primary_gbm_res_sub <-prism_gbm_cell_lines[ prism_gbm_cell_lines$Var2 %in% limma_sig_drugs_fda$pert,]
write.csv(primary_gbm_res_sub , file= "~/output/limma_gbm/220808_prism_limma_candidates_gbm.csv" )
```

```{r eval= FALSE}
#primary_paad_res_sub$Var2 <- factor(primary_paad_res_sub$Var2, levels=unique(primary_paad_res_sub$Var2))
primary_gbm_res_sub$Var2 <- factor(primary_gbm_res_sub$Var2, levels=unique(primary_gbm_res_sub$Var2[order(primary_gbm_res_sub$log_fold_change)]))
ggplot(primary_gbm_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() + geom_point()+ geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/limma_gbm/220808_ggplot_limma_candidates_prism_screen1.png")
```

```{r}
knitr::include_graphics("~/output/limma_gbm/220808_ggplot_limma_candidates_prism_screen1.png")
```

look at the number of sensitive cell lines
```{r eval= FALSE}
drug_list <- as.vector(unique(primary_gbm_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_gbm_res_sub$Sensitive[primary_gbm_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity",  color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/limma_gbm/220808_ggplot_limma_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
knitr::include_graphics("~/output/limma_gbm/220808_ggplot_limma_candidates_prism_screen1_sensitive_cell_lines.png")
```

Determine if the median log fold change is lower than random drug selection. 
```{r eval= FALSE}
limma_PRISM_test<- PRISM_testing(101,"GI1", limma_sig_drugs_fda$pert, drug_senstive_precentage_all_drugs)
```
```{r eval= FALSE}
limma_PRISM_test
```

	Wilcoxon signed rank test with continuity correction

data:  fraction

V = 10392308, p-value < 2.2e-16

alternative hypothesis: true location is less than 0.875

determine if there are more drug from clinical trials than compared to random 
```{r eval= FALSE}
len<- length(limma_sig_drugs_fda$pert)
num_clin <- nrow(limma_sig_drugs_fda[limma_sig_drugs_fda$GBM_CT == TRUE,])
fract<- num_clin/len
limma_CT_test_res <- clinical_trial_testing(101, "GI1", len, fract, FDA_CT_table)
```

```{r eval= FALSE}
limma_CT_test_res 
```
	Wilcoxon signed rank test with continuity correction

data:  fraction_adj

V = 1900, p-value < 2.2e-16

alternative hypothesis: true location is less than 0.4666667

    
# END
    Location of final scripts:
    script
    
    Location of data produced:
    ~/output/limma_gbm
    
    Dates when operations were done:
    2200421; updated 220802
    
## Versions
```{r}
sessionInfo()
```

