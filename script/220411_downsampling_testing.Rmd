---
title: "220411_downsampling_testing"
author: "Jennifer Fisher"
date: "4/11/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    quick summary 
    
    Finished psedocode on: Date
    
    System which operations were done on: my laptop(on cheaha), lab mac etc... 
    
    GitHub Repo:
    
    Directory of operations: /path
    
    Scripts being edited for operations: filename(s)
    
    Data being used: description and location
    
    Papers and tools: deseq with paper 

# STEPS
### Set working directory 
### load in data
### Analysis
```{r}
library(recount3)
library(SummarizedExperiment)
```

```{r }
human_projects<- available_projects()
```

```{r}

recount3_rse_BRIAN <- create_rse(human_projects[(human_projects$project == "BRAIN"),])
```

```{r}
meta_brain_gtex_data<- colData(recount3_rse_BRIAN)
```

```{r}
table(meta_brain_gtex_data$gtex.smtsd)
```
```{r}
# subsampling from  Brain - Frontal Cortex (BA9); Brain - Cerebellar Hemisphere
#224 & 250 
meta_brain_tissue_frontal <- as.data.frame(meta_brain_gtex_data[meta_brain_gtex_data$gtex.smtsd == "Brain - Frontal Cortex (BA9)",])
meta_brain_tissue_cererbellar_hemi <- as.data.frame(meta_brain_gtex_data[meta_brain_gtex_data$gtex.smtsd =="Brain - Cerebellar Hemisphere",])
```
total 474 samples 

```{r}
set.seed(100)
group1_num <- round(nrow(meta_brain_tissue_cererbellar_hemi) * c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
group2_num <- round(nrow(meta_brain_tissue_frontal)* c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
front_sample_list <- vector(mode = "list", length = 10)
cererbellar_hem_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  front_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal), group2_num[i], replace = FALSE)
  cererbellar_hem_list[[i]]<- sample(rownames(meta_brain_tissue_cererbellar_hemi), group1_num[i], replace = FALSE)
}
```


deseq2 function 
DESEq2 (make into a function )
```{r}

  #count-matrix with just counts
  #metadata
  #dds <- DESeqDataSetFromMatrix(countData = GLUT_COUNTS2,
                         #     colData = colD,
                             # design= ~ batch + group)
deseq2_function <- function(count_df, metadata, sample_list, condition,  B, A){
  metadata<- metadata[rownames(metadata) %in% sample_list,]
  count_df<- count_df[, colnames(count_df) %in% rownames(metadata)]
  #print(head(count_df))
  condition2 <- as.formula(paste("~",condition, sep= " "))
  #print(condition2)
  dds <- DESeqDataSetFromMatrix(countData = count_df,
                              colData =  metadata,
                              design= condition2)
  #dds deseq2 object
  #condition b-TUMOR a-CONTROL 
  dds <- DESeq(dds)
  #resultsNames(dds) # lists the coefficients
  dds_res <- results(dds, c(condition,B,A))
  res_df <- as.data.frame(dds_res)
  res_df <- res_df[complete.cases(res_df),]
  gene_list <-  rownames(res_df)[ res_df$padj < 0.05 & abs(res_df$log2FoldChange) > 2]
 # print(gene_list)
  #head(EV_GLUT_res_df_ENS)
  #file_name <- paste0("/data/project/lasseigne_lab/JLF_scratch/Transfer_Learning_R03/output/deseq2_gbm/",file_name, sep="")
 # write.table(res_df, file=file_name, sep=",", row.names =TRUE)
  return( gene_list)
}
```

```{r}
library(DESeq2)
```

```{r}
brain_count_df <- as.data.frame(assay(recount3_rse_BRIAN))
metadata_gtex_brain <- as.data.frame(meta_brain_gtex_data )
```

normalize count data by tpm
```{r}
Counts_to_tpm <- function(counts, featureLength) {
  # Ensure valid arguments.
  stopifnot(length(featureLength) == nrow(counts))
  # Compute effective lengths of features in each library.
  effLen <- featureLength
  # Process one column at a time.
  tpm <- do.call(cbind, lapply(1:ncol(counts), function(i) {
    rate = log(counts[,i]) - log(effLen)
    denom = log(sum(exp(rate)))
    exp(rate - denom + log(1e6))
  }))
  # Copy the row and column names from the original matrix.
  colnames(tpm) <- colnames(counts)
  rownames(tpm) <- rownames(counts)
  return(tpm)
}
```

```{r}
gene_info<- rowRanges(recount3_rse_BRIAN)
brain_tpm_table<- Counts_to_tpm(brain_count_df, gene_info$bp_length)
```



```{r}
gene_list_tissue_deseq2<- vector(mode = "list", length = 10)
for ( i in 1:10){
  print(i)
  sample_list <- unlist(c(front_sample_list[i], cererbellar_hem_list[i]))
  gene_list_tissue_deseq2[[i]]<- deseq2_function(brain_count_df, metadata_gtex_brain, sample_list, "gtex.smtsd", "Brain - Frontal Cortex (BA9)", "Brain - Cerebellar Hemisphere")
}
```

```{r}
#gene_list_tissue_deseq2
genes <- rownames(brain_count_df)
deseq2_gene_df <- data.frame(matrix(ncol = 10, nrow = length(genes)))
for (i in 1:10){
  deseq2_gene_df[,i] <- genes %in% gene_list_tissue_deseq2[[i]]
}
#hamming distance normalized to the length of the string
dis_deseq2 <- c()
for (i in 1:10){
 dis_deseq2[i]<- sum(deseq2_gene_df[,i] != deseq2_gene_df[,10]) / length(genes)
}
```

```{r}
plot(1:10, dis_deseq2)
```

```{r}
brain_count_mtx <- as.matrix(brain_count_df)
rownames(brain_count_mtx)<-recount3_rse_BRIAN@rowRanges$gene_name
```

```{r}
rm(recount3_rse_BRIAN, meta_brain_tissue_cererbellar_hemi, meta_brain_tissue_frontal)
gc()
```

```{r}
rm(brain_count_df)
gc()
```

```{r}
rm(meta_brain_gtex_data)
gc()
```


```{r}
recount3_plier_gbm <- readRDS("~/data/recount3/recount3_plier_gbm.rds")
```


```{r}
source("~/script/plier_util.R")
```


```{r}
#There is a issue with handling genes with zero expression. Best thing to do is to remove the genes
test <- GetOrderedRowNorm(brain_count_mtx,recount3_plier_gbm )
zeros<- rownames(test)[!complete.cases(test)]
brain_count_mtx_v2<- brain_count_mtx[!rownames(brain_count_mtx) %in% zeros,]
```

```{r}
GBM.GTEx.b.matrix <- GetNewDataB(as.matrix(brain_count_mtx_v2), recount3_plier_gbm)
```

```{r}
TestLVDifferencesJLF <- function(b.matrix, phenotype,
                              use.bonferroni = FALSE) {
  # This function tests for differential expression of PLIER-derived latent
  # variables between groups specified by the phenotype argument
  # using limma. Examples include different disease groups or disease v. 
  # control. It takes the B matrix from a PLIER model and a factor vector with 
  # the group labels. It will reorder the phenotype vector if control.phenotype
  # is specified. The resulting p-values are Benjamini-Hochberg corrected by 
  # default or Bonferroni corrected if use.bonferroni = TRUE
  # 
  # Args:
  #   b.matrix: a B matrix (latent variables are rows, samples are columns) 
  #             from a PLIER model. Can be the B element of the list 
  #             returned by PLIER::PLIER or the output of GetNewDataB
  #   phenotype: a named factor vector that contains group labels to be used
  #              for contrasts
  #   blocking: a names facotor vector that contains group labels to be used for blocking
  #   use.bonferroni: logical - should bonferroni correction be used? if FALSE
  #                   (default), will use "BH"
  #   
  # Returns:
  #   A limma::topTable, where the first column is the latent variable name and
  #   all pathways are returned (without filtering or sorting)
  
  ## error-handling ##
  
  if (is.null(names(phenotype))) {
    stop("phenotype should be a named factor vector -- the names ensure that
         the vector is correctly ordered")
  }
  # no names should be "missing"
  check.names <- all(colnames(b.matrix) %in% names(phenotype)) & 
    all(names(phenotype) %in% colnames(b.matrix)) 
  
  if (!check.names) {
    stop("Some sample(s) is missing from colnames(b.matrix) or 
         names(phenotype)")
  }
  
  # the phenotype labels should be in the same order as the b.matrix samples
  ordered.phenotype <- as.factor(phenotype[colnames(b.matrix)])
  
  # get contrasts (all pairwise)  
  num.levels <- length(levels(ordered.phenotype))
  contrast.vector <- c()
  for (lvl in levels(ordered.phenotype)[1:(num.levels - 1)]) {
    for (lvl.2 in levels(ordered.phenotype)[2:num.levels]) {
      if (lvl != lvl.2) {
        contrast.vector <- append(contrast.vector, paste(lvl, lvl.2, sep = "-"))
      }
    }
  }
  contrast.vector <- paste(contrast.vector, collapse = ", ")
  
  # prep design matrix
  design <- model.matrix(~ 0+ ordered.phenotype )
  colnames(design)[seq_len(nlevels(ordered.phenotype))] <- levels(ordered.phenotype)
  
  
  
  
  #colnames(design) <- levels(ordered.phenotype)
  
  # fit linear model
  fit <- limma::lmFit(b.matrix, design)
  contrast.matrix <-
    eval(parse(
      text = paste0('limma::makeContrasts(', contrast.vector, ', levels = design)')))
  fit2 <- limma::contrasts.fit(fit, contrast.matrix)
  fit2 <- limma::eBayes(fit2)
  
  # extract results as a data.frame
  if (use.bonferroni) {  # if specified, use Bonferroni correction
    limma.result <- limma::topTable(fit2, number = nrow(b.matrix),
                                    adjust.method = "bonferroni", 
                                    sort.by = "none")
  } else {  # calculate FDR
    limma.result <- limma::topTable(fit2, number = nrow(b.matrix),
                                    adjust.method = "BH", sort.by = "none")
  }
  
  # want feature (latent variable) names as column
  limma.result <- tibble::rownames_to_column(limma.result, var = "LV")
  
  return(limma.result)
  
}
```

```{r}
rm(recount3_plier_gbm, brain_count_mtx_v2)
gc()
```

transfer learning 
```{r}
limma_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  sample_list <- unlist(c(front_sample_list[i], cererbellar_hem_list[i]))
  metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
  GBM.GTEx.b.matrix_test <- GBM.GTEx.b.matrix[, colnames(GBM.GTEx.b.matrix) %in% rownames(metadata)]
  test_vector <- metadata$gtex.smtsd
  names(test_vector) <- colnames(GBM.GTEx.b.matrix_test)
  test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
  test<- TestLVDifferencesJLF(GBM.GTEx.b.matrix_test, test_vector ,use.bonferroni = TRUE)
  print(hist( test$logFC[test$adj.P.Val < 0.05]))
  limma_list[[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 0.05]
}
```

```{r}
lvs <- rownames(GBM.GTEx.b.matrix)
limma_lvs_df <- data.frame(matrix(ncol = 10, nrow = length(lvs)))
for (i in 1:10){
  limma_lvs_df[,i] <- lvs %in% limma_list[[i]]
}
#hamming distance normalized to the length of the string
dis_tfl <- c()
for (i in 1:10){
 dis_tfl[i]<- sum(limma_lvs_df[,i] != limma_lvs_df[,10]) / length(lvs)
}
```

```{r}
plot(1:10, dis_tfl)
```

```{r}
fraction <- c(0.1,0.20,0.3, 0.40, 0.5 , 0.6, 0.7 ,0.8,0.9,  1)
fraction<- rep(fraction, 2 )
normalized_Hamming_Distance <- c(dis_deseq2, dis_tfl)
method<- c(rep("DESeq2", 10),rep("Transfer Learning", 10))
dist_deseq_tfl<- as.data.frame(cbind(fraction,normalized_Hamming_Distance,  method))
```


```{r}
library(ggplot2)
```

```{r}
dist_deseq_tfl$normalized_Hamming_Distance <- as.numeric(dist_deseq_tfl$normalized_Hamming_Distance)
dist_deseq_tfl<- dist_deseq_tfl[!dist_deseq_tfl$fraction ==1,]
ggplot(data=dist_deseq_tfl, aes(x=fraction, y=normalized_Hamming_Distance, group=method, color= method)) + geom_line()+ geom_point() +scale_color_manual(values =c("#440154FF","#228C8DFF"))  + labs(title= "Downsampling GTEx Brain Region Differences", x="Fraction of Samples", y = "Normalized Hamming Distance", color= "Method")+theme_classic()
```

limma function 
```{r}
limma_gene_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  sample_list <- unlist(c(front_sample_list[i], cererbellar_hem_list[i]))
  metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
  brain_tpm_mtx_test <- as.matrix( brain_tpm_table[, colnames(brain_tpm_table) %in% rownames(metadata)])
  test_vector <- metadata$gtex.smtsd
  names(test_vector) <- colnames(brain_tpm_mtx_test)
  test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
  test<- TestLVDifferencesJLF(brain_tpm_mtx_test, test_vector ,use.bonferroni = TRUE)
  #print(hist( test$logFC[test$adj.P.Val < 0.05]))
  limma_gene_list[[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 2]
  #print(limma_gene_list[[i]])
}
```

```{r}
#limma_gene_list
genes <- rownames(brain_tpm_table)
limma_genes_df <- data.frame(matrix(ncol = 10, nrow = length(genes)))
for (i in 1:10){
  limma_genes_df[,i] <- genes %in% limma_gene_list[[i]]
}
#hamming distance normalized to the length of the string
dis_limma_genes <- c()
for (i in 1:10){
 dis_limma_genes[i]<- sum(limma_genes_df[,i] != limma_genes_df[,10]) / length(genes)
}
```

```{r}
fraction <- c(0.1, 0.20,0.3, 0.40,0.5, 0.6, 0.7, 0.8, 0.9 ,1)
fraction<- rep(fraction, 3 )
normalized_Hamming_Distance <- c(dis_deseq2, dis_tfl, dis_limma_genes)
method<- c(rep("DESeq2", 10),rep("Transfer Learning", 10), rep("limma", 10))
dist_methods <- as.data.frame(cbind(fraction,normalized_Hamming_Distance,  method))
```

```{r}
library(viridis)
```


```{r}
myCol <- viridis(n=4)[1:3]
dist_methods$normalized_Hamming_Distance <- as.numeric(dist_methods$normalized_Hamming_Distance)
dist_methods_1<- dist_methods[!dist_methods$fraction == 1, ]
ggplot(data=dist_methods_1, aes(x=fraction, y=normalized_Hamming_Distance, group=method, color= method)) + geom_point() +
  geom_smooth(method='lm', formula= y~x)+ scale_color_manual(values =c("#440154FF" , "#31688EFF" ,"#35B779FF"))  + labs(title= "Downsampling GTEx Brain Region Differences", x="Fraction of Samples", y = "Normalized Hamming Distance", color= "Method")+theme_classic()
```




```{r}
summary(lm(dis_deseq2[1:9] ~ fraction[1:9]))
```

```{r}
summary(lm(dis_limma_genes[1:9] ~ fraction[1:9]))
```

```{r}
summary(lm(dis_tfl[1:9] ~ fraction[1:9]))
```

again with sex in the frontal cortex

```{r}
table(metadata_gtex_brain$gtex.sex)
```
one-male 
two-females



```{r}
# subsampling from  Brain - Frontal Cortex (BA9)- female, male
#63 & 161
meta_brain_tissue_frontal_female <- metadata_gtex_brain[ metadata_gtex_brain$gtex.sex == 2,]
meta_brain_tissue_frontal_male <- metadata_gtex_brain[metadata_gtex_brain$gtex.sex == 1,]
```
total  samples 

```{r}
set.seed(100)
group1_num <- round(nrow(meta_brain_tissue_frontal_female) * c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1))
group2_num <- round(nrow(meta_brain_tissue_frontal_male)* c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1))
male_sample_list <- vector(mode = "list", length = 10)
female_sample_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  male_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal_male), group2_num[i], replace = FALSE)
  female_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal_female), group1_num[i], replace = FALSE)
}
```


```{r}
#gene_list_tissue_deseq2_sex<- vector(mode = "list", length = 10)
metadata_gtex_brain$sex<- ifelse( metadata_gtex_brain$gtex.sex ==1, "male", "female")
# starting at 7 because of having to stop run 
for ( i in 8:10){
  print(i)
  sample_list <- unlist(c(male_sample_list[i], female_sample_list[i]))
  gene_list_tissue_deseq2_sex[[i]]<- deseq2_function(brain_count_mtx, metadata_gtex_brain, sample_list, "sex", "male", "female")
  saveRDS(gene_list_tissue_deseq2_sex, "220414_downsampling_gene_list_tissue_deseq2_sex.rds")
}
```

```{r}
#gene_list_tissue_deseq2
genes <- rownames(brain_count_mtx)
deseq2_gene_sex_df <- data.frame(matrix(ncol = 10, nrow = length(genes)))
for (i in 1:10){
  deseq2_gene_sex_df[,i] <- genes %in% gene_list_tissue_deseq2_sex[[i]]
}
#hamming distance normalized to the length of the string
dis_deseq2_sex <- c()
for (i in 1:10){
 dis_deseq2_sex[i]<- sum(deseq2_gene_sex_df[,i] != deseq2_gene_sex_df[,10]) / length(genes)
}
```

```{r}
limma_sex_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  sample_list <- unlist(c(female_sample_list[i], male_sample_list[i]))
  metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
  GBM.GTEx.b.matrix_test <- GBM.GTEx.b.matrix[, colnames(GBM.GTEx.b.matrix) %in% rownames(metadata)]
  test_vector <- metadata$sex
  names(test_vector) <- colnames(GBM.GTEx.b.matrix_test)
  #test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
  test<- TestLVDifferencesJLF(GBM.GTEx.b.matrix_test, test_vector, use.bonferroni = TRUE)
  print(hist( test$logFC[test$adj.P.Val < 0.05]))
  limma_sex_list[[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 0.02]
}
```
```{r}
lvs <- rownames(GBM.GTEx.b.matrix)
limma_lvs_sex_df <- data.frame(matrix(ncol = 10, nrow = length(lvs)))
for (i in 1:10){
  limma_lvs_sex_df[,i] <- lvs %in% limma_sex_list[[i]]
}
#hamming distance normalized to the length of the string
dis_tfl_sex <- c()
for (i in 1:10){
 dis_tfl_sex[i]<- sum(limma_lvs_sex_df[,i] != limma_lvs_sex_df[,10]) / length(lvs)
}
```

```{r}
limma_gene_sex_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  sample_list <- unlist(c(female_sample_list[i], male_sample_list[i]))
  metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
  brain_tpm_mtx_test <- brain_tpm_table[, colnames(brain_tpm_table) %in% rownames(metadata)]
  test_vector <- metadata$sex
  names(test_vector) <- colnames(brain_tpm_mtx_test)
  #test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
  test<- TestLVDifferencesJLF(brain_tpm_mtx_test, test_vector ,use.bonferroni = TRUE)
  #print(hist( test$logFC[test$adj.P.Val < 0.05]))
  limma_gene_sex_list [[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 2]
  #print(limma_gene_list[[i]])
}
```

```{r}
#limma_gene_list
genes <- rownames( brain_tpm_table)
limma_genes_sex_df <- data.frame(matrix(ncol = 10, nrow = length(genes)))
for (i in 1:10){
  limma_genes_sex_df[,i] <- genes %in% limma_gene_sex_list[[i]]
}
#hamming distance normalized to the length of the string
dis_limma_genes_sex <- c()
for (i in 1:10){
 dis_limma_genes_sex[i]<- sum(limma_genes_sex_df[,i] != limma_genes_sex_df[,10]) / length(genes)
}
```


```{r}
fraction <- c(0.1, 0.20, 0.3, 0.40,0.5,  0.6,0.7, 0.8, 0.9, 1)
fraction<- rep(fraction, 3 )
normalized_Hamming_Distance <- c(dis_deseq2_sex, dis_tfl_sex, dis_limma_genes_sex)
method<- c(rep("DESeq2", 10),rep("Transfer Learning", 10), rep("limma", 10))
dist_methods_sex <- as.data.frame(cbind(fraction,normalized_Hamming_Distance,  method))
```

```{r}
library(viridis)
library(ggplot2)
```

```{r}
myCol <- viridis(n=4)[1:3]
dist_methods_sex$normalized_Hamming_Distance <- as.numeric(dist_methods_sex$normalized_Hamming_Distance)
dist_methods_sex<-dist_methods_sex[!dist_methods_sex$fraction == 1,]
ggplot(data=dist_methods_sex, aes(x=fraction, y=normalized_Hamming_Distance, group=method, color= method)) + geom_point() +
  geom_smooth(method='lm', formula= y~x)+ scale_color_manual(values =c("#440154FF" , "#31688EFF" ,"#35B779FF"))  + labs(title= "Downsampling GTEx Brain Sex Differences", x="Fraction of Samples", y = "Normalized Hamming Distance", color= "Method")+theme_classic()
```
```{r}
summary(lm(dis_deseq2_sex[1:9] ~ fraction[1:9]))
```

```{r}
summary(lm(dis_limma_genes_sex[1:9] ~ fraction[1:9]))
```

```{r}
summary(lm(dis_tfl_sex[1:9] ~ fraction[1:9]))
```



```{r}
set.seed(100)
list_lm <- vector(mode = "list", length= 20)
for (j in 1:20){
  seed <- 100 +j 
  set.seed(seed)
  group1_num <- round(nrow(meta_brain_tissue_frontal_female) * c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1))
  group2_num <- round(nrow(meta_brain_tissue_frontal_male)* c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1))
  male_sample_list <- vector(mode = "list", length = 10)
  female_sample_list <- vector(mode = "list", length = 10)
  for (i in 1:10){
    male_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal_male), group2_num[i], replace = FALSE)
    female_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal_female), group1_num[i], replace = FALSE)
  }
  limma_sex_list <- vector(mode = "list", length = 10)
  for (i in 1:10){
    sample_list <- unlist(c(female_sample_list[i], male_sample_list[i]))
    metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
    GBM.GTEx.b.matrix_test <- GBM.GTEx.b.matrix[, colnames(GBM.GTEx.b.matrix) %in% rownames(metadata)]
    test_vector <- metadata$sex
    names(test_vector) <- colnames(GBM.GTEx.b.matrix_test)
  #test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
    test<- TestLVDifferencesJLF(GBM.GTEx.b.matrix_test, test_vector, use.bonferroni = TRUE)
   # print(hist( test$logFC[test$adj.P.Val < 0.05]))
    limma_sex_list[[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 0.02]
    lvs <- rownames(GBM.GTEx.b.matrix)
  limma_lvs_sex_df <- data.frame(matrix(ncol = 10, nrow = length(lvs)))
  }
  for (i in 1:10){
  limma_lvs_sex_df[,i] <- lvs %in% limma_sex_list[[i]]
  }
#hamming distance normalized to the length of the string
  dis_tfl_sex <- c()
  for (i in 1:10){
  dis_tfl_sex[i]<- sum(limma_lvs_sex_df[,i] != limma_lvs_sex_df[,10]) / length(lvs)
  }
list_lm[[j]]<- dis_tfl_sex
}
```

```{r}
for (i in 1:20 ){
  print(i)
  print(summary(lm(list_lm[[i]][1:9] ~ fraction[1:9])))
}
```



```{r}
set.seed(100)
list_lm <- vector(mode = "list", length= 20)
for (j in 1:1000){
  seed <- 100 + (j* 3) 
  set.seed(seed)
  group1_num <- round(nrow(meta_brain_tissue_cererbellar_hemi) * c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
group2_num <- round(nrow(meta_brain_tissue_frontal)* c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
front_sample_list <- vector(mode = "list", length = 10)
cererbellar_hem_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  front_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal), group2_num[i], replace = FALSE)
  cererbellar_hem_list[[i]]<- sample(rownames(meta_brain_tissue_cererbellar_hemi), group1_num[i], replace = FALSE)
}
  limma_sex_list <- vector(mode = "list", length = 10)
  for (i in 1:10){
    sample_list <- unlist(c(front_sample_list[i], cererbellar_hem_list[i]))
    metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
    GBM.GTEx.b.matrix_test <- GBM.GTEx.b.matrix[, colnames(GBM.GTEx.b.matrix) %in% rownames(metadata)]
    test_vector <- metadata$gtex.smtsd
    names(test_vector) <- colnames(GBM.GTEx.b.matrix_test)
  test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
    test<- TestLVDifferencesJLF(GBM.GTEx.b.matrix_test, test_vector, use.bonferroni = TRUE)
   # print(hist( test$logFC[test$adj.P.Val < 0.05]))
    limma_sex_list[[i]] <- test$LV[test$adj.P.Val < 0.05 & abs(test$logFC)> 0.02]
    lvs <- rownames(GBM.GTEx.b.matrix)
  limma_lvs_sex_df <- data.frame(matrix(ncol = 10, nrow = length(lvs)))
  }
  for (i in 1:10){
  limma_lvs_sex_df[,i] <- lvs %in% limma_sex_list[[i]]
  }
#hamming distance normalized to the length of the string
  dis_tfl_sex <- c()
  for (i in 1:10){
  dis_tfl_sex[i]<- sum(limma_lvs_sex_df[,i] != limma_lvs_sex_df[,10]) / length(lvs)
  }
list_lm[[j]]<- dis_tfl_sex
}
```

```{r}
#for (i in 1:1000 ){
#  print(i)
#  print(summary(lm(list_lm[[i]][1:9] ~ fraction[1:9])))
#}
```

```{r}
df_list<- t(as.data.frame(list_lm))
df_list<- df_list[,1:9]
```

```{r}
mean(rowSds(df_list))
```

```{r}
hist(rowSds(df_list))
```

```{r}
brain_tpm_table <- readRDS("~/output/recount3_gbm_gtex_tpm_df.rds")
```


```{r}
set.seed(100)
list_lm <- vector(mode = "list", length= 20)
for (j in 1:1000){
  seed <- 100 + (j* 3) 
  set.seed(seed)
  group1_num <- round(nrow(meta_brain_tissue_cererbellar_hemi) * c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
group2_num <- round(nrow(meta_brain_tissue_frontal)* c(.1, .2, .3, .4, .5, .6,  .7, .8,.9 , 1))
front_sample_list <- vector(mode = "list", length = 10)
cererbellar_hem_list <- vector(mode = "list", length = 10)
for (i in 1:10){
  front_sample_list[[i]]<- sample(rownames(meta_brain_tissue_frontal), group2_num[i], replace = FALSE)
  cererbellar_hem_list[[i]]<- sample(rownames(meta_brain_tissue_cererbellar_hemi), group1_num[i], replace = FALSE)
}
  limma_sex_list <- vector(mode = "list", length = 10)
  for (i in 1:10){
    sample_list <- unlist(c(front_sample_list[i], cererbellar_hem_list[i]))
    metadata<- metadata_gtex_brain[rownames(metadata_gtex_brain) %in% sample_list,]
     brain_tpm_mtx_test <- brain_tpm_table[, colnames(brain_tpm_table) %in% rownames(metadata)]
    test_vector <- metadata$gtex.smtsd
    names(test_vector) <- colnames(brain_tpm_mtx_test)
  test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
  
  TPM <- log2(as.matrix(brain_tpm_mtx_test) + 1)


  test<- TestLVDifferencesJLF(TPM, test_vector ,use.bonferroni = TRUE)
   # print(hist( test$logFC[test$adj.P.Val < 0.05]))
    limma_sex_list[[i]] <- test$ID[test$adj.P.Val < 0.05 & abs(test$logFC)> 0.02]
    lvs <- rownames(brain_tpm_mtx_test)
  limma_lvs_sex_df <- data.frame(matrix(ncol = 10, nrow = length(lvs)))
  }
  for (i in 1:10){
  limma_lvs_sex_df[,i] <- lvs %in% limma_sex_list[[i]]
  }
#hamming distance normalized to the length of the string
  dis_tfl_sex <- c()
  for (i in 1:10){
  dis_tfl_sex[i]<- sum(limma_lvs_sex_df[,i] != limma_lvs_sex_df[,10]) / length(lvs)
  }
list_lm[[j]]<- dis_tfl_sex
}
```
```{r}
df_list_v2<- t(as.data.frame(list_lm))
df_list_v2<- df_list_v2[,1:9]
```

```{r}
mean(rowSds(df_list_v2))
```

```{r}
hist(rowSds(df_list_v2))
```



```{r}
#df_list_sub <- df_list[1:500,]
df_list_test<- as.matrix(rbind(df_list ,df_list_v2))
sd  <- rowSds(df_list_test)
df_list_test<- as.data.frame(df_list_test)
df_list_test$sd<- sd
```

```{r}
df_list_test$method<- c(rep("Transfer Learning", 1000),rep("limma", 1000))
```

```{r}
ggplot( df_list_test,aes( y=sd, x= method, fill= method ) ) + geom_violin()+ scale_fill_manual(values =c("#440154FF","#228C8DFF")) +theme_classic() +labs(x="Method", y = "Standard Deviation", color= "Method")
```

```{r}
coeff<- c()
r_squared<- c()
fraction<- (1:9)* 0.1
for (i in 1:2000){
  test_vector <- unlist(df_list_test[i,1:9])
  test_line <- lm( test_vector ~ fraction[1:9])
  coeff[i]<- test_line$coefficients[2]
  r_squared[i]<- summary(test_line)$r.squared
}
```

```{r}
df_list_test$coeff<-coeff
ggplot( df_list_test, aes( y=coeff, x= method, fill= method ) ) + geom_violin() + scale_fill_manual(values =c("#440154FF","#228C8DFF")) +theme_classic() +labs(x="Method", y = "Slope", color= "Method")
```

```{r}
df_list_test$r_squared<-r_squared
ggplot( df_list_test, aes( y=r_squared, x= method, fill= method ) ) + geom_violin() + scale_fill_manual(values =c("#440154FF","#228C8DFF")) +theme_classic() +labs(x="Method", y = "Coefficient of Determination
(R-Squared)", color= "Method")
```


```{r}
df_list_test_limma<- df_list_test[df_list_test$method == "limma",]
df_list_test_tf <- df_list_test[df_list_test$method == "Transfer Learning",]
```


```{r}
sd_diff <- df_list_test_tf$sd- df_list_test_limma$sd
hist(sd_diff)
```
#tf learning is always lower

```{r}
slope_diff <- df_list_test_tf$coeff- df_list_test_limma$coeff
hist(slope_diff )
```
GBM
```{r}
df_list_test$slope_dis <- 0- df_list_test$coeff
```

```{r}
ggplot( df_list_test, aes( x=slope_dis, fill= method ) ) + geom_histogram(alpha=0.5 , position = 'identity' ) + scale_fill_manual(values =c("#440154FF" , "#35B779FF")) +theme_classic()
```


```{r}
#t test for sd
wilcox.test(df_list_test_tf$sd, df_list_test_limma$sd, paried=TRUE)
#t test for slope
wilcox.test(df_list_test_tf$coeff, df_list_test_limma$coeff, paried=TRUE)
# t-slope for distance from zero
wilcox.test(df_list_test_tf$r_squared, df_list_test_limma$r_squared, paried=TRUE)
```


```{r}
tf_avg<- colMeans(df_list_test_tf[,1:9])
limma_avg <- colMeans(df_list_test_limma[,1:9])
names(tf_avg) <- fraction
names(limma_avg) <- fraction 
avg_results <- as.data.frame(cbind(tf_avg, limma_avg))
avg_results$fraction <- rownames(avg_results)
```

```{r}
avg_results_long <- pivot_longer(as.data.frame(avg_results),cols = 1:2, names_to = "methods" )
```


```{r}
#myCol <- viridis(n=4)[1:3]
#dist_methods_sex$normalized_Hamming_Distance <- as.numeric(dist_methods_sex$normalized_Hamming_Distance)
#dist_methods_sex<-dist_methods_sex[!dist_methods_sex$fraction == 1,]

#avg_results_long$methods<- ifelse(avg_results_long$methods == "limma_avg", "limma", "Transfer Learning")
ggplot(data=avg_results_long, aes(x=fraction, y=value, group=methods, color= methods)) + geom_point() +
  geom_smooth(method='lm', formula= y~x)+ scale_color_manual(values =c("#440154FF","#228C8DFF"))  + labs(title= "Downsampling GTEx Brain Sex Differences", x="Fraction of Samples", y = "Avg. Normalized Hamming Distance", color= "Method")+theme_classic()
```

### Save Data
### Save Figures
    
# END
    Location of final scripts:
    
    Location of data produced:
    
    Dates when operations were done:
    
## Versions
```{r}
sessionInfo()
```

