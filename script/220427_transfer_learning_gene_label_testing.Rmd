---
title: "220427_transfer_learning_gene_label_testing"
author: "Jennifer Fisher"
date: "4/27/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    For this analysis, GTEx Brain Frontal Cortex and Cerebellar Hemisphere regions were compared with transfer learning approach, but a fraction of the genes had their labels switched with another gene. This was done at 10 to 100% at 10% intervals of all the genes 50 times. The average number of latent variables significant for each interval was calculated (adj. P-value < 0.05 ; fold change of 0.05). A linear regression model was used to determine if there was an influence of the number of latent variables significant and fraction of genes with a randomly switched label. 
    
    Finished psedocode on:
    220427
    
    System which operations were done on: 
    my laptop 
    
    GitHub Repo:
    Transfer_Leanring_R03
    
    Docker:
    rstudio_cancer_dr
    
    Directory of operations:
    /home/rstudio (Docker)
    
    Scripts being edited for operations: filename(s)
    
    Data being used: 
    GTEx Brain data from RECOUNT3
    
    Papers and tools: 
    limma, MultiPLIER

# STEPS
### Set working directory 
```{r}
library(recount3)
library(SummarizedExperiment)
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
library(signatureSearch)
library(HDF5Array)
library(viridis)
library(tidyr)
library(gprofiler2)
library(ggplot2)
library(ggpubr)
library(VennDiagram)
library(ComplexHeatmap)
library(dplyr)
library(gplots)
library(circlize)
source("~/script/plier_util.R")
source("~/script/test_LV_differences.R")
library(dplyr)
library(stringr)
```


### load in data

```{r}
brain_gtex_tpm <- readRDS("~/data/recount3/recount3_fix_download/brain_gtex_tpm.rds")
brain_gtex_metadata <- readRDS("~/data/recount3/recount3_fix_download/brain_gtex_metadata.rds")
```

```{r}
ids<- str_replace_all(colnames(brain_gtex_tpm), "[[:punct:]]", "-") 
meta_data_ids<- str_replace_all(brain_gtex_metadata$external_id, "[[:punct:]]", "-")
```

```{r}
identical(ids[order(ids)], meta_data_ids[order(meta_data_ids)])
```

```{r}
brain_gtex_tpm_order <- brain_gtex_tpm[,order(ids)]
brain_gtex_metadata_order<- brain_gtex_metadata[order(meta_data_ids), ]
```

```{r}
colnames(brain_gtex_tpm_order )<- brain_gtex_metadata_order$external_id
```

check to make sure things line up 
```{r}
feature_info <- readRDS("~/data/recount3/recount3_fix_download/feature_info.rds")
```

```{r}
identical(feature_info$gene_id, rownames(brain_gtex_tpm))
```


```{r}
rownames(brain_gtex_tpm_order)<- feature_info$gene_name
```


```{r}
tpm_df <- as.data.frame(brain_gtex_tpm_order)
```


```{r}
# subsampling from  Brain - Frontal Cortex (BA9); Brain - Cerebellar Hemisphere
#224 & 250 
rownames(brain_gtex_metadata) <- colnames(tpm_df )
meta_brain_tissue  <- as.data.frame(brain_gtex_metadata[brain_gtex_metadata$SMTSD == "Brain - Frontal Cortex (BA9)" | brain_gtex_metadata$SMTSD =="Brain - Cerebellar Hemisphere",])
```


```{r}
#make b Matrix for just the brain regions
GBM.GTEx.tpm_test<-tpm_df[, colnames(tpm_df ) %in% rownames(meta_brain_tissue)]

identical(colnames(GBM.GTEx.tpm_test), rownames(meta_brain_tissue))
```

```{r}
#make test vector 
test_vector <- meta_brain_tissue$SMTSD 
names(test_vector) <- colnames(GBM.GTEx.tpm_test)
  #change to the
test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
```


```{r eval=FALSE}
recount3_plier <- readRDS("~/data/recount3_plier_wo.rds")
```

### Analysis

```{r eval=FALSE}
test<- round((1:10 *.1) * nrow(GBM.GTEx.tpm_test))
#test1<- gene_reordering_testing(100, GBM.GTEx.tpm_test, test_vector,test)
#test15<- gene_reordering_testing(150, GBM.GTEx.tpm_test, test_vector,test)
```

```{r eval=FALSE}
limma_genes_df <- data.frame(matrix(ncol = 10, nrow = 50))
for (i in 1:50){
  print(i)
  number_seed<- 100 + (i*3)
  limma_genes_df[i,] <- gene_reordering_testing(number_seed, GBM.GTEx.tpm_test, test_vector,test)
}
```


```{r eval=FALSE}
fraction <- (1:10)*.1
Avg_Num_LV <- colMeans(limma_genes_df)
gene_test_data <- data.frame(fraction, Avg_Num_LV)
```


```{r eval=FALSE}
library(ggplot2)
ggplot(data=gene_test_data, aes(x=fraction, y=Avg_Num_LV)) + geom_line()+ geom_point() + scale_color_manual(values ="#228C8DFF")  + labs(title= "Gene Switching GTEx Brain Region Differences", x="Fraction of Gene with Different Labels", y = "Average Number of Latent Variables")+   geom_smooth(method='lm', formula= y~x)+  theme_classic()
ggsave("/home/rstudio/output/220428_gene_switching_line_plot.png")
```

```{r}
knitr::include_graphics("~/output/220428_gene_switching_line_plot.png")
```

```{r eval=FALSE}
summary(lm(gene_test_data$Avg_Num_LV ~ gene_test_data$fraction))
```
Call:
lm(formula = gene_test_data$Avg_Num_LV ~ gene_test_data$fraction)

Residuals:
   Min     1Q Median     3Q    Max 
-1.956 -1.489 -0.330  1.159  2.737 

Coefficients:
                        Estimate Std. Error t value Pr(>|t|)    
(Intercept)               16.935      1.275  13.279 9.87e-07 ***
gene_test_data$fraction  -19.318      2.055  -9.399 1.35e-05 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.867 on 8 degrees of freedom
Multiple R-squared:  0.917,	Adjusted R-squared:  0.9066 
F-statistic: 88.34 on 1 and 8 DF,  p-value: 1.346e-05


### Save Data
NA
### Save Figures
Done in script

# END
    Location of final scripts:
    /script
    
    Location of data produced:
    none. 
    
    Dates when operations were done:
    204027-220428
    
## Versions
```{r}
sessionInfo()
```

