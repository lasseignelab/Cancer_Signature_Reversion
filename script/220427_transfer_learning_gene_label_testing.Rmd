---
title: "220427_transfer_learning_gene_label_testing"
author: "Jennifer Fisher"
date: "4/27/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    For this analysis, GTEx Brain Frontal Cortex and Cerebellar Hemisphere regions were compared with transfer learning approach, but a fraction of the genes had their labels switched with another gene. This was done at 10 to 100% at 10% intervals of all the genes 50 times. The average number of latent variables significant for each interval was calculated (adj. P-value < 0.05 ; fold change of 0.05). A linear regression model was used to determine if there was an influence of the number of latent variables significant and fraction of genes with a randomly switched label. 
    
    Finished psedocode on:
    220427
    
    System which operations were done on: 
    my laptop 
    
    GitHub Repo:
    Transfer_Leanring_R03
    
    Docker:
    rstudio_tf_dr_v3
    
    Directory of operations:
    /home/rstudio (Docker)
    
    Scripts being edited for operations: filename(s)
    
    Data being used: 
    GTEx Brain data from RECOUNT3
    
    Papers and tools: 
    limma, MultiPLIER

# STEPS
### Set working directory 
```{r}
library(recount3)
library(SummarizedExperiment)
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
library(signatureSearch)
library(HDF5Array)
library(viridis)
library(tidyr)
library(gprofiler2)
library(ggplot2)
library(ggpubr)
library(VennDiagram)
library(ComplexHeatmap)
library(dplyr)
library(gplots)
library(circlize)
source("~/script/plier_util.R")
source("~/script/test_LV_differences.R")
library(dplyr)
```


### load in data

```{r }
human_projects<- available_projects()
```

```{r}
#SRP118922
recount3_rse_BRIAN <- create_rse(human_projects[(human_projects$project == "BRAIN"),])
```

```{r}
recount3_count_brain<- assay(recount3_rse_BRIAN)
recount3_count_brain <- as.data.frame(recount3_count_brain)
```

```{r}
meta_brain_gtex_data<- colData(recount3_rse_BRIAN)
```


```{r}
# subsampling from  Brain - Frontal Cortex (BA9); Brain - Cerebellar Hemisphere
#224 & 250 
meta_brain_tissue  <- as.data.frame(meta_brain_gtex_data[meta_brain_gtex_data$gtex.smtsd == "Brain - Frontal Cortex (BA9)" | meta_brain_gtex_data$gtex.smtsd =="Brain - Cerebellar Hemisphere",])
```

```{r}
gene_info <- as.data.frame(recount3_rse_BRIAN@rowRanges)
```
check to make sure things line up 
```{r}
identical(gene_info$gene_id, rownames(recount3_count_brain))
```

```{r}
tpm_table<- Counts_to_tpm(recount3_count_brain, gene_info$bp_length)
```

```{r}
rownames(tpm_table)<- gene_info$gene_name
```

```{r}
tpm_df <- as.data.frame(tpm_table)
```


```{r}
#make b Matrix for just the brain regions
GBM.GTEx.tpm_test<-tpm_df[, colnames(tpm_df ) %in% rownames(meta_brain_tissue)]

identical(colnames(GBM.GTEx.tpm_test), rownames(meta_brain_tissue))
```

```{r}
#make test vector 
test_vector <- meta_brain_tissue$gtex.smtsd
names(test_vector) <- colnames(GBM.GTEx.tpm_test)
  #change to the
test_vector<- ifelse(test_vector == "Brain - Cerebellar Hemisphere", "CH", "FC")
```

```{r eval=FALSE}
rm(recount3_rse_BRIAN, meta_brain_gtex_data, human_projects)
gc()
```


```{r eval=FALSE}
recount3_plier <- readRDS("~/data/recount3_plier_wo.rds")
```

### Analysis



```{r eval=FALSE}
test<- round((1:10 *.1) * nrow(GBM.GTEx.tpm_test))
#test1<- gene_reordering_testing(100, GBM.GTEx.tpm_test, test_vector,test)
#test15<- gene_reordering_testing(150, GBM.GTEx.tpm_test, test_vector,test)
```

```{r eval=FALSE}
limma_genes_df <- data.frame(matrix(ncol = 10, nrow = 50))
for (i in 1:50){
  print(i)
  number_seed<- 100 + (i*3)
  limma_genes_df[i,] <- gene_reordering_testing(number_seed, GBM.GTEx.tpm_test, test_vector,test)
}
```


```{r eval=FALSE}
fraction <- (1:10)*.1
Avg_Num_LV <- colMeans(limma_genes_df)
gene_test_data <- data.frame(fraction, Avg_Num_LV)
```


```{r eval=FALSE}
library(ggplot2)
ggplot(data=gene_test_data, aes(x=fraction, y=Avg_Num_LV)) + geom_line()+ geom_point() + scale_color_manual(values ="#228C8DFF")  + labs(title= "Gene Switching GTEx Brain Region Differences", x="Fraction of Gene with Different Labels", y = "Average Number of Latent Variables")+   geom_smooth(method='lm', formula= y~x)+  theme_classic()
ggsave("/home/rstudio/output/220428_gene_switching_line_plot.png")
```

```{r}
knitr::include_graphics("~/output/220428_gene_switching_line_plot.png")
```

```{r eval=FALSE}
summary(lm(gene_test_data$Avg_Num_LV ~ gene_test_data$fraction))
```
Call:

lm(formula = gene_test_data Avg_Num_LV ~ gene_test_data fraction)

Residuals:

   Min     1Q Median     3Q    Max 

-1.948 -1.482 -0.336  1.118  2.796 

Coefficients:

Estimate Std. Error t value Pr(>|t|)    

(Intercept)               16.959      1.282  13.230 1.02e-06 ***

gene_test_data$fraction  -19.350      2.066  -9.367 1.38e-05 ***

---

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.876 on 8 degrees of freedom

Multiple R-squared:  0.9164,	Adjusted R-squared:  0.906 

F-statistic: 87.73 on 1 and 8 DF,  p-value: 1.381e-05


### Save Data
NA
### Save Figures
Done in script

# END
    Location of final scripts:
    /script
    
    Location of data produced:
    none. 
    
    Dates when operations were done:
    204027-220428
    
## Versions
```{r}
sessionInfo()
```

