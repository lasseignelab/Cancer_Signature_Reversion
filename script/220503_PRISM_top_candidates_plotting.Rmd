---
title: "220503_PRISM_top_candidates_plotting"
author: "Jennifer Fisher"
date: "5/3/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    The DepMap/PRISMâ€™s primary  pooled drug screens were used to help evaluate if a candidate could be a suitable candidate (if that drug was tested). The primary screen calculated the median of log fold change median fluorescence intensity between replicates of a cell line treated with a drug. The PRISM study considered a cell line as sensitive to a treatment if the median-collapsed fold-change is less than 0.3. 
    
    Finished psedocode on: 
    220503
    
    System which operations were done on:
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker:
    rstudio_cancer_dr
    
    Directory of operations:
    /home - docker
    
    Scripts being edited for operations: 
    NA
    
    Data being used: 
    PRISM/DEPMAP data downloaded from depmap.org data explore tool. 220503- download data
    /output/TF_L_GBM/220503_PRISM_DEPMAP_candidate_data/
    
    Papers and tools:
    NA

# STEPS
### Set working directory 
### load in data

```{r}
primary_gbm_res <- read.csv(file= "~/output/220808_prism_gbm_candidates.csv" )
```

```{r}
library(readr)
cell_gbm_info<- read_csv("~/data/DEPMAP_PRISM_220228/cell-line-selector_gbm_top_ten.csv")
```

remove the odd names
```{r}
cell_gbm_info<- cell_gbm_info[, -c(1:3, 5)]
```

```{r}
library(tidyr)
```

```{r}
cell_gbm_info_longer <- pivot_longer(cell_gbm_info, c(2:12), names_to = "drug", values_to = "log2change")
```
removing the extra info in the drug stuff 
```{r}
cell_gbm_info_longer$drug <- sub(" .*", "", cell_gbm_info_longer$drug)
```
remove NAs from the logfold change data
```{r}
cell_gbm_info_longer_v2 <- cell_gbm_info_longer[ ! is.na(cell_gbm_info_longer$log2change),]
```

### Analysis

```{r}
library(ggplot2)
library(cowplot)
```
```{r}
library(viridis)
library(circlize)
library(ComplexHeatmap)
```


```{r}
p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= drug, color= drug))+ geom_point(stat = "identity") +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 

p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= drug)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

plot_grid(p1, p2, ncol = 1, align = "v")
```
```{r}
cell_gbm_info_longer_v2$tmz_cell<- ifelse(cell_gbm_info_longer_v2$displayName %in% c("A172", "GB1","KNS81", "SF295", "YH13", "YKG1"), "TMZ_RES", "TMZ_Sen")
```


```{r}
gbm_candidate_prism_plot_tmz <- function(cell_line_info, drug){
  
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug %in% c(drug, "temozolomide"),]
    
  #cell_gbm_info_longer_v2$shape <- ifelse(cell_gbm_info_longer_v2$tmz_cell== "TMZ_RES", 19, 17)
  cell_gbm_info_longer_v2$tmz_cell<- factor(cell_gbm_info_longer_v2$tmz_cell, levels= c("TMZ_Sen", "TMZ_RES" ))
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= drug, shape= tmz_cell))+ geom_point(stat = "identity", size = 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= drug)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

  plot_grid(p1+ scale_fill_manual( values=c("#440154FF","#228C8DFF")), p2+ scale_color_manual( values= c("#440154FF","#228C8DFF") ), ncol = 1, align = "v")
}
```


```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "simvastatin")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "pamidronate")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "floxuridine")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "nimodipine")
```


```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "vardenafil")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "moxifloxacin")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "diltiazem")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "diflunisal")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "saxagliptin")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "icosapent")
```


want to determine if there is a difference between groups and drug repesonse

```{r}
#mgmt methylation
cell_gbm_info_longer_v2$MGMT_METH<-  ifelse(cell_gbm_info_longer_v2$`MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504` >0.5, "Hyper methylation (>0.5)", "Hypo methylation (=< 0.5)")

drugs<- unique(cell_gbm_info_longer_v2$drug)
mgmt<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$MGMT_METH),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$MGMT_METH == "Hyper methylation (>0.5)",1]
    y<- test[!cell_line_info$MGMT_METH == "Hyper methylation (>0.5)",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       mgmt[i]<- res$p.value
    }
}
```
```{r}
#egfr COPY NUMBER
cell_gbm_info_longer_v2$EGFR_copy <- ifelse(cell_gbm_info_longer_v2$`EGFR (ERBB1, ERBB) Copy Number 22Q2 Public` >2, "Copy Number > 2", "Copy Number =< 2")

egfr_amp<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$EGFR_copy ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$EGFR_copy  == "Copy Number > 2",1]
    y<- test[!cell_line_info$EGFR_copy  == "Copy Number > 2",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       egfr_amp[i]<- res$p.value
    }else{
      print(i)
    }
    
}
#note most of the gbm cell lines have no egfr amplication
```

```{r}
#table(cell_gbm_info_longer_v2$Gender)
sex<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$Gender ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$Gender  == "Male",1]
    y<- test[!cell_line_info$Gender  == "Male",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       sex[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```

```{r}
#tmz non-senssitive cell lines (0.3=> logfoldchange in PRISM)
#A172
#GB1
#KNS81
#SF295
#YH13
#YKG1

cell_gbm_info_longer_v2$tmz_cell<- ifelse(cell_gbm_info_longer_v2$displayName %in% c("A172", "GB1","KNS81", "SF295", "YH13", "YKG1"), "TMZ_RES", "TMZ_Sen")

tmz<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$tmz_cell ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$tmz_cell  == "TMZ_RES",1]
    y<- test[!cell_line_info$tmz_cell  == "TMZ_RES",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       tmz[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```


```{r}
drugs<- unique(cell_gbm_info_longer_v2$drug)
index<- c(3,4,10,11,12)
test_res<- matrix(nrow= 11, ncol= 5)
for( i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  for(j in 1:5){
    test<- cell_line_info[,c(index[j], 18)]
    groups<- test[,1]== 1
    x<- test[groups,2]
    y<- test[!groups,2]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
      test_res[i,j]<- res$p.value
    }else{
      res<- NA
      test_res[i,j]<-res
    }
  }
} 
rownames(test_res)<- drugs
colnames(test_res)<- colnames(cell_gbm_info_longer_v2)[index]
test_res<- cbind(test_res, sex, tmz,  mgmt)
```

```{r}
test_res_filter_1<- test_res< 0.05
#p-value for the MGMT promotor
test_res_filter_2<- test_res< 0.16795666
```

```{r}
gbm_candidate_prism_plot_two_groups <- function(cell_line_info, drug, info_index, divider= 0, group1="Normal", group2= "Mutation" ){
  
  #index_col <- grepl(colnames(cell_line_info), info)
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug == drug,]
  
  a <- ifelse(cell_gbm_info_longer_v2[,info_index] ==divider , 19, 17)
  cell_gbm_info_longer_v2$test <- ifelse(cell_gbm_info_longer_v2[,info_index] ==divider , group1, group2)
  #print(a)
  #nam <- colnames(cell_gbm_info_longer_v2)[info_index]
  #cell_gbm_info_longer_v2[,info_index]<- as.factor(cell_gbm_info_longer_v2[,info_index])
  #print(cell_gbm_info_longer_v2[,info_index])
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= test))+ geom_point(stat = "identity", shape = a, size = 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 
  #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= test)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

  plot_grid(p1+ scale_fill_manual( values=c("#440154FF","#228C8DFF")), p2+ scale_color_manual( values= c("#440154FF","#228C8DFF") ), ncol = 1, align = "v")
  
}
```

```{r}
#pten pamidronate
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 12 )
```

```{r}
#Sex
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "vardenafil", 14, divider= "Male", group1="Male", group2= "Female")
```

```{r}
cell_gbm_info_longer_v2<- cell_gbm_info_longer_v2[,c(1:18, 20,21, 19)]
```

different p-value threshold because of low poer. DO NOT TRUST THIS DATA
```{r}
#"EGFR_copy"
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "diflunisal", 21, divider= "TMZ_RES", group1="TMZ Resistant", group2= "TMZ Sensitive")
```
if they are reistant to tmz it looks reistant here. 

```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "icosapent", 21, divider= "TMZ_RES", group1="TMZ Resistant", group2= "TMZ Sensitive")
```




```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "floxuridine", 19, divider= "Hyper methylation (>0.5)", group1="Hyper methylation (>0.5)", group2= "Hypo methylation (=< 0.5)")
```


```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 14, divider= "Male", group1="Male", group2= "Female")
```

```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "icosapent", 14, divider= "Male", group1="Male", group2= "Female")
```


```{r}
#pten 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 12 )
```


```{r}
#"TP53 (LFS1, p53) Mutation 22Q2 Public
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 3 )
```


```{r}
#"TP53 (LFS1, p53) Mutation 22Q2 Public
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "floxuridine", 3 )
```

```{r}
#"RB1 (PPP1R130, RB, OSRC) Mutation 22Q2 Public" 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 10 )
```

```{r}
#"RB1 (PPP1R130, RB, OSRC) Mutation 22Q2 Public" 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 10 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 11 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 11 )
```
```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "temozolomide", 11 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "simvastatin", 11 )
```

linear regression stuff with methylation of MGMT and efgr amplication


```{r}
egfr_copy_p<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$`EGFR (ERBB1, ERBB) Copy Number 22Q2 Public` ),]
  #groups<- 
  test<- as.data.frame(cell_line_info[,c(5, 18)])
  res <- lm(log2change ~ `EGFR (ERBB1, ERBB) Copy Number 22Q2 Public`, test)
  egfr_copy_p[i]<- summary(res)$coefficients[,4][2] 
  
}
```


```{r}
mgmt_methy_p<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$`MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504` ),]
  #groups<- 
  test<- as.data.frame(cell_line_info[,c(2, 18)])
  res <- lm(log2change ~ `MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504`, test)
  mgmt_methy_p[i]<- summary(res)$coefficients[,4][2] 
  
}
```

```{r}
test_res <- cbind(test_res, egfr_copy_p, mgmt_methy_p)
```

```{r}
gbm_candidate_prism_plot_cont <- function(cell_line_info, drug, info_index, title ){
  
  #index_col <- grepl(colnames(cell_line_info), info)
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug == drug,]


  nam <- colnames(cell_gbm_info_longer_v2)[info_index]
  #cell_gbm_info_longer_v2[,info_index]<- as.factor(cell_gbm_info_longer_v2[,info_index])
  #print(cell_gbm_info_longer_v2[,info_index])
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= get(nam)))+ geom_point(stat = "identity", size= 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3)+ labs(color=title) 
  #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)
  
  legend <- get_legend(p2)
  p2<- p2 + theme(legend.position='none')
  ggdraw(plot_grid(plot_grid(p1, p2, ncol=1, align='v'),
                 plot_grid(NULL, legend, ncol=1),
                 rel_widths=c(1, 0.2)))
  
}
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "moxifloxacin", 2, "MGMT Promoter Methylation(0-1)" )
```
```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "floxuridine", 2, "MGMT Promoter Methylation(0-1)" )
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "floxuridine", 5, "EGFR Copy Number" )
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "moxifloxacin", 5, "EGFR Copy Number" )
```
```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "nimodipine", 5, "EGFR Copy Number" )
```


change the tmz resistant test
compare the log2fold changes of the resistnat cells lines between drugs not within a drug. 
```{r}

cell_gbm_info_longer_v3<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$tmz_cell =="TMZ_RES", ]

tmz_v2 <- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v3[cell_gbm_info_longer_v3$drug %in% c(drugs[i], "temozolomide"),]
   #simvastain does have the A172 cell line so 
    # only keep cell lines with duplicated
  paired_cell_lines<- cell_line_info$displayName[duplicated(cell_line_info$displayName)]
  cell_line_info<- cell_line_info[cell_line_info$displayName %in% paired_cell_lines,]
  test<- as.vector(as.data.frame(cell_line_info[,17:18]))
  x<- test[test$drug  == drugs[i],2]
  y<- test[!test$drug ==  drugs[i],2]
  x<- as.numeric(unlist(x))
  y<- as.numeric(unlist(y))
   
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided", paired = TRUE) 
       tmz_v2[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```


```{r}
#replace the old tmz resistant p-values with the new p-values
colnames(test_res)
tmz_v2[1]<- 1 # for temzolomide
test_res[,7]<- tmz_v2
```



```{r}
#plot.data$stars <- cut(plot.data$p.value, breaks=c(-Inf, 0.001, 0.01, 0.05, Inf), label=c("***", "**", "*", "")) 
test_res_t <- t(test_res)
rownames(test_res_t)<- c("TP53 Mutation - Wilcox", "EGFR Mutation - Wilcox" , "RB1 Mutation - Wilcox", "MTOR Mutation - Wilcox", "PTEN Mutation - Wilcox", "Sex - Wilcox", "TMZ-Resistant - Wilcox Paired", "MGMT Promoter Methylation (high vs low) - Wilcox", "EGFR Copy Number - linear regression", "MGMT Promoter Methylation- linear regression"  )                                         
col_fun = colorRamp2(c(0,  1), c("blue", "white"))
Heatmap(test_res_t, nam= "p-value of biomarker and PRISM Drug Response", col = col_fun, column_names_rot = 45,
               clustering_distance_rows= "euclidean",
               clustering_distance_columns=  "euclidean",
               clustering_method_rows = "ward.D2" ,
               clustering_method_columns="ward.D2", 
        cell_fun = function(j, i, x, y, w, h, fill) {
        if(test_res_t[i, j] < 0.05) {
            grid.text("*", x, y)
        } else if(test_res_t[i, j] < 0.2) {
          grid.text("?", x, y)
      }})
```


top 5 

```{r}
cell_gbm_info_longer_v3<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug %in% c(" pamidronate", "nimodipine", "moxifloxacin", "saxagliptin", "icosapent", "temozolomide"),]
```



```{r}
p2 <- ggplot(cell_gbm_info_longer_v3, aes(x=log2change, y= drug, color= drug))+ geom_point(stat = "identity") +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 

p1 <- ggplot(cell_gbm_info_longer_v3, aes(x=log2change, fill= drug)) + geom_density(alpha=.2) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

plot_grid(p1, p2, ncol = 1, align = "v")
```




### Save Data
### Save Figures
NA
    
# END
    Location of final scripts:
    /script
    
    Location of data produced:
    na
    
    Dates when operations were done:
    220901
    
## Versions
```{r}
sessionInfo()
```
