---
title: "220503_PRISM_top_candidates_plotting"
author: "Jennifer Fisher"
date: "5/3/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    The DepMap/PRISMâ€™s primary  pooled drug screens were used to help evaluate if a candidate could be a suitable candidate (if that drug was tested). The primary screen calculated the median of log fold change median fluorescence intensity between replicates of a cell line treated with a drug. The PRISM study considered a cell line as sensitive to a treatment if the median-collapsed fold-change is less than 0.3. 
    
    Finished psedocode on: 
    220503
    
    System which operations were done on:
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker:
    rstudio_cancer_dr
    
    Directory of operations:
    /home - docker
    
    Scripts being edited for operations: 
    NA
    
    Data being used: 
    PRISM/DEPMAP data downloaded from depmap.org data explore tool. 220503- download data
    /output/TF_L_GBM/220503_PRISM_DEPMAP_candidate_data/
    
    Papers and tools:
    NA

# STEPS
### Set working directory 
### load in data

```{r}
primary_gbm_res <- read.csv(file= "~/output/220808_prism_gbm_candidates.csv" )
```

```{r}
library(readr)
cell_gbm_info<- read_csv("~/data/DEPMAP_PRISM_220228/cell-line-selector_gbm_top_ten.csv")
```

remove the odd names
```{r}
cell_gbm_info<- cell_gbm_info[, -c(1:3, 5)]
```

```{r}
library(tidyr)
```

```{r}
cell_gbm_info_longer <- pivot_longer(cell_gbm_info, c(2:12), names_to = "drug", values_to = "log2change")
```
removing the extra info in the drug stuff 
```{r}
cell_gbm_info_longer$drug <- sub(" .*", "", cell_gbm_info_longer$drug)
```
remove NAs from the logfold change data
```{r}
cell_gbm_info_longer_v2 <- cell_gbm_info_longer[ ! is.na(cell_gbm_info_longer$log2change),]
```

### Analysis

```{r}
library(ggplot2)
library(cowplot)
```
```{r}
library(viridis)
library(circlize)
library(ComplexHeatmap)
```


```{r}
p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= drug, color= drug))+ geom_point(stat = "identity") +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 

p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= drug)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

plot_grid(p1, p2, ncol = 1, align = "v")
```
```{r}
cell_gbm_info_longer_v2$tmz_cell<- ifelse(cell_gbm_info_longer_v2$displayName %in% c("A172", "GB1","KNS81", "SF295", "YH13", "YKG1"), "TMZ_RES", "TMZ_Sen")
```


```{r}
gbm_candidate_prism_plot_tmz <- function(cell_line_info, drug){
  
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug %in% c(drug, "temozolomide"),]
    
  #cell_gbm_info_longer_v2$shape <- ifelse(cell_gbm_info_longer_v2$tmz_cell== "TMZ_RES", 19, 17)
  cell_gbm_info_longer_v2$tmz_cell<- factor(cell_gbm_info_longer_v2$tmz_cell, levels= c("TMZ_Sen", "TMZ_RES" ))
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= drug, shape= tmz_cell))+ geom_point(stat = "identity", size = 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= drug)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

  plot_grid(p1+ scale_fill_manual( values=c("#440154FF","#228C8DFF")), p2+ scale_color_manual( values= c("#440154FF","#228C8DFF") ), ncol = 1, align = "v")
}
```


```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "simvastatin")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "pamidronate")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "floxuridine")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "nimodipine")
```


```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "vardenafil")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "moxifloxacin")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "diltiazem")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "diflunisal")
```
```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "saxagliptin")
```

```{r}
gbm_candidate_prism_plot_tmz(cell_gbm_info_longer_v2, "icosapent")
```


want to determine if there is a difference between groups and drug repesonse

```{r}
#mgmt methylation
cell_gbm_info_longer_v2$MGMT_METH<-  ifelse(cell_gbm_info_longer_v2$`MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504` >0.5, "Hyper methylation (>0.5)", "Hypo methylation (=< 0.5)")

drugs<- unique(cell_gbm_info_longer_v2$drug)
mgmt<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$MGMT_METH),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$MGMT_METH == "Hyper methylation (>0.5)",1]
    y<- test[!cell_line_info$MGMT_METH == "Hyper methylation (>0.5)",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       mgmt[i]<- res$p.value
    }
}
```
```{r}
#egfr COPY NUMBER
cell_gbm_info_longer_v2$EGFR_copy <- ifelse(cell_gbm_info_longer_v2$`EGFR (ERBB1, ERBB) Copy Number 22Q2 Public` >2, "Copy Number > 2", "Copy Number =< 2")

egfr_amp<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$EGFR_copy ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$EGFR_copy  == "Copy Number > 2",1]
    y<- test[!cell_line_info$EGFR_copy  == "Copy Number > 2",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       egfr_amp[i]<- res$p.value
    }else{
      print(i)
    }
    
}
#note most of the gbm cell lines have no egfr amplication
```

```{r}
#table(cell_gbm_info_longer_v2$Gender)
sex<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$Gender ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$Gender  == "Male",1]
    y<- test[!cell_line_info$Gender  == "Male",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       sex[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```

```{r}
#tmz non-senssitive cell lines (0.3=> logfoldchange in PRISM)
#A172
#GB1
#KNS81
#SF295
#YH13
#YKG1

cell_gbm_info_longer_v2$tmz_cell<- ifelse(cell_gbm_info_longer_v2$displayName %in% c("A172", "GB1","KNS81", "SF295", "YH13", "YKG1"), "TMZ_RES", "TMZ_Sen")

tmz<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$tmz_cell ),]
  #groups<- 
  test<- as.vector(as.data.frame(cell_line_info[,18]))
    x<- test[cell_line_info$tmz_cell  == "TMZ_RES",1]
    y<- test[!cell_line_info$tmz_cell  == "TMZ_RES",1]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
       tmz[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```


```{r}
drugs<- unique(cell_gbm_info_longer_v2$drug)
index<- c(3,4,10,11,12)
test_res<- matrix(nrow= 11, ncol= 5)
for( i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  for(j in 1:5){
    test<- cell_line_info[,c(index[j], 18)]
    groups<- test[,1]== 1
    x<- test[groups,2]
    y<- test[!groups,2]
    x<- as.numeric(unlist(x))
    y<- as.numeric(unlist(y))
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided") 
      test_res[i,j]<- res$p.value
    }else{
      res<- NA
      test_res[i,j]<-res
    }
  }
} 
rownames(test_res)<- drugs
colnames(test_res)<- colnames(cell_gbm_info_longer_v2)[index]
test_res<- cbind(test_res, sex, tmz,  mgmt)
```

```{r}
test_res_filter_1<- test_res< 0.05
#p-value for the MGMT promotor
test_res_filter_2<- test_res< 0.16795666
```

```{r}
gbm_candidate_prism_plot_two_groups <- function(cell_line_info, drug, info_index, divider= 0, group1="Normal", group2= "Mutation" ){
  
  #index_col <- grepl(colnames(cell_line_info), info)
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug == drug,]
  
  a <- ifelse(cell_gbm_info_longer_v2[,info_index] ==divider , 19, 17)
  cell_gbm_info_longer_v2$test <- ifelse(cell_gbm_info_longer_v2[,info_index] ==divider , group1, group2)
  #print(a)
  #nam <- colnames(cell_gbm_info_longer_v2)[info_index]
  #cell_gbm_info_longer_v2[,info_index]<- as.factor(cell_gbm_info_longer_v2[,info_index])
  #print(cell_gbm_info_longer_v2[,info_index])
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= test))+ geom_point(stat = "identity", shape = a, size = 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 
  #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, fill= test)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

  plot_grid(p1+ scale_fill_manual( values=c("#440154FF","#228C8DFF")), p2+ scale_color_manual( values= c("#440154FF","#228C8DFF") ), ncol = 1, align = "v")
  
}
```

```{r}
#pten pamidronate
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 12 )
```

```{r}
#Sex
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "vardenafil", 14, divider= "Male", group1="Male", group2= "Female")
```

```{r}
cell_gbm_info_longer_v2<- cell_gbm_info_longer_v2[,c(1:18, 20,21, 19)]
```

different p-value threshold because of low poer. DO NOT TRUST THIS DATA
```{r}
#"EGFR_copy"
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "diflunisal", 21, divider= "TMZ_RES", group1="TMZ Resistant", group2= "TMZ Sensitive")
```
if they are reistant to tmz it looks reistant here. 

```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "icosapent", 21, divider= "TMZ_RES", group1="TMZ Resistant", group2= "TMZ Sensitive")
```




```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "floxuridine", 19, divider= "Hyper methylation (>0.5)", group1="Hyper methylation (>0.5)", group2= "Hypo methylation (=< 0.5)")
```


```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 14, divider= "Male", group1="Male", group2= "Female")
```

```{r}
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "icosapent", 14, divider= "Male", group1="Male", group2= "Female")
```


```{r}
#pten 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 12 )
```


```{r}
#"TP53 (LFS1, p53) Mutation 22Q2 Public
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 3 )
```


```{r}
#"TP53 (LFS1, p53) Mutation 22Q2 Public
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "floxuridine", 3 )
```

```{r}
#"RB1 (PPP1R130, RB, OSRC) Mutation 22Q2 Public" 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 10 )
```

```{r}
#"RB1 (PPP1R130, RB, OSRC) Mutation 22Q2 Public" 
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 10 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "moxifloxacin", 11 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "pamidronate", 11 )
```
```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "temozolomide", 11 )
```

```{r}
#"MTOR (FRAP1, FLJ44809, RAPT1, RAFT1, FRAP, FRAP2) Mutation 22Q2 Public"   
gbm_candidate_prism_plot_two_groups(cell_gbm_info_longer_v2, "simvastatin", 11 )
```

linear regression stuff with methylation of MGMT and efgr amplication


```{r}
egfr_copy_p<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$`EGFR (ERBB1, ERBB) Copy Number 22Q2 Public` ),]
  #groups<- 
  test<- as.data.frame(cell_line_info[,c(5, 18)])
  res <- lm(log2change ~ `EGFR (ERBB1, ERBB) Copy Number 22Q2 Public`, test)
  egfr_copy_p[i]<- summary(res)$coefficients[,4][2] 
  
}
```


```{r}
mgmt_methy_p<- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug == drugs[i],]
  #test<- cell_line_info[,c(index[j], 18)]
  cell_line_info<- cell_line_info[!is.na(cell_line_info$`MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504` ),]
  #groups<- 
  test<- as.data.frame(cell_line_info[,c(2, 18)])
  res <- lm(log2change ~ `MGMT Methylation (1kb upstream TSS) MGMT_10_131264504_131265504`, test)
  mgmt_methy_p[i]<- summary(res)$coefficients[,4][2] 
  
}
```

```{r}
test_res <- cbind(test_res, egfr_copy_p, mgmt_methy_p)
```

```{r}
gbm_candidate_prism_plot_cont <- function(cell_line_info, drug, info_index, title ){
  
  #index_col <- grepl(colnames(cell_line_info), info)
  cell_gbm_info_longer_v2<- cell_line_info[cell_line_info$drug == drug,]


  nam <- colnames(cell_gbm_info_longer_v2)[info_index]
  #cell_gbm_info_longer_v2[,info_index]<- as.factor(cell_gbm_info_longer_v2[,info_index])
  #print(cell_gbm_info_longer_v2[,info_index])
  p2 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change, y= displayName, color= get(nam)))+ geom_point(stat = "identity", size= 4) +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3)+ labs(color=title) 
  #+ theme(axis.text.y = element_text( color = a))

  p1 <- ggplot(cell_gbm_info_longer_v2, aes(x=log2change)) + geom_density(alpha=.5) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)
  
  legend <- get_legend(p2)
  p2<- p2 + theme(legend.position='none')
  ggdraw(plot_grid(plot_grid(p1, p2, ncol=1, align='v'),
                 plot_grid(NULL, legend, ncol=1),
                 rel_widths=c(1, 0.2)))
  
}
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "moxifloxacin", 2, "MGMT Promoter Methylation(0-1)" )
```
```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "floxuridine", 2, "MGMT Promoter Methylation(0-1)" )
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "floxuridine", 5, "EGFR Copy Number" )
```

```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "moxifloxacin", 5, "EGFR Copy Number" )
```
```{r}
gbm_candidate_prism_plot_cont(cell_gbm_info_longer_v2, "nimodipine", 5, "EGFR Copy Number" )
```


change the tmz resistant test
compare the log2fold changes of the resistnat cells lines between drugs not within a drug. 
```{r}

cell_gbm_info_longer_v3<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$tmz_cell =="TMZ_RES", ]

tmz_v2 <- c()
for (i in 1:length(drugs)){
  cell_line_info<- cell_gbm_info_longer_v3[cell_gbm_info_longer_v3$drug %in% c(drugs[i], "temozolomide"),]
   #simvastain does have the A172 cell line so 
    # only keep cell lines with duplicated
  paired_cell_lines<- cell_line_info$displayName[duplicated(cell_line_info$displayName)]
  cell_line_info<- cell_line_info[cell_line_info$displayName %in% paired_cell_lines,]
  test<- as.vector(as.data.frame(cell_line_info[,17:18]))
  x<- test[test$drug  == drugs[i],2]
  y<- test[!test$drug ==  drugs[i],2]
  x<- as.numeric(unlist(x))
  y<- as.numeric(unlist(y))
   
    if(length(x) > 1 & length(y) > 1 ){
      res <- wilcox.test(x,y,alternative = "two.sided", paired = TRUE) 
       tmz_v2[i]<- res$p.value
    }else{
      print(i)
    }
    
}
```


```{r}
#replace the old tmz resistant p-values with the new p-values
colnames(test_res)
tmz_v2[1]<- 1 # for temzolomide
test_res[,7]<- tmz_v2
```



```{r}
#plot.data$stars <- cut(plot.data$p.value, breaks=c(-Inf, 0.001, 0.01, 0.05, Inf), label=c("***", "**", "*", "")) 
test_res_t <- t(test_res)
rownames(test_res_t)<- c("TP53 Mutation - Wilcox", "EGFR Mutation - Wilcox" , "RB1 Mutation - Wilcox", "MTOR Mutation - Wilcox", "PTEN Mutation - Wilcox", "Sex - Wilcox", "TMZ-Resistant - Wilcox Paired", "MGMT Promoter Methylation (high vs low) - Wilcox", "EGFR Copy Number - linear regression", "MGMT Promoter Methylation- linear regression"  )                                         
col_fun = colorRamp2(c(0,  1), c("blue", "white"))
Heatmap(test_res_t, nam= "p-value of biomarker and PRISM Drug Response", col = col_fun, column_names_rot = 45,
               clustering_distance_rows= "euclidean",
               clustering_distance_columns=  "euclidean",
               clustering_method_rows = "ward.D2" ,
               clustering_method_columns="ward.D2", 
        cell_fun = function(j, i, x, y, w, h, fill) {
        if(test_res_t[i, j] < 0.05) {
            grid.text("*", x, y)
        } else if(test_res_t[i, j] < 0.2) {
          grid.text("?", x, y)
      }})
```


top 5 

```{r}
cell_gbm_info_longer_v3<- cell_gbm_info_longer_v2[cell_gbm_info_longer_v2$drug %in% c(" pamidronate", "nimodipine", "moxifloxacin", "saxagliptin", "icosapent", "temozolomide"),]
```



```{r}
p2 <- ggplot(cell_gbm_info_longer_v3, aes(x=log2change, y= drug, color= drug))+ geom_point(stat = "identity") +theme_minimal() + xlab("PRISM Primary Screen log(fold change)") + ylab("GBM Cell Lines") + geom_vline(xintercept = 0.3) 

p1 <- ggplot(cell_gbm_info_longer_v3, aes(x=log2change, fill= drug)) + geom_density(alpha=.2) +theme_minimal() +  theme(
    axis.title.x = element_blank())+ geom_vline(xintercept = 0.3)

plot_grid(p1, p2, ncol = 1, align = "v")
```



make adjustment to the alluvial plot to plot with FDA approved or not 

download the compound info from LINCS
```{r}
lincs_commpound_info <- read.delim("~/data/LINCS_210914_LEVEL3/compoundinfo_beta.txt")
```

```{r}
#plotting drug target and mechanism of action for all candidate results
drug_moa_target_plotting_ct_info <- function(fda_approved_res, lincs_commpound_info=lincs_commpound_info, method, cancer, file_path_header ){
  #fda_approved_res- the signaturesearch results with only fda approved
  #lincs_commpound_info- the lincs compound info from the LINCS database
  #method- what method found these candidates
  #cancer- which cancer was this result for 
  #file_path_header- path and header for output files
  
  #output
  #several plots including alluvial and bar plots for the candidates
  file_starter<- paste0(file_path_header, "_", cancer, "_", method, "_", sep= "")
  
  test_fda <- fda_approved_res
  lincs_commpound_info[lincs_commpound_info$cmap_name %in% test_fda$pert,]
  
  summ_df <- as.data.frame(matrix(nrow=1, ncol=3))
  colnames(summ_df)<- c("Var1", "Var2", "Var3")
  for (i in 1:nrow(test_fda)){
    #get the target from the data results data frame
    targets1 <- as.vector(unlist(strsplit(test_fda$t_gn_sym[i], "; ")))
    
    targets2 <- lincs_commpound_info$target[lincs_commpound_info$cmap_name == test_fda$pert[i]]
    targets2<- ifelse(targets2 == "", NA, targets2)
    targets<- unique(c(targets1, targets2))
    
    moa <- unique(lincs_commpound_info$moa[lincs_commpound_info$cmap_name == test_fda$pert[i]])
    moa<- ifelse(moa == "", NA, moa)
    
    df<- expand.grid(test_fda$pert[i], targets, moa )
    
    summ_df<- rbind(summ_df, df)
    
  }
  

   summ_df<- summ_df[-1,]
   colnames(summ_df)<- c( "cmap_name", "target", "moa")
   
   summ_df<- summ_df[!duplicated(summ_df), ]
 #  return(summ_df)
#}   
  TEST_LODES<- to_lodes_form(as.data.frame(summ_df),
                             axes = 1:3,
                             id = "INDEX")

  TEST_LODES$stratum = str_wrap(TEST_LODES$stratum, width = 20)
  TEST_LODES$x <- factor(TEST_LODES$x, levels= c("moa", "cmap_name", "target"))

  TEST_LODES$drug <- rep(NA, nrow(summ_df))
  drugs<- unique(summ_df$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES$INDEX[TEST_LODES$stratum == drugs[i]]
    TEST_LODES$drug<- ifelse(TEST_LODES$INDEX %in% ind, drugs[i], TEST_LODES$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES$drug<- factor(TEST_LODES$drug, levels= test_fda$pert)

  #moa
  moa_df <- TEST_LODES[TEST_LODES$x == "moa", 2:4]
  moa_df<- moa_df[!duplicated(moa_df), ]
  counts<- as.data.frame(table(moa_df$stratum))

  #counts<- as.data.frame(table(TEST_LODES$stratum[TEST_LODES$x == "moa"]))
  moa_order <- counts$Var1[ order(-counts$Freq)]
  counts_moa<- counts
  #targets
  target_df <- TEST_LODES[TEST_LODES$x == "target", 2:4]
  target_df<- target_df[!duplicated(target_df), ]
  counts<- as.data.frame(table(target_df$stratum))
  #counts
  target_order <- counts$Var1[ order(-counts$Freq)]

  #factor the stratum column
  TEST_LODES$stratum<- factor(TEST_LODES$stratum, levels= unique(c(test_fda$pert, as.character(moa_order), as.character(target_order))))


  counts_moa_v2<- counts_moa[counts_moa$Freq >0,]
  counts_moa_v2$Var1<- factor(counts_moa_v2$Var1, levels= counts_moa_v2$Var1[order(-counts_moa_v2$Freq)])
  if (nrow(counts_moa_v2) < 20){
    ggplot(counts_moa_v2, aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Mechanism of Action") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))

    file_name<- paste0(file_starter, "_", "barplot_moa_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }else{
    counts_moa_v2<- counts_moa_v2[order(-counts_moa_v2$Freq),]
    ggplot(counts_moa_v2[1:20,], aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Mechanism of Action") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))

    file_name<- paste0(file_starter, "_", "barplot_moa_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }


  counts$Var1<- factor(counts$Var1, levels= counts$Var1[order(-counts$Freq)])
  if( nrow(counts)< 20 ){
    #counts$Var1<- factor(counts$Var1, levels= counts$Var1[order(-counts$Freq),])
    ggplot(counts, aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Targets") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))
    file_name<- paste0(file_starter, "_", "barplot_target_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }else{

    counts<- counts[order(-counts$Freq),]

    ggplot(counts[1:20,], aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Targets") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))
    file_name<- paste0(file_starter, "_", "barplot_target_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")



  }
  #add ploting function
  target_count <- counts


  #reduce to the top 20 drugs
  summ_df<- summ_df[summ_df$cmap_name %in% test_fda$pert[1:20],]

  summ_df_moa<- summ_df[,c(1,3)]
  summ_df_moa<- summ_df_moa[!duplicated(summ_df_moa), ]
  TEST_LODES_moa<- to_lodes_form(as.data.frame(summ_df_moa),
                                 axes = 1:2,
                                 id = "INDEX")

  TEST_LODES_moa$stratum = str_wrap(TEST_LODES_moa$stratum, width = 20)

  TEST_LODES_moa$drug <- rep(NA, nrow(summ_df_moa))
  drugs<- unique(summ_df_moa$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES_moa$INDEX[TEST_LODES_moa$stratum == drugs[i]]
    TEST_LODES_moa$drug<- ifelse(TEST_LODES_moa$INDEX %in% ind, drugs[i], TEST_LODES_moa$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES_moa$drug<- factor(TEST_LODES_moa$drug, levels= test_fda$pert)
  ct_drugs<- test_fda$pert[as.logical(unlist(test_fda[,17]))]
  TEST_LODES_moa$ct<- TEST_LODES_moa$drug %in% ct_drugs
  TEST_LODES_moa$ct<- factor(TEST_LODES_moa$ct, levels= c(TRUE, FALSE))
  #moa
  moa_df <- TEST_LODES_moa[TEST_LODES_moa$x == "moa", 2:4]
  moa_df<- moa_df[!duplicated(moa_df), ]
  counts<- as.data.frame(table(moa_df$stratum))

  #counts<- as.data.frame(table(TEST_LODES_moa$stratum[TEST_LODES_moa$x == "moa"]))
  moa_order <- counts$Var1[ order(-counts$Freq)]
  counts_moa<- counts

  #factor the stratum column
  TEST_LODES_moa$stratum<- factor(TEST_LODES_moa$stratum, levels= unique(c(test_fda$pert, as.character(moa_order))))

  TEST_LODES_moa_com <- TEST_LODES_moa[ complete.cases(TEST_LODES_moa),]
  #TEST_LODES_com$index2 <- as.numeric(TEST_LODES_com$drug)
  #TEST_LODES_com_v2 <- TEST_LODES_com[!TEST_LODES_com$x == "cmap_name",]

  ct2<-  TEST_LODES_moa_com$ct 
  ggplot(TEST_LODES_moa_com,
         aes(x = x, stratum = stratum, alluvium = INDEX, label= stratum, fill= ct))+ geom_flow(aes(fill=ct), stat = "alluvium", color= "black") + geom_stratum() +geom_label(stat = "stratum", fill="white",   size= 6 ,  face="bold") + theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks = element_blank(), legend.position="none", axis.text=element_text(size=25)) + scale_x_discrete(labels=c("cmap_name" = "Drug", "moa" = "Mechanism of Action")) +  scale_fill_manual(values=c("#0066CC", "#E0E0E0"))+ theme(text = element_text(size = 20,  face="bold"))

  file_name<- paste0(file_starter, "_", "alluvial_moa_v2.png")
  ggsave(file_name, width =10, height=20, units= "in")

  #add saving plot function

  summ_df_tar<- summ_df[,c(1,2)]
  #keep only the top targets
  summ_df_tar<- summ_df_tar[summ_df_tar[,2] %in% target_count$Var1[1:20], ]

  summ_df_tar<- summ_df_tar[!duplicated(summ_df_tar), ]
  TEST_LODES_tar<- to_lodes_form(as.data.frame(summ_df_tar),
                                 axes = 1:2,
                                 id = "INDEX")

  TEST_LODES_tar$stratum = str_wrap(TEST_LODES_tar$stratum, width = 20)

  TEST_LODES_tar$drug <- rep(NA, nrow(summ_df_tar))
  drugs<- unique(summ_df_tar$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES_tar$INDEX[TEST_LODES_tar$stratum == drugs[i]]
    TEST_LODES_tar$drug<- ifelse(TEST_LODES_tar$INDEX %in% ind, drugs[i], TEST_LODES_tar$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES_tar$drug<- factor(TEST_LODES_tar$drug, levels= test_fda$pert)
  TEST_LODES_tar$ct<- TEST_LODES_tar$drug %in% ct_drugs
  TEST_LODES_tar$ct<- factor(TEST_LODES_tar$ct, levels= c(TRUE, FALSE))
  #targets
  target_df <- TEST_LODES[TEST_LODES$x == "target", 2:4]
  target_df<- target_df[!duplicated(target_df), ]
  counts<- as.data.frame(table(target_df$stratum))
  #counts
  target_order <- counts$Var1[ order(-counts$Freq)]

  #factor the stratum column
  TEST_LODES_tar$stratum<- factor(TEST_LODES_tar$stratum, levels= unique(c(test_fda$pert, as.character(target_order))))

  TEST_LODES_tar_com <- TEST_LODES_tar[ complete.cases(TEST_LODES_tar),]
  #TEST_LODES_com$index2 <- as.numeric(TEST_LODES_com$drug)
  #TEST_LODES_com_v2 <- TEST_LODES_com[!TEST_LODES_com$x == "cmap_name",]
  cts<- c(TRUE, FALSE)
  ggplot(TEST_LODES_tar_com,
         aes(x = x, stratum = stratum, alluvium = INDEX, label= stratum, fill= ct))+ geom_flow( aes(fill= ct), stat = "alluvium", color= "black") +
    geom_stratum() +geom_label(stat = "stratum", fill="white",  size= 10,  face="bold") + theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks = element_blank(), legend.position="none", axis.text=element_text(size=25)) + scale_y_continuous(breaks=NULL) + scale_x_discrete(labels=c("cmap_name" = "Drug", "target" = "Targets")) +  scale_fill_viridis_d()+ theme(text = element_text(size = 20,  face="bold"))
  file_name<- paste0(file_starter, "_", "alluvial_target_v2.png")
  ggsave(file_name, width = 10, height=20, units= "in")
}


```


gbm
```{r}
lincs_limma_gbm_res_GI1_fda_approved<- read_csv( "~/output/limma_gbm/220808_SR_LINCS_GBM_top_RES_all.csv")
lincs_deseq2_gbm_res_GI1_fda_approved <- read_csv( "~/output/deseq2_gbm/220928_SR_LINCS_GBM_DESEQ2_RES_all.csv")
lincs_tfl_gbm_res_GI1_fda_approved <- read_csv( "~/output/TF_L_GBM/220808_SR_LINCS_GBM_top_RES_all.csv")
```

```{r}
drug_moa_target_plotting_ct_info(lincs_tfl_gbm_res_GI1_fda_approved ,lincs_commpound_info=lincs_commpound_info, "TLF", "GBM", "~/output/candidate_moa_target_plots/221117" )

#for limma and deseq2 there is inverse in the color for the plots going to adjust here via !
lincs_limma_gbm_res_GI1_fda_approved$GBM_CT<- !lincs_limma_gbm_res_GI1_fda_approved$GBM_CT
drug_moa_target_plotting_ct_info(lincs_limma_gbm_res_GI1_fda_approved ,lincs_commpound_info=lincs_commpound_info, "limma", "GBM", "~/output/candidate_moa_target_plots/221117" )
lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT<- !lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT
drug_moa_target_plotting_ct_info(lincs_deseq2_gbm_res_GI1_fda_approved ,lincs_commpound_info=lincs_commpound_info, "deseq2", "GBM", "~/output/candidate_moa_target_plots/221117" )

#fix the logical after plotting
lincs_limma_gbm_res_GI1_fda_approved$GBM_CT<- !lincs_limma_gbm_res_GI1_fda_approved$GBM_CT
lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT<- !lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT
```
PRISM plotting

```{r eval=FALSE}
prism_gbm_cell_lines <- read.csv("~/output/220808_prism_gbm_candidates.csv")
```

```{r}

non_fda_candidate_list<- c(lincs_tfl_gbm_res_GI1_fda_approved$pert[!lincs_tfl_gbm_res_GI1_fda_approved$clinical_trial_GBM], lincs_limma_gbm_res_GI1_fda_approved$pert[!lincs_limma_gbm_res_GI1_fda_approved$GBM_CT], lincs_deseq2_gbm_res_GI1_fda_approved$pert[!lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT])
non_fda_candidate_list<- unique(non_fda_candidate_list)
```


```{r eval=FALSE}
primary_gbm_res_sub <-prism_gbm_cell_lines[ prism_gbm_cell_lines$Var2 %in% non_fda_candidate_list,]
#write.csv(primary_gbm_res_sub , file= "~/output/TF_L_GBM/220808_prism_tfl_candidates_gbm.csv" )
```



```{r eval=FALSE}
drug_list <- as.vector(unique(primary_gbm_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_gbm_res_sub$Sensitive[primary_gbm_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)






drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity",  color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
#ggsave("~/output/TF_L_GBM/220808_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
  tfl_drugs1 <-lincs_tfl_gbm_res_GI1_fda_approved$pert[!lincs_tfl_gbm_res_GI1_fda_approved$clinical_trial_GBM] 
  deseq2_drugs1<- lincs_deseq2_gbm_res_GI1_fda_approved$pert[!lincs_deseq2_gbm_res_GI1_fda_approved$GBM_CT]
  limma_drugs1 <- lincs_limma_gbm_res_GI1_fda_approved$pert[!lincs_limma_gbm_res_GI1_fda_approved$GBM_CT]

  tfl_drugs <- grepl(paste(tfl_drugs1 ,collapse="|"), drug_senstive_precentage_all_drugs$drug_list) 
  deseq2_drugs<- grepl(paste(deseq2_drugs1,collapse="|"), drug_senstive_precentage_all_drugs$drug_list)
  limma_drugs <- grepl(paste(limma_drugs1 ,collapse="|"), drug_senstive_precentage_all_drugs$drug_list)
  
  #shared by all methods or two methods
  all_drugs <- tfl_drugs & deseq2_drugs & limma_drugs
  
  deseq_tfl <- tfl_drugs & deseq2_drugs 
  deseq_tfl<- ifelse(all_drugs ==TRUE, FALSE, deseq_tfl)
  
  deseq_limma <- limma_drugs & deseq2_drugs 
  deseq_limma <- ifelse(all_drugs ==TRUE, FALSE, deseq_limma )
  
  limma_tfl<- limma_drugs & tfl_drugs 
  limma_tfl <- ifelse(all_drugs ==TRUE, FALSE, limma_tfl )
  
  
  #only indivudal methods
  tfl<- setdiff(tfl_drugs1,  c(limma_drugs1, deseq2_drugs1) )
  tfl<- grepl(paste(tfl,collapse="|"), drug_senstive_precentage_all_drugs$drug_list)
  
  limma<- setdiff(limma_drugs1,  c(tfl_drugs1, deseq2_drugs1) )
  limma<- grepl(paste(limma,collapse="|"), drug_senstive_precentage_all_drugs$drug_list)
  
  deseq<- setdiff(deseq2_drugs1,  c(tfl_drugs1,limma_drugs1) )
  deseq<- grepl(paste(deseq,collapse="|"), drug_senstive_precentage_all_drugs$drug_list)
  
  
  #set groups for each node
  #this will match node color
  group <- rep(NA, length(tfl))
  group <- ifelse(tfl, "Transfer Learning", group)
  group <- ifelse(limma_tfl, "limma and Transfer Learning", group)
  group<- ifelse(limma, "limma", group)
  group<- ifelse(deseq_limma, "DESeq2 and limma", group)
  group<- ifelse(deseq, "DESeq2", group)
  group<- ifelse(deseq_tfl, "DESeq2 and Transfer Learning", group)
  group<- ifelse(all_drugs, "All Methods", group)
  
drug_senstive_precentage_all_drugs$method<- factor(group, levels= c("All Methods","DESeq2 and Transfer Learning",  "DESeq2","DESeq2 and limma", "limma", "limma and Transfer Learning", "Transfer Learning" ))

ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= method ))+ geom_bar(stat="identity",  color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "Method(s)")  +scale_fill_manual(values=c("All Methods"="#FDE725FF","DESeq2 and Transfer Learning" ="#8FD744FF", "DESeq2"="#35B779FF", "DESeq2 and limma"= "#21908CFF", "limma"= "#31688EFF", "limma and Transfer Learning"= "#443A83FF", "Transfer Learning" = "#440154FF"))+ geom_vline(xintercept = 0.75) + theme(text = element_text(size = 30,  face="bold"))
 ggsave("~/output/gbm_plots/221117_top_candidate_PRISM_plot.png", width = 15, height= 20) 
```


```{r}
#plotting drug target and mechanism of action for all candidate results
drug_moa_target_plotting_all_info <- function(fda_approved_res, lincs_commpound_info=lincs_commpound_info, method, cancer, file_path_header ){
  #fda_approved_res- the signaturesearch results with only fda approved
  #lincs_commpound_info- the lincs compound info from the LINCS database
  #method- what method found these candidates
  #cancer- which cancer was this result for 
  #file_path_header- path and header for output files
  
  #output
  #several plots including alluvial and bar plots for the candidates
  file_starter<- paste0(file_path_header, "_", cancer, "_", method, "_", sep= "")
  
  test_fda <- fda_approved_res
  lincs_commpound_info[lincs_commpound_info$cmap_name %in% test_fda$pert,]
  
  summ_df <- as.data.frame(matrix(nrow=1, ncol=3))
  colnames(summ_df)<- c("Var1", "Var2", "Var3")
  for (i in 1:nrow(test_fda)){
    #get the target from the data results data frame
    targets1 <- as.vector(unlist(strsplit(test_fda$t_gn_sym[i], "; ")))
    
    targets2 <- lincs_commpound_info$target[lincs_commpound_info$cmap_name == test_fda$pert[i,1]]
    targets2<- ifelse(targets2 == "", NA, targets2)
    targets<- unique(c(targets1, targets2))
    
    moa <- unique(lincs_commpound_info$moa[lincs_commpound_info$cmap_name == test_fda$pert[i,1]])
    moa<- ifelse(moa == "", NA, moa)
    
    df<- expand.grid(test_fda[i,1], targets, moa )
    
    summ_df<- rbind(summ_df, df)
    
  }
  

   summ_df<- summ_df[-1,]
   colnames(summ_df)<- c( "cmap_name", "target", "moa")
   
   summ_df<- summ_df[!duplicated(summ_df), ]
 #  return(summ_df)
#}   
  TEST_LODES<- to_lodes_form(as.data.frame(summ_df),
                             axes = 1:3,
                             id = "INDEX")

  TEST_LODES$stratum = str_wrap(TEST_LODES$stratum, width = 20)
  TEST_LODES$x <- factor(TEST_LODES$x, levels= c("moa", "cmap_name", "target"))

  TEST_LODES$drug <- rep(NA, nrow(summ_df))
  drugs<- unique(summ_df$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES$INDEX[TEST_LODES$stratum == drugs[i]]
    TEST_LODES$drug<- ifelse(TEST_LODES$INDEX %in% ind, drugs[i], TEST_LODES$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES$drug<- factor(TEST_LODES$drug, levels= test_fda$pert)

  #moa
  moa_df <- TEST_LODES[TEST_LODES$x == "moa", 2:4]
  moa_df<- moa_df[!duplicated(moa_df), ]
  counts<- as.data.frame(table(moa_df$stratum))

  #counts<- as.data.frame(table(TEST_LODES$stratum[TEST_LODES$x == "moa"]))
  moa_order <- counts$Var1[ order(-counts$Freq)]
  counts_moa<- counts
  #targets
  target_df <- TEST_LODES[TEST_LODES$x == "target", 2:4]
  target_df<- target_df[!duplicated(target_df), ]
  counts<- as.data.frame(table(target_df$stratum))
  #counts
  target_order <- counts$Var1[ order(-counts$Freq)]

  #factor the stratum column
  TEST_LODES$stratum<- factor(TEST_LODES$stratum, levels= unique(c(test_fda$pert, as.character(moa_order), as.character(target_order))))


  counts_moa_v2<- counts_moa[counts_moa$Freq >0,]
  counts_moa_v2$Var1<- factor(counts_moa_v2$Var1, levels= counts_moa_v2$Var1[order(-counts_moa_v2$Freq)])
  if (nrow(counts_moa_v2) < 20){
    ggplot(counts_moa_v2, aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Mechanism of Action") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))

    file_name<- paste0(file_starter, "_", "barplot_moa_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }else{
    counts_moa_v2<- counts_moa_v2[order(-counts_moa_v2$Freq),]
    ggplot(counts_moa_v2[1:20,], aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Mechanism of Action") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))

    file_name<- paste0(file_starter, "_", "barplot_moa_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }


  counts$Var1<- factor(counts$Var1, levels= counts$Var1[order(-counts$Freq)])
  if( nrow(counts)< 20 ){
    #counts$Var1<- factor(counts$Var1, levels= counts$Var1[order(-counts$Freq),])
    ggplot(counts, aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Targets") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))
    file_name<- paste0(file_starter, "_", "barplot_target_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")
  }else{

    counts<- counts[order(-counts$Freq),]

    ggplot(counts[1:20,], aes(x= Freq, y= Var1)) + geom_bar(stat= "identity", fill="deepskyblue4", color= "black") + ylab("Targets") + xlab("Number of Drugs")+ theme(text = element_text(size = 20,  face="bold"))
    file_name<- paste0(file_starter, "_", "barplot_target_v2.png")
    ggsave(file_name, width = 8, height=10, units= "in")



  }
  #add ploting function
  target_count <- counts


  #reduce to the top 20 drugs
  summ_df<- summ_df[summ_df$cmap_name %in% test_fda$pert[1:20],]

  summ_df_moa<- summ_df[,c(1,3)]
  summ_df_moa<- summ_df_moa[!duplicated(summ_df_moa), ]
  TEST_LODES_moa<- to_lodes_form(as.data.frame(summ_df_moa),
                                 axes = 1:2,
                                 id = "INDEX")

  TEST_LODES_moa$stratum = str_wrap(TEST_LODES_moa$stratum, width = 20)

  TEST_LODES_moa$drug <- rep(NA, nrow(summ_df_moa))
  drugs<- unique(summ_df_moa$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES_moa$INDEX[TEST_LODES_moa$stratum == drugs[i]]
    TEST_LODES_moa$drug<- ifelse(TEST_LODES_moa$INDEX %in% ind, drugs[i], TEST_LODES_moa$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES_moa$drug<- factor(TEST_LODES_moa$drug, levels= test_fda$pert)
  ct_drugs<- test_fda$pert[as.logical(unlist(test_fda[,17]))]
  TEST_LODES_moa$ct<- TEST_LODES_moa$drug %in% ct_drugs
  TEST_LODES_moa$ct<- factor(TEST_LODES_moa$ct, levels= c(TRUE, FALSE))
  #moa
  moa_df <- TEST_LODES_moa[TEST_LODES_moa$x == "moa", 2:4]
  moa_df<- moa_df[!duplicated(moa_df), ]
  counts<- as.data.frame(table(moa_df$stratum))

  #counts<- as.data.frame(table(TEST_LODES_moa$stratum[TEST_LODES_moa$x == "moa"]))
  moa_order <- counts$Var1[ order(-counts$Freq)]
  counts_moa<- counts

  #factor the stratum column
  TEST_LODES_moa$stratum<- factor(TEST_LODES_moa$stratum, levels= unique(c(test_fda$pert, as.character(moa_order))))

  TEST_LODES_moa_com <- TEST_LODES_moa[ complete.cases(TEST_LODES_moa),]
  #TEST_LODES_com$index2 <- as.numeric(TEST_LODES_com$drug)
  #TEST_LODES_com_v2 <- TEST_LODES_com[!TEST_LODES_com$x == "cmap_name",]

  ct2<-  TEST_LODES_moa_com$ct 
  ggplot(TEST_LODES_moa_com,
         aes(x = x, stratum = stratum, alluvium = INDEX, label= stratum, fill= ct))+ geom_flow(aes(fill=ct), stat = "alluvium", color= "black") + geom_stratum() +geom_label(stat = "stratum", fill="white",   size= 6 ,  face="bold") + theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks = element_blank(), legend.position="none", axis.text=element_text(size=25)) + scale_x_discrete(labels=c("cmap_name" = "Drug", "moa" = "Mechanism of Action")) +  scale_fill_manual(values=c("#0066CC", "#E0E0E0"))+ theme(text = element_text(size = 20,  face="bold"))

  file_name<- paste0(file_starter, "_", "alluvial_moa_v2.png")
  ggsave(file_name, width =10, height=20, units= "in")

  #add saving plot function

  summ_df_tar<- summ_df[,c(1,2)]
  #keep only the top targets
  summ_df_tar<- summ_df_tar[summ_df_tar[,2] %in% target_count$Var1[1:20], ]

  summ_df_tar<- summ_df_tar[!duplicated(summ_df_tar), ]
  TEST_LODES_tar<- to_lodes_form(as.data.frame(summ_df_tar),
                                 axes = 1:2,
                                 id = "INDEX")

  TEST_LODES_tar$stratum = str_wrap(TEST_LODES_tar$stratum, width = 20)

  TEST_LODES_tar$drug <- rep(NA, nrow(summ_df_tar))
  drugs<- unique(summ_df_tar$cmap_name)
  for (i in 1:length(drugs)){
    ind <- TEST_LODES_tar$INDEX[TEST_LODES_tar$stratum == drugs[i]]
    TEST_LODES_tar$drug<- ifelse(TEST_LODES_tar$INDEX %in% ind, drugs[i], TEST_LODES_tar$drug)
  }

  #not need for this analysis but many for future.
  TEST_LODES_tar$drug<- factor(TEST_LODES_tar$drug, levels= test_fda$pert)
  TEST_LODES_tar$ct<- TEST_LODES_tar$drug %in% ct_drugs
  TEST_LODES_tar$ct<- factor(TEST_LODES_tar$ct, levels= c(TRUE, FALSE))
  #targets
  target_df <- TEST_LODES[TEST_LODES$x == "target", 2:4]
  target_df<- target_df[!duplicated(target_df), ]
  counts<- as.data.frame(table(target_df$stratum))
  #counts
  target_order <- counts$Var1[ order(-counts$Freq)]

  #factor the stratum column
  TEST_LODES_tar$stratum<- factor(TEST_LODES_tar$stratum, levels= unique(c(test_fda$pert, as.character(target_order))))

  TEST_LODES_tar_com <- TEST_LODES_tar[ complete.cases(TEST_LODES_tar),]
  #TEST_LODES_com$index2 <- as.numeric(TEST_LODES_com$drug)
  #TEST_LODES_com_v2 <- TEST_LODES_com[!TEST_LODES_com$x == "cmap_name",]
  cts<- c(TRUE, FALSE)
  ggplot(TEST_LODES_tar_com,
         aes(x = x, stratum = stratum, alluvium = INDEX, label= stratum, fill= ct))+ geom_flow( aes(fill= ct), stat = "alluvium", color= "black") +
    geom_stratum() +geom_label(stat = "stratum", fill="white",  size= 10,  face="bold") + theme_bw() + theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks = element_blank(), legend.position="none", axis.text=element_text(size=25)) + scale_y_continuous(breaks=NULL) + scale_x_discrete(labels=c("cmap_name" = "Drug", "target" = "Targets")) +  scale_fill_viridis_d()+ theme(text = element_text(size = 20,  face="bold"))
  file_name<- paste0(file_starter, "_", "alluvial_target_v2.png")
  ggsave(file_name, width = 10, height=20, units= "in")
}


```


```{r}
gbm_drugs <- unique(c(lincs_limma_gbm_res_GI1_fda_approved$pert, lincs_deseq2_gbm_res_GI1_fda_approved$pert, lincs_tfl_gbm_res_GI1_fda_approved$pert))
```


```{r}
  limma_rank <-rep(NA, length(gbm_drugs))
  deseq2_rank<-rep(NA, length(gbm_drugs))
  tfl_rank<-rep(NA, length(gbm_drugs))
for (i in 1:length(gbm_drugs)){
  if(length(grep(gbm_drugs[i], lincs_limma_gbm_res_GI1_fda_approved$pert)) == 1){
    limma_rank[i] <-grep(gbm_drugs[i], lincs_limma_gbm_res_GI1_fda_approved$pert)
  }else{
    limma_rank[i] <- NA
  }
  if(length(grep(gbm_drugs[i], lincs_deseq2_gbm_res_GI1_fda_approved$pert)) == 1){
    deseq2_rank[i] <-grep(gbm_drugs[i], lincs_deseq2_gbm_res_GI1_fda_approved$pert)
  }else{
    deseq2_rank[i] <-NA
  }
  if( length(grep(gbm_drugs[i], lincs_tfl_gbm_res_GI1_fda_approved$pert)) == 1){
    tfl_rank[i] <-grep(gbm_drugs[i], lincs_tfl_gbm_res_GI1_fda_approved$pert)
  }else{
    tfl_rank[i] <-NA
  }
}

```

```{r}
method_ranks<- cbind(limma_rank, deseq2_rank, tfl_rank)
drug_ranks<- rowMedians(method_ranks,na.rm= TRUE)
```

```{r}
  tfl_drugs1 <-lincs_tfl_gbm_res_GI1_fda_approved$pert
  deseq2_drugs1<- lincs_deseq2_gbm_res_GI1_fda_approved$pert
  limma_drugs1 <- lincs_limma_gbm_res_GI1_fda_approved$pert

  tfl_drugs <- grepl(paste(tfl_drugs1 ,collapse="|"), gbm_drugs) 
  deseq2_drugs<- grepl(paste(deseq2_drugs1,collapse="|"), gbm_drugs)
  limma_drugs <- grepl(paste(limma_drugs1 ,collapse="|"), gbm_drugs)
  
  #shared by all methods or two methods
  all_drugs <- tfl_drugs & deseq2_drugs & limma_drugs
  
  deseq_tfl <- tfl_drugs & deseq2_drugs 
  deseq_tfl<- ifelse(all_drugs ==TRUE, FALSE, deseq_tfl)
  
  deseq_limma <- limma_drugs & deseq2_drugs 
  deseq_limma <- ifelse(all_drugs ==TRUE, FALSE, deseq_limma )
  
  limma_tfl<- limma_drugs & tfl_drugs 
  limma_tfl <- ifelse(all_drugs ==TRUE, FALSE, limma_tfl )
  
  
  #only indivudal methods
  tfl<- setdiff(tfl_drugs1,  c(limma_drugs1, deseq2_drugs1) )
  tfl<- grepl(paste(tfl,collapse="|"), gbm_drugs)
  
  limma<- setdiff(limma_drugs1,  c(tfl_drugs1, deseq2_drugs1) )
  limma<- grepl(paste(limma,collapse="|"), gbm_drugs)
  
  deseq<- setdiff(deseq2_drugs1,  c(tfl_drugs1,limma_drugs1) )
  deseq<- grepl(paste(deseq,collapse="|"), gbm_drugs)
  
  
  #set groups for each node
  #this will match node color
  group <- rep(NA, length(tfl))
  group <- ifelse(tfl, "Transfer Learning", group)
  group <- ifelse(limma_tfl, "limma and Transfer Learning", group)
  group<- ifelse(limma, "limma", group)
  group<- ifelse(deseq_limma, "DESeq2 and limma", group)
  group<- ifelse(deseq, "DESeq2", group)
  group<- ifelse(deseq_tfl, "DESeq2 and Transfer Learning", group)
  group<- ifelse(all_drugs, "All Methods", group)
  
```


```{r eval=FALSE}
clinical_trial_GBM <- read_csv("~/data/SearchResults.csv")
```

```{r}
all_cand<- data.frame(gbm_drugs, drug_ranks, group)
```

clinical_trial_check
```{r eval=FALSE}
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")

all_cand$ct <- clinical_trial_check(as.character(all_cand$gbm_drugs), clinical_trial_GBM)
```

```{r}

```



### Save Data
### Save Figures
NA
    
# END
    Location of final scripts:
    /script
    
    Location of data produced:
    na
    
    Dates when operations were done:
    220901
    
## Versions
```{r}
sessionInfo()
```
