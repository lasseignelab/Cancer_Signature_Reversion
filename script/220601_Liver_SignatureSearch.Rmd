---
title: "220601_Liver_SignatureSearch"
author: "Jennifer Fisher"
date: "6/1/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    Determine disease signatures for all the methods and conduct Signature Reversion on liver samples for all three approaches 
    
    Finished psedocode on:
    220606
    
    System which operations were done on: 
    my laptop
    
    GitHub Repo:
    Transfer_Learning_R03
    
    Docker/Singularity: 
    rstudio_cancer_dr
    
    Directory of operations: 
    /home/rstudio
    
    Scripts being edited for operations: filename(s)
    ./script/functions_cancer_signature_reversion_JLF.R- contains all the functions for this project. 
    
    Data being used: description and location
    
    Papers and tools:
    DESeq2
    limma
    SignatureSearch
    MultiPLIER

# STEPS
### Set working directory 
### load in data
```{r}
library(recount3)
library(SummarizedExperiment)
source("/home/rstudio/script/functions_cancer_signature_reversion_JLF.R")
library(signatureSearch)
library(HDF5Array)
library(viridis)
library(tidyr)
library(gprofiler2)
library(ggplot2)
library(ggpubr)
library(VennDiagram)
library(ComplexHeatmap)
library(dplyr)
library(gplots)
library(circlize)
source("~/script/plier_util.R")
source("~/script/test_LV_differences.R")
library(dplyr)
```

```{r}
liver_gtex_count_ordered <- readRDS("~/data/liver_gtex_count_ordered.rds")
liver_gtex_metadata_ordered <- readRDS("~/data/liver_gtex_metadata_ordered.rds")
lihc_tcga_count_ordered <- readRDS("~/data/lihc_tcga_count_ordered.rds")
lihc_tcga_metadata_ordered <- readRDS("~/data/lihc_tcga_metadata_ordered.rds")
```

```{r}
colnames(lihc_tcga_count_ordered)<- lihc_tcga_metadata_ordered$external_id
```

liver cancer vs normal 
things to add to metadata- database, tumor/normal, subtype, sex

```{r}
#order the tcga data to match recount3 order
ids <- lihc_tcga_metadata_ordered$external_id

nam <- c()
status<- c()
sex<- c()
for (i in 1:length(ids)){
  
nam[i]<- ids[i]
#create tumor/normal col
status[i] <- lihc_tcga_metadata_ordered$cgc_sample_sample_type[lihc_tcga_metadata_ordered$external_id == ids[i]]
#create sex col 
sex[i]<- lihc_tcga_metadata_ordered$cgc_case_gender[lihc_tcga_metadata_ordered$external_id== ids[i]]
}
#create database col
database <- rep("TCGA", length(sex))
#create metadata 
tcga_lihc_metadata<- as.data.frame(cbind(nam, database, status,  sex))
rownames(tcga_lihc_metadata) <- ids
tcga_lihc_metadata[1:5,]
```
```{r}
#order the metadata to match recount3 order
#create sex col 
identical (liver_gtex_metadata_ordered$external_id, colnames( liver_gtex_count_ordered))
nam<- liver_gtex_metadata_ordered$external_id
sex<- ifelse(liver_gtex_metadata_ordered$SEX == 1, "male", "female")
#create database col
database<- rep ("GTEx",length(sex) )
#create normal col
status<- rep ("Solid Tissue Normal", length(sex))
#create metadata 
gtex_metadata<- as.data.frame(cbind(nam, database, status, sex))
rownames(gtex_metadata)<- liver_gtex_metadata_ordered$external_id
#combine count and metadata
gtex_metadata[1:5,]
```

```{r}
all_metadata <- rbind(tcga_lihc_metadata, gtex_metadata)
rownames(all_metadata)<- c(rownames(tcga_lihc_metadata), rownames(gtex_metadata))
count_table<- cbind(lihc_tcga_count_ordered, liver_gtex_count_ordered)
```

```{r}
identical(rownames(all_metadata), colnames(count_table))
```


```{r}
library(signatureSearch)
library(HDF5Array)
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
```


```{r}
# remove the sample with the high gene counts 
count_table_v2 <- count_table[,!colnames(count_table) == "GTEX-WK11-1326-SM-4OOSI.1"]
all_metadata_v2 <- all_metadata[!rownames(all_metadata) == "GTEX-WK11-1326-SM-4OOSI.1",]
```

```{r}
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
```

```{r}
db_path <- "~/data/lincs_2020.h5"
```

remove recurrent tumors
```{r}
all_metadata_v3<- all_metadata_v2[!all_metadata_v2$status == "Recurrent Tumor",]
count_table_v3<- count_table_v2[, !all_metadata_v2$status == "Recurrent Tumor"]
```

```{r}
saveRDS(count_table_v3, "~/output/liver_cancer/liver_count_table_filtered.rds")
saveRDS(all_metadata_v3, "~/output/liver_cancer/liver_all_metadata_filtered.rds" )
```

### Analysis
#### Deseq2
deseq2 with raw counts
DESEq2 (make into a function )

```{r}
library(DESeq2)
```

```{r eval=FALSE}
dds_lihc_normal <- DESeqDataSetFromMatrix(countData = count_table_v3,
                              colData = all_metadata_v3,
                              design= ~ database + status)
```


```{r eval=FALSE}
deseq2_lihc_normal <- deseq2_function(dds_lihc_normal, "~/output/liver_cancer/deseq2_res/220929_deseq2_lihc_normal_gtx_res.csv", "status", "Primary Tumor", "Solid Tissue Normal")
```

signaturesearch 
Genes
```{r}
feature_info <- readRDS("~/data/recount3/recount3_fix_download/feature_info.rds")
```

```{r eval=FALSE}
identical(feature_info$gene_id, rownames(deseq2_lihc_normal))
```

```{r eval=FALSE}
deseq2_lihc_normal$Symbol<- feature_info$gene_name
```

```{r eval=FALSE}
deseq2_lihc_normal<- deseq2_lihc_normal[complete.cases(deseq2_lihc_normal),]
deseq_results_sig_top <- deseq2_lihc_normal[deseq2_lihc_normal$padj < 0.05 & deseq2_lihc_normal$log2FoldChange > 2,]
deseq_results_sig_bottom <- deseq2_lihc_normal[deseq2_lihc_normal$padj < 0.05 & deseq2_lihc_normal$log2FoldChange < -2,]
```

```{r eval=FALSE}
downset<- deseq_results_sig_bottom$Symbol[deseq_results_sig_bottom$log2FoldChange< -4]
upset<- deseq_results_sig_top$Symbol[deseq_results_sig_top$log2FoldChange > 4] 
```


convert gene symbols to LINCS genes
```{r eval=FALSE}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```


```{r eval=FALSE}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r eval=FALSE}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```


```{r eval=FALSE}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval=FALSE}
deseq2_liver_list<- list(up= upset_v2, down= downset_v2)
```

```{r eval=FALSE}
saveRDS(deseq2_liver_list,"~/output/liver_cancer/deseq2_res/SR_gene_list_liver_deseq2.rds")
```



```{r eval=FALSE}
set.seed(101)
qsig_lincs_deseq2_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```


```{r eval=FALSE}
set.seed(101)
lincs_deseq_gbm <- gess_lincs(qsig_lincs_deseq2_res, sortby="NCS", workers=1)
#result(lincs)
```



```{r eval=FALSE}
lincs_deseq_lihc_res <- result(lincs_deseq_gbm)
```

```{r eval=FALSE}
write.csv(lincs_deseq_lihc_res, file= "~/output/liver_cancer/deseq2_res/220929_SR_LINCS_LIHC_DESEQ2_RES.csv" )
```

```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2 <- lincs_deseq_lihc_res[lincs_deseq_lihc_res$cell == "HEPG2",]
```
tau 
```{r eval=FALSE}
HEPG2_taudf <- readRDS("~/data/HEPG2_taudf.rds")
```

```{r eval=FALSE}
tau_test<- tau_scores(lincs_deseq_lihc_res_HEPG2 , HEPG2_taudf)
```

```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2$jlf_tau<- tau_test
```

```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2_top <- lincs_deseq_lihc_res_HEPG2[lincs_deseq_lihc_res_HEPG2$NCS < 0 & lincs_deseq_lihc_res_HEPG2$WTCS_FDR < 0.05 & lincs_deseq_lihc_res_HEPG2$jlf_tau< -80,]
```

clinical trials

```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_deseq_lihc_res_HEPG2_top$pert)
```


```{r eval=FALSE}
library(readr)
clinical_trial_LIHC <- read_tsv("~/data/SearchResults_LIHC.tsv")
```

```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2_top$clinical_trial_LIHC <- clinical_trial_check(lincs_deseq_lihc_res_HEPG2_top$pert, clinical_trial_LIHC)
```



```{r eval=FALSE}
lincs_deseq_lihc_res_HEPG2_top_fda<- lincs_deseq_lihc_res_HEPG2_top[lincs_deseq_lihc_res_HEPG2_top$fda_approved,]
#lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC<- ifelse(lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC, "star", "")

lincs_deseq_lihc_res_HEPG2_top_fda_order <- lincs_deseq_lihc_res_HEPG2_top_fda[order(-lincs_deseq_lihc_res_HEPG2_top_fda$NCS),]
lincs_deseq_lihc_res_HEPG2_top_fda$pert <- factor(lincs_deseq_lihc_res_HEPG2_top_fda$pert, levels = lincs_deseq_lihc_res_HEPG2_top_fda_order$pert)
p<-ggplot(data=lincs_deseq_lihc_res_HEPG2_top_fda, aes(x=pert, y=NCS, fill=jlf_tau, shape= clinical_trial_LIHC)) +
  geom_bar(stat="identity")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_tau_lihc_approved_candidates.png")
```
```{r}
knitr::include_graphics("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_tau_lihc_approved_candidates.png")
```

```{r eval=FALSE}
#lincs_deseq_lihc_res_HEPG2_top 
write.csv(lincs_deseq_lihc_res_HEPG2_top , file= "~/output/liver_cancer/deseq2_res/220929_SR_LINCS_LIHC_DESEQ2_RES_tau.csv" )
```

LINCS pathway & Drug targets

```{r eval=FALSE}
tpm_table<- Counts_to_tpm(count_table_v3, feature_info$bp_length)
```

```{r eval=FALSE}
rownames(tpm_table)<- feature_info$gene_name
```

```{r eval=FALSE}
tpm_df <- as.data.frame(tpm_table)
```

```{r eval=FALSE}
se_asssay<- assay(se)
```


PRISM

```{r eval=FALSE}
primary_lihc_res <-read.csv( file= "~/output/liver_cancer/220808_prism_candidates.csv" )
```

```{r eval=FALSE}
primary_lihc_res_sub <-primary_lihc_res[ primary_lihc_res$Var2 %in% lincs_deseq_lihc_res_HEPG2_top_fda$pert,]
```


```{r eval=FALSE}
write.csv(primary_lihc_res_sub , file= "~/output/liver_cancer/deseq2_res/220929_prism_deseq2_candidates.csv" )
```

```{r eval=FALSE}
primary_lihc_res_sub$Var2 <- factor(primary_lihc_res_sub$Var2, levels=unique(primary_lihc_res_sub$Var2[order(-primary_lihc_res_sub$log_fold_change)]))
ggplot(primary_lihc_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() +geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_candidates_prism_screen1.png")
```
```{r}
knitr::include_graphics("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_candidates_prism_screen1.png")
```

```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res_sub$Sensitive[primary_lihc_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity", color = "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_candidates_prism_screen1_sensitive_cell_lines.png")
```
```{r}
knitr::include_graphics("~/output/liver_cancer/deseq2_res/220929_ggplot_deseq2_candidates_prism_screen1_sensitive_cell_lines.png")
```


```{r eval=FALSE}
len<- length(lincs_deseq_lihc_res_HEPG2_top_fda$pert)
num_clin <- nrow(lincs_deseq_lihc_res_HEPG2_top_fda[lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC == TRUE,])
fract<- num_clin/len
deseq2_CT_test_res <- clinical_trial_testing(101, "HEPG2", len, fract, clinical_trial_LIHC)
```


```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res$Sensitive[primary_lihc_res$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
```

```{r eval=FALSE}
deseq2_PRISM_test<- PRISM_testing(101,"HEPG2", lincs_deseq_lihc_res_HEPG2_top_fda$pert, drug_senstive_precentage_all_drugs)
```
```{r eval=FALSE}
deseq2_PRISM_test
```


#### limma
limma with tpm counts
normalize count data by tpm

```{r eval=FALSE}
TPM <- log2(as.matrix(tpm_df) + 1)
```


LVTestWrapperJLF <- function(b.matrix,
                          sample.info.df,
                          phenotype.col,
                          blocking,
                          file.lead,
                          plot.dir = "plots",
                          results.dir = "results",
                          use.bonferroni = FALSE,
                          significant.only = FALSE,
                          sig.threshold = 0.05)
```{r eval=FALSE}
sampleinfo<- cbind(colnames(TPM), as.character(all_metadata_v3$status), as.character(all_metadata_v3$database))
colnames(sampleinfo) <- c("Sample", "Tumor","database")
sampleinfo<- as.data.frame(sampleinfo)
database<- all_metadata_v3$database
names(database)<- colnames(TPM)

limma_gene_TCGA_BH <- LVTestWrapperJLF_v2(b.matrix=TPM , sample.info.df= sampleinfo, phenotype.col= "Tumor", blocking= database, file.lead= "220808_limma_TCGA_GTEX_T_vs_NT_liver_cancer", plot.dir= "~/output/liver_cancer/limma_res", results.dir= "~/output/liver_cancer/limma_res/", use.bonferroni= FALSE, sig.threshold = 0.05)
```


```{r eval=FALSE}
saveRDS(limma_gene_TCGA_BH , file= "~/output/liver_cancer/limma_res/220808_LIHC_GTEX_gene_limma_res.rds")
```

signaturesearch 

```{r eval=FALSE}
limma_res <- limma_gene_TCGA_BH$limma
```

```{r eval=FALSE}
limma_results<- limma_res[complete.cases(limma_res),]
limma_results_sig <- limma_results[limma_results$adj.P.Val < 0.05 & abs(limma_results$logFC) > 1.8,]
```

```{r eval=FALSE}
downset<- limma_results_sig$LV[ limma_results_sig$logFC < -1.8]
upset<- limma_results_sig$LV[limma_results_sig$logFC > 1.8]
```


convert gene symbols to LINCS genes
```{r eval=FALSE}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```

```{r eval=FALSE}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r eval=FALSE}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```

```{r eval=FALSE}
length(downset_v2)
length(upset_v2)
```

```{r eval=FALSE}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval=FALSE}
limma_liver_list<- list(up= upset_v2, down= downset_v2)
```

```{r eval=FALSE}
saveRDS(limma_liver_list,"~/output/liver_cancer/limma_res/SR_gene_list_liver_limma.rds")
```

```{r eval=FALSE}
set.seed(101)
qsig_lincs_limma_liver_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```


```{r eval=FALSE}
set.seed(101)
library(parallel)
lincs_limma_liver <- gess_lincs(qsig_lincs_limma_liver_res, sortby="NCS", tau=FALSE,workers=2)
#result(lincs)
```

```{r eval=FALSE}
lincs_limma_liver_res <- result(lincs_limma_liver)
```

```{r eval=FALSE}
write.csv(lincs_limma_liver_res, file= "~/output/liver_cancer/220808_SR_LINCS_LIVER_LIMMA_RES.csv" )
```

```{r eval=FALSE}
lincs_limma_liver_res_HEPG2 <- lincs_limma_liver_res[lincs_limma_liver_res$cell == "HEPG2",]
```
tau 
```{r eval=FALSE}
tau_test<- tau_scores(lincs_limma_liver_res_HEPG2, HEPG2_taudf)
```

```{r eval=FALSE}
lincs_limma_liver_res_HEPG2$jlf_tau<- tau_test
```

```{r eval=FALSE}
write.csv(lincs_limma_liver_res_HEPG2, file= "~/output/liver_cancer/limma_res/220808_lincs_limma_liver_res_HEPG2_tau.csv" )
```

```{r eval=FALSE}
lincs_limma_liver_res_HEPG2_top <- lincs_limma_liver_res_HEPG2[lincs_limma_liver_res_HEPG2$NCS < 0 & lincs_limma_liver_res_HEPG2$WTCS_FDR < 0.05 & lincs_limma_liver_res_HEPG2$jlf_tau< -80,]
```

clinical trials

```{r eval=FALSE}
lincs_limma_liver_res_HEPG2_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_limma_liver_res_HEPG2_top$pert)
```


```{r eval=FALSE}
lincs_limma_liver_res_HEPG2_top$clinical_trial_LIHC <- clinical_trial_check(lincs_limma_liver_res_HEPG2_top$pert, clinical_trial_LIHC)
```


```{r eval=FALSE}
lincs_limma_liver_res_HEPG2_top_fda<- lincs_limma_liver_res_HEPG2_top[lincs_limma_liver_res_HEPG2_top$fda_approved,]
#lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC<- ifelse(lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC, "star", "")

lincs_limma_liver_res_HEPG2_top_fda_order <- lincs_limma_liver_res_HEPG2_top_fda[order(-lincs_limma_liver_res_HEPG2_top_fda$NCS),]
lincs_limma_liver_res_HEPG2_top_fda$pert <- factor(lincs_limma_liver_res_HEPG2_top_fda$pert, levels = lincs_limma_liver_res_HEPG2_top_fda_order$pert)
p<-ggplot(data=lincs_limma_liver_res_HEPG2_top_fda, aes(x=pert, y=NCS, fill=jlf_tau, shape= clinical_trial_LIHC)) +
  geom_bar(stat="identity", color= "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/liver_cancer/limma_res/220808_ggplot_limma_tau_lihc_approved_candidates.png")
```

```{r}
knitr::include_graphics("~/output/liver_cancer/limma_res/220808_ggplot_limma_tau_lihc_approved_candidates.png")
```


```{r eval=FALSE}
#lincs_deseq_lihc_res_HEPG2_top 
write.csv(lincs_limma_liver_res_HEPG2_top , file= "~/output/liver_cancer/limma_res/220808_SR_LINCS_LIHC_limma_RES_tau.csv" )
```


PRISM

```{r eval=FALSE}
primary_lihc_res_sub <-primary_lihc_res[ primary_lihc_res$Var2 %in% lincs_limma_liver_res_HEPG2_top_fda$pert,]
```


```{r eval=FALSE}
write.csv(primary_lihc_res_sub , file= "~/output/liver_cancer/limma_res/220808_prism_limma_candidates.csv" )
```

```{r eval=FALSE}
primary_lihc_res_sub$Var2 <- factor(primary_lihc_res_sub$Var2, levels=unique(primary_lihc_res_sub$Var2[order(-primary_lihc_res_sub$log_fold_change)]))
#primary_lihc_res_sub$Var2 <- factor(primary_lihc_res_sub$Var2, levels=unique(primary_lihc_res_sub$Var2))
ggplot(primary_lihc_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() +geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/liver_cancer/limma_res/220808_ggplot_limma_candidates_prism_screen1.png")
```
```{r}
knitr::include_graphics("~/output/liver_cancer/limma_res/220808_ggplot_limma_candidates_prism_screen1.png")
```

```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res_sub$Sensitive[primary_lihc_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity", color= "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/liver_cancer/limma_res/220808_ggplot_limma_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
knitr::include_graphics("~/output/liver_cancer/limma_res/220808_ggplot_limma_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res$Sensitive[primary_lihc_res$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
```


```{r eval=FALSE}
limma_PRISM_test<- PRISM_testing(101,"HEPG2", lincs_limma_liver_res_HEPG2_top_fda$pert, drug_senstive_precentage_all_drugs)
```
```{r eval=FALSE}
limma_PRISM_test
```


```{r eval=FALSE}
len<- length(lincs_limma_liver_res_HEPG2_top_fda$pert)
num_clin <- nrow(lincs_limma_liver_res_HEPG2_top_fda[lincs_limma_liver_res_HEPG2_top_fda$clinical_trial_LIHC == TRUE,])
fract<- num_clin/len
limma_CT_test_res <- clinical_trial_testing(101, "HEPG2", len, fract, clinical_trial_LIHC)
```

```{r eval=FALSE}
limma_CT_test_res
```


#### Transfer Learning

```{r eval= FALSE}
recount3_plier <- readRDS("~/data/recount3_plier_wo.rds")
```

```{r eval= FALSE}
#There is a issue with handling genes with zero expression. Best thing to do is to remove the genes
test <- GetOrderedRowNorm(as.matrix(tpm_table),recount3_plier)
zeros<- rownames(test)[!complete.cases(test)]
tpm_table_v2<- tpm_table[!rownames(tpm_table) %in% zeros,]
```

create the b.matrix 
```{r eval= FALSE}
LIHC.GTEx.b.matrix <- GetNewDataB(as.matrix(tpm_table_v2), recount3_plier)
```

```{r eval=FALSE}
saveRDS(LIHC.GTEx.b.matrix, file= "~/output/liver_cancer/TFL_res/220808LIHC_GTEX_B_MATRIX.rds")
```

LVTestWrapperJLF <- function(b.matrix,
                          sample.info.df,
                          phenotype.col,
                          blocking,
                          file.lead,
                          plot.dir = "plots",
                          results.dir = "results",
                          use.bonferroni = FALSE,
                          significant.only = FALSE,
                          sig.threshold = 0.05)
```{r eval= FALSE}
sampleinfo<- cbind(colnames(LIHC.GTEx.b.matrix), as.character(all_metadata_v3$status), as.character(all_metadata$database))
colnames(sampleinfo) <- c("Sample", "Tumor","database")
sampleinfo<- as.data.frame(sampleinfo)
database<- all_metadata_v3$database
names(database)<- colnames(LIHC.GTEx.b.matrix)

LV_test_TCGA_BH <- LVTestWrapperJLF(b.matrix=LIHC.GTEx.b.matrix , sample.info.df= sampleinfo, phenotype.col= "Tumor", blocking= database, file.lead= "220808_LV_TCGA_GTEX_T_vs_NT_LIHC", plot.dir= "~/output/liver_cancer/TFL_res/", results.dir= "~/output/liver_cancer/TFL_res/", use.bonferroni= FALSE, sig.threshold = 0.05)
```

```{r eval=FALSE}
saveRDS(LV_test_TCGA_BH , file= "~/output/liver_cancer/TFL_res/220808_LIHC_GTEX_limma_TFL_res.rds")
```

are genes and heatmaps and pathway analysis

```{r eval= FALSE}
sig_LVs <- LV_test_TCGA_BH$limma[LV_test_TCGA_BH$limma$adj.P.Val < 0.05,]
```
```{r eval= FALSE}
hist(LV_test_TCGA_BH$limma$logFC)
```
Wanting to look at the lvs that are show extreme differences 
```{r eval=FALSE}
sd <- sd(LV_test_TCGA_BH$limma$logFC)
mean(LV_test_TCGA_BH$limma$logFC) - (3*sd)
mean(LV_test_TCGA_BH$limma$logFC) + (3*sd)
```
+/- 0.06 seems to be a good threshold because it is between 0.04 and 0.07


```{r eval= FALSE}
sig_LVs <- LV_test_TCGA_BH$limma[LV_test_TCGA_BH$limma$adj.P.Val < 0.05 & abs(LV_test_TCGA_BH$limma$logFC)> .07 ,]
```

```{r eval=FALSE}
SIG_LVs <- sig_LVs$LV
```

```{r eval=FALSE}
SIG_LVs
```

plot latent variable heatmap 
Latent Variable heatmap 

```{r eval=FALSE}
colSideColors<- ifelse(all_metadata_v3$status =="Primary Tumor","#440154FF","#228C8DFF" )
LIHC_GTEX_B_MATRIX_SIG<- LIHC.GTEx.b.matrix [rownames(LIHC.GTEx.b.matrix) %in% SIG_LVs, ]
heatmap.2(x=LIHC_GTEX_B_MATRIX_SIG, hclustfun=function(d) hclust(d, method="ward.D2"), labCol = FALSE, trace="none",ColSideColors=colSideColors, col=colorRampPalette(colors=c("blue", "black", "yellow")),cexRow= .5, dendrogram="both", cexCol = 0.5,main = "Significant Latent Varibles")

```
```{r eval=FALSE}
column_ha = HeatmapAnnotation(Sample=all_metadata_v3$status, col = list(Sample = c("Primary Tumor" = "#440154FF", "Solid Tissue Normal" = "#228C8DFF")))
col_fun = colorRamp2(c(-1, 0, 1), c("blue", "black", "yellow"))
Heatmap(LIHC_GTEX_B_MATRIX_SIG, nam= "LV Score",  col = col_fun, show_column_names = FALSE, clustering_distance_rows= "euclidean",
             clustering_distance_columns=  "euclidean",
             clustering_method_rows = "ward.D2" ,
             clustering_method_columns="ward.D2", top_annotation = column_ha, row_names_gp = gpar(fontsize = 8))
```



```{r eval=FALSE}
sig_Z_mt <- recount3_plier$Z[,LV_test_TCGA_BH$limma$adj.P.Val < 0.05 & abs(LV_test_TCGA_BH$limma$logFC)> .07 ]
colnames(sig_Z_mt) <- SIG_LVs
```


top 100 
```{r eval=FALSE}
topgene_1 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,1])][1:20]
topgene_2 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,2])][1:20]
topgene_3 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,3])][1:20]
topgene_4 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,4])][1:20]
topgene_5 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,5])][1:20]
topgene_6 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,6])][1:20]
topgene_7 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,7])][1:20]
topgene_8 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,8])][1:20]
topgene_9 <- rownames(sig_Z_mt)[order(-sig_Z_mt[,9])][1:20]
```

```{r eval=FALSE}
topgenes<- unique(c(topgene_1, topgene_2,topgene_3, topgene_4, topgene_5, topgene_6, topgene_7, topgene_8, topgene_9))
```


```{r eval=FALSE}
deseq2_lihc_tfl <- deseq2_lihc_normal[deseq2_lihc_normal$Symbol %in% topgenes,]
```


```{r eval=FALSE}
downset<- deseq2_lihc_tfl$Symbol[deseq2_lihc_tfl$log2FoldChange < 0]
upset<- deseq2_lihc_tfl$Symbol[deseq2_lihc_tfl$log2FoldChange > 0]
```

convert gene symbols to LINCS genes
```{r eval=FALSE}
upset_v2 <- match_to_LINCS_genes(upset)
downset_v2 <- match_to_LINCS_genes(downset)
```


```{r eval=FALSE}
downset_v2<- downset_v2[complete.cases(downset_v2)]
upset_v2<- upset_v2[complete.cases(upset_v2)]
```

```{r eval=FALSE}
#double check that they didn't overlap 
 intersect(downset_v2, upset_v2)
```

```{r eval=FALSE}
length(downset_v2)
length(upset_v2)
```

```{r eval=FALSE}
names(upset_v2)<- NULL
names(downset_v2)<- NULL
```

```{r eval=FALSE}
tfl_liver_list<- list(up= upset_v2, down= downset_v2)
```

```{r eval=FALSE}
saveRDS(tfl_liver_list,"~/output/liver_cancer/TFL_res/SR_gene_list_liver_tfl.rds")
```

```{r eval=FALSE}
set.seed(101)
qsig_lincs_tfl_liver_res <- qSig(query=list(upset=as.character(upset_v2), downset=as.character(downset_v2)), 
                   gess_method="LINCS", refdb=db_path)
```


```{r eval=FALSE}
set.seed(101)
library(parallel)
lincs_tfl_liver <- gess_lincs(qsig_lincs_tfl_liver_res, sortby="NCS", tau=FALSE)
#result(lincs)
```



```{r eval=FALSE}
lincs_tfl_liver_res <- result(lincs_tfl_liver)
```

```{r eval=FALSE}
write.csv(lincs_tfl_liver_res, file= "~/output/liver_cancer/TFL_res/220808_SR_LINCS_LIVER_TFL_RES.csv" )
```

```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2 <- lincs_tfl_liver_res[lincs_tfl_liver_res$cell == "HEPG2",]
```
tau 


```{r eval=FALSE}
tau_test<- tau_scores(lincs_tfl_liver_res_HEPG2, HEPG2_taudf)
```

```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2$jlf_tau<- tau_test
```

```{r eval=FALSE}
write.csv(lincs_tfl_liver_res_HEPG2, file= "~/output/liver_cancer/TFL_res/220808_lincs_tfl_liver_res_HEPG2_tau.csv" )
```

```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2_top <- lincs_tfl_liver_res_HEPG2[lincs_tfl_liver_res_HEPG2$NCS < 0 & lincs_tfl_liver_res_HEPG2$WTCS_FDR < 0.05 & lincs_tfl_liver_res_HEPG2$jlf_tau< -80,]
```

clinical trials

```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_tfl_liver_res_HEPG2_top$pert)
```


```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2_top$clinical_trial_LIHC <- clinical_trial_check(lincs_tfl_liver_res_HEPG2_top$pert, clinical_trial_LIHC)
```


```{r eval=FALSE}
lincs_tfl_liver_res_HEPG2_top_fda<- lincs_tfl_liver_res_HEPG2_top[lincs_tfl_liver_res_HEPG2_top$fda_approved== TRUE,]
#lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC<- ifelse(lincs_deseq_lihc_res_HEPG2_top_fda$clinical_trial_LIHC, "star", "")

lincs_tfl_liver_res_HEPG2_top_fda_order <- lincs_tfl_liver_res_HEPG2_top_fda[order(-lincs_tfl_liver_res_HEPG2_top_fda$NCS),]
lincs_tfl_liver_res_HEPG2_top_fda$pert <- factor(lincs_tfl_liver_res_HEPG2_top_fda$pert, levels = lincs_tfl_liver_res_HEPG2_top_fda_order$pert)
p<-ggplot(data=lincs_tfl_liver_res_HEPG2_top_fda, aes(x=pert, y=NCS, fill=jlf_tau, shape= clinical_trial_LIHC)) +
  geom_bar(stat="identity", color = "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/liver_cancer/TFL_res/220808_ggplot_tfl_tau_lihc_approved_candidates.png")
```

```{r}
knitr::include_graphics("~/output/liver_cancer/TFL_res/220808_ggplot_tfl_tau_lihc_approved_candidates.png")
```

```{r eval=FALSE}
#lincs_deseq_lihc_res_HEPG2_top 
write.csv(lincs_tfl_liver_res_HEPG2_top , file= "~/output/liver_cancer/TFL_res/220602_SR_LINCS_LIHC_TFL_RES_tau.csv" )
```



PRISM

```{r eval=FALSE}
primary_lihc_res_sub <-primary_lihc_res[ primary_lihc_res$Var2 %in% lincs_tfl_liver_res_HEPG2_top_fda$pert,]
```


```{r eval=FALSE} 
write.csv(primary_lihc_res_sub , file= "~/output/liver_cancer/TFL_res/220808_prism_tfl_candidates.csv" )
```

```{r eval=FALSE}
#primary_lihc_res_sub$Var2 <- factor(primary_lihc_res_sub$Var2, levels=unique(primary_lihc_res_sub$Var2))
primary_lihc_res_sub$Var2 <- factor(primary_lihc_res_sub$Var2, levels=unique(primary_lihc_res_sub$Var2[order(primary_lihc_res_sub$log_fold_change)]))
ggplot(primary_lihc_res_sub, aes(x=log_fold_change, y= Var2))+ geom_violin() +geom_vline(xintercept = 0.3)  + ylab("Drug Candidates") + xlab("log fold change")
ggsave("~/output/liver_cancer/TFL_res/220808_ggplot_TFL_candidates_prism_screen1.png")
```
```{r}
knitr::include_graphics("~/output/liver_cancer/TFL_res/220808_ggplot_TFL_candidates_prism_screen1.png")
```

```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res_sub$Sensitive[primary_lihc_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
ggplot(drug_senstive_precentage_all_drugs, aes( drug_fraction, drug_list, fill= test ))+ geom_bar(stat="identity", color ="black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Fraction of Sensitive Cell Lines") +labs(fill = "75% of Cell line are Sensitive")
ggsave("~/output/liver_cancer/TFL_res/220808_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```

```{r}
knitr::include_graphics("~/output/liver_cancer/TFL_res/220808_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```



```{r eval=FALSE}
drug_list <- as.vector(unique(primary_lihc_res$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_lihc_res$Sensitive[primary_lihc_res$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
```

```{r eval=FALSE}
tfl_PRISM_test<- PRISM_testing(101,"HEPG2", lincs_tfl_liver_res_HEPG2_top_fda$pert, drug_senstive_precentage_all_drugs)
```

```{r eval=FALSE}
tfl_PRISM_test
```


```{r eval=FALSE}
len<- length(lincs_tfl_liver_res_HEPG2_top_fda$pert)
num_clin <- nrow(lincs_tfl_liver_res_HEPG2_top_fda[lincs_tfl_liver_res_HEPG2_top_fda$clinical_trial_LIHC == TRUE,])
fract<- num_clin/len
tfl_CT_test_res <- clinical_trial_testing(101, "HEPG2", len, fract, clinical_trial_LIHC)
```

```{r eval=FALSE}
tfl_CT_test_res
```



```{r eval=FALSE}
venn_dia_methods(lincs_limma_liver_res_HEPG2_top_fda$pert, lincs_deseq_lihc_res_HEPG2_top_fda$pert, lincs_tfl_liver_res_HEPG2_top_fda$pert, file_name='~/output/liver_cancer/SR_drug_candidates_venn_diagram.png' )
```

### Save Data
### Save Figures
    
# END
    Location of final scripts:
    script
    
    Location of data produced:
    output
    
    Dates when operations were done:
    220601
    
## Versions
```{r}
sessionInfo()
```

