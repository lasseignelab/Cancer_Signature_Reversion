---
title: "220608_gbm_CT_PRSIM_UPDATE"
author: "Jennifer Fisher"
date: "6/8/2022"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# START 
    Goal/Purpose of operations: 
    quick summary 
    
    Finished psedocode on: Date
    
    System which operations were done on: my laptop(on cheaha), lab mac etc... 
    
    GitHub Repo:
    
    Directory of operations: /path
    
    Scripts being edited for operations: filename(s)
    
    Data being used: description and location
    
    Papers and tools: deseq with paper 

# STEPS
### Set working directory 
### load in data
clinical trials
```{r}
fda_info <- read.table("~/data/fda_product_info_df.csv" )
fda_approve <- fda_info[fda_info$market_status_v2 %in% c("Over-the-Counter", "Prescription" ),]
```

```{r}
FDA_APPROVAL_CHECK<- function(drug_list){
  return_list <- c()
  for (i in 1:length(drug_list)){
    test <- grep( drug_list[i], fda_approve$ActiveIngredient, ignore.case= TRUE)
    if (length(test)>0 ){
      return_list[i] <- TRUE
    }else{
      return_list[i] <- FALSE
    }
    if (nchar(drug_list[i])< 3){
      return_list[i] <- FALSE
    }
  }
  names(return_list)<- drug_list
  return(return_list)
}
```


```{r}
clinical_trial_GBM <- read_csv("~/data/SearchResults.csv")
```

```{r}
clinical_trial_check<- function(drug_list, clinical_trial_info){
    return_list <- c()
  for (i in 1:length(drug_list)){
    test <- grep( drug_list[i], clinical_trial_info$Interventions, ignore.case= TRUE)
    if (length(test)>0 ){
      return_list[i] <- TRUE
    }else{
      return_list[i] <- FALSE
    }
    if (nchar(drug_list[i])< 3){
      return_list[i] <- FALSE
    }
  }
  names(return_list)<- drug_list
  return(return_list)
}
```
PRISM

```{r}
library(readr)
primary_screen <- read_csv("~/data/DEPMAP_PRISM_220228/primary-screen-replicate-collapsed-logfold-change.csv")
sample_info <- read_csv("~/data/DEPMAP_PRISM_220228/sample_info.csv")
primary_screen_treatment_info <- read_csv("~/data/DEPMAP_PRISM_220228/primary-screen-replicate-collapsed-treatment-info.csv")
```
different order

```{r}
names_vector<- c()
for ( i in 2:ncol(primary_screen)){
  names_vector[i] <- primary_screen_treatment_info$name[ grep(colnames(primary_screen)[i], primary_screen_treatment_info$column_name)]
}
```

```{r}
good_id <- c()
for (i in 1:nrow(primary_screen)){
  good_id[i]<- nchar(primary_screen[i,1]) == 10 
}

```

```{r}
table(good_id)
```
```{r}
primary_screen_v2 <- primary_screen[good_id,]
```


```{r}
cell_vector<- c()
for ( i in 1:nrow(primary_screen_v2)){
  cell_vector[i] <-sample_info$stripped_cell_line_name[ grep(as.character(primary_screen_v2[i,1]), sample_info$DepMap_ID)]
}
```

```{r}
primary_screen_v3<-  as.matrix(primary_screen_v2[,-1])
rownames(primary_screen_v3)<- cell_vector
```


```{r}
colnames(primary_screen_v3) <- names_vector[-1]
```

```{r}
test2<- as.data.frame.table(primary_screen_v3, responseName = "log_fold_change")
```

```{r}
test2$Sensitive <- test2$log_fold_change < 0.3
```

filter by Pgbm cancer cell lines

```{r}
#table(sample_info$Subtype)
sample_info<- as.data.frame(sample_info)
paad_sample_info <- sample_info[grep("Glioblastoma", sample_info$Subtype),]
```

```{r}
primary_paad_res <- test2[test2$Var1 %in% as.vector(paad_sample_info$stripped_cell_line_name),]
```



```{r }
lincs_transfer_gbm_res_GI1_tau <- read_csv("~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau.csv")
```


```{r}
lincs_deseq_gbm_res_GI1C_top <- lincs_transfer_gbm_res_GI1_tau[lincs_transfer_gbm_res_GI1_tau$NCS < 0 & lincs_transfer_gbm_res_GI1_tau$WTCS_FDR < 0.05 & lincs_transfer_gbm_res_GI1_tau$jlf_tau< -80,]
```


```{r}
lincs_deseq_gbm_res_GI1C_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_deseq_gbm_res_GI1C_top$pert)
```
```{r}
lincs_deseq_gbm_res_GI1C_top$clinical_trial_GBM <- clinical_trial_check(lincs_deseq_gbm_res_GI1C_top$pert, clinical_trial_GBM)
```

### Analysis

```{r}
primary_paad_res_sub <-primary_paad_res[ primary_paad_res$Var2 %in% lincs_deseq_gbm_res_GI1C_top$pert,]
```


```{r eval=FALSE}
write.csv(primary_paad_res_sub , file= "~/output/TF_L_GBM/220602_prism_tfl_candidates.csv" )
```



```{r}
#clinical trials -testing

clinical_trial_testing<- function(seed, cell_line,number_sig_drugs, fraction_clinical_drugs, CT_DATA){
  FDA_CT_table<- CT_DATA
  library(HDF5Array)
  lincs_samples<- HDF5Array("~/data/lincs_2020.h5", name="colnames")
  lincs_samples<- as.vector(lincs_samples)

  lincs_samples_GBM <- lincs_samples[grep(cell_line,lincs_samples )]
  library(stringr)
  gbm_lincs_drugs <- as.vector(str_split(lincs_samples_GBM,  "__", simplify = TRUE)[,1])
  
  gbm_lincs_drugs<- gbm_lincs_drugs[FDA_APPROVAL_CHECK(gbm_lincs_drugs)]
  set.seed(seed)
  fraction<-c()
  for (i in 1:10000){
    test <- gbm_lincs_drugs[ sample(x = 1:length(gbm_lincs_drugs),size = number_sig_drugs ,replace = FALSE)]
    value2 <- c()
    
    #tables<- list()
    for (k in 1:number_sig_drugs){
      res <- grep(test[k], FDA_CT_table$Interventions, ignore.case=TRUE )
      res <- as.logical(length(res) > 0 )
     # print(res)
      #if (res == TRUE){
        #print(test[j])
      #}
      #print(j)
      #print(res)
      #print(length(res))
      #print(res)
      value2[k] <- res
    }
    res_table <- cbind(test, value2)
    fraction[i]<- table(res_table[,2])["TRUE"]
    #tables[i]<- res_table
    
  }
  fraction <- ifelse(is.na(fraction), 0, fraction)
  fraction_adj <- fraction/number_sig_drugs
  #hist(fraction_adj)
  #print(fraction_adj)
  
  plot_data<- as.data.frame(cbind(1:10000, fraction_adj))
  plot <- ggplot(plot_data, aes(x=fraction_adj)) + geom_histogram() + geom_vline(xintercept = fraction_clinical_drugs)
  
  print(plot)

  return(wilcox.test(fraction_adj,mu= fraction_clinical_drugs , alternative="less" ))
  #return(fraction_adj)
}
```


```{r}
drug_list <- as.vector(unique(primary_paad_res$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_paad_res$Sensitive[primary_paad_res$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
```


```{r}
#Prism testing
PRISM_testing<- function(seed, cell_line, drugs, drug_senstive_precentage_all_drugs){
  
  #check all drugs for fda approval
  library(HDF5Array)
  lincs_samples<- HDF5Array("~/data/lincs_2020.h5", name="colnames")
  lincs_samples<- as.vector(lincs_samples)

  lincs_samples_GBM <- lincs_samples[grep(cell_line,lincs_samples )]
  library(stringr)
  gbm_lincs_drugs <- as.vector(str_split(lincs_samples_GBM,  "__", simplify = TRUE)[,1])
  
  gbm_lincs_drugs<- gbm_lincs_drugs[FDA_APPROVAL_CHECK(gbm_lincs_drugs)]
  
   #get the median number of cell lines senestive to drugs for sigficant drug list 
  test_median <- median(drug_senstive_precentage_all_drugs$drug_fraction[ drug_senstive_precentage_all_drugs$drug_list %in% drugs ] )
  
  print(test_median)
  
  number_sig_drugs<- length(drugs)
  # do that again 10,000 times 
  set.seed(seed)
  fraction<-c()
  for (i in 1:10000){
    test <- gbm_lincs_drugs[ sample(x = 1:length(gbm_lincs_drugs),size = number_sig_drugs ,replace = FALSE)]
    fraction[i] <- median(drug_senstive_precentage_all_drugs$drug_fraction[ drug_senstive_precentage_all_drugs$drug_list %in% test ] )

    }
  #fraction <- ifelse(is.na(fraction), 0, fraction)
  #fraction_adj <- fraction
  #hist(fraction_adj)
  #print(fraction_adj)
  
  plot_data<- as.data.frame(cbind(1:10000, fraction))
  plot <- ggplot(plot_data, aes(x=fraction)) + geom_histogram() + geom_vline(xintercept = test_median)+ labs( x = "median fraction of sensitive cell lines") + annotate("text", x=(test_median + 0.1) , y=800, label= test_median)
  
  print(plot)

  return(wilcox.test(fraction, mu= test_median , alternative="less" ))
  #return(fraction_adj)
}
```

### TFL NOT DESEQ2 MISSED LABELED
```{r}
lincs_deseq_gbm_res_GI1C_fda_approved<- lincs_deseq_gbm_res_GI1C_top[lincs_deseq_gbm_res_GI1C_top$fda_approved == "TRUE",]
table(lincs_deseq_gbm_res_GI1C_fda_approved$clinical_trial_GBM)
```

```{r eval=FALSE}
write_csv(lincs_deseq_gbm_res_GI1C_fda_approved, "~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau_fda_approved.csv")
```



```{reval=FALSE}
#x<- 4/31
tfl_CT_test_res <- clinical_trial_testing(101, "GI1", 16, 0.4375 , clinical_trial_GBM)
```


```{r eval=FALSE}
TFL_PRISM_test<- PRISM_testing(101,"GI1", lincs_deseq_gbm_res_GI1C_fda_approved$pert, drug_senstive_precentage_all_drugs)
```

```{r eval=FALSE}
TFL_PRISM_test
```

##DESEQ2
```{r}
lincs_deseq2_gbm_res_GI1_tau <- read_csv("~/output/deseq2_gbm/220427_lincs_deseq_gbm_res_GI1_tau.csv")
```


```{r}
lincs_deseq2_gbm_res_GI1_tau_top <- lincs_deseq2_gbm_res_GI1_tau[lincs_deseq2_gbm_res_GI1_tau$NCS < 0 & lincs_deseq2_gbm_res_GI1_tau$WTCS_FDR < 0.05 & lincs_deseq2_gbm_res_GI1_tau$jlf_tau< -80,]
```


```{r}
lincs_deseq2_gbm_res_GI1_tau_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_deseq2_gbm_res_GI1_tau_top$pert)
```
```{r}
lincs_deseq2_gbm_res_GI1_tau_top$clinical_trial_GBM <- clinical_trial_check(lincs_deseq2_gbm_res_GI1_tau_top$pert, clinical_trial_GBM)
```



```{r}
lincs_deseq_gbm_res_GI1_fda_approved<- lincs_deseq2_gbm_res_GI1_tau_top[lincs_deseq2_gbm_res_GI1_tau_top$fda_approved == "TRUE",]
table(lincs_deseq_gbm_res_GI1_fda_approved$clinical_trial_GBM)
```

```{r eval=FALSE}
write_csv(lincs_deseq_gbm_res_GI1_fda_approved, file="~/output/deseq2_gbm/220427_lincs_deseq_gbm_res_GI1_tau_fda_approved.csv" )
```



```{r eval=FALSE}
#x<- 4/31
deseq2_CT_test_res <- clinical_trial_testing(101, "GI1", 12, 0.1666667 , clinical_trial_GBM)
```


```{r eval=FALSE}
deseq2_PRISM_test<- PRISM_testing(101,"GI1", lincs_deseq_gbm_res_GI1_fda_approved$pert, drug_senstive_precentage_all_drugs)
```

```{r eval=FALSE}
deseq2_PRISM_test
```


#### LIMMA
```{r}
lincs_limma_gbm_res_GI1_tau <- read_csv("~/output/limma_gbm/220421_SR_LINCS_GBM_LIMMA_RES.csv")
```


```{r}
lincs_limma_gbm_res_GI1_tau <- lincs_limma_gbm_res_GI1_tau [lincs_limma_gbm_res_GI1_tau$cell =="GI1",]
```



```{r}
GI1_taudf <- readRDS("~/data/GI1_taudf.rds")
```


```{r}
tau_scores<- function(results_df, tau_score_df){
  #download the tau values 
  #scores <- readRDS(tau_score_file)
  results_df$id <- paste(results_df$pert, results_df$cell, results_df$type, sep= "__")
  #print(results_df$id)
  tau_list<- c()
  for (i in 1:nrow(results_df)){
    #print( results_df$id[i])
    #print(colnames(tau_score_df) == results_df$id[i])
    index <- grepl(results_df$pert[i], colnames(tau_score_df))
   scores <- tau_score_df[,colnames(tau_score_df) == results_df$id[i]]
   #print(scores)
      tmpsum <- sum( abs(scores) < abs(results_df$NCS[i]))
      secd<- (tmpsum/length(scores)) *100
      tau<- secd* sign( results_df$NCS[i])
      #print(tau)
   tau_list[i]<- tau
  }
  return(tau_list)
}
```

```{r}
lincs_limma_gbm_res_GI1_tau$jlf_tau <- tau_scores(lincs_limma_gbm_res_GI1_tau , GI1_taudf )
```


```{r}
lincs_limma_gbm_res_GI1_top <- lincs_limma_gbm_res_GI1_tau[lincs_limma_gbm_res_GI1_tau$NCS < 0 & lincs_limma_gbm_res_GI1_tau$WTCS_FDR < 0.05 & lincs_limma_gbm_res_GI1_tau$jlf_tau< -80,]
```


```{r}
lincs_limma_gbm_res_GI1_top$fda_approved<- FDA_APPROVAL_CHECK(lincs_limma_gbm_res_GI1_top$pert)
```
```{r}
lincs_limma_gbm_res_GI1_top$clinical_trial_GBM <- clinical_trial_check(lincs_limma_gbm_res_GI1_top$pert, clinical_trial_GBM)
```



```{r}
lincs_limma_gbm_res_GI1_fda_approved<- lincs_limma_gbm_res_GI1_top[lincs_limma_gbm_res_GI1_top$fda_approved == "TRUE",]
table(lincs_limma_gbm_res_GI1_fda_approved$clinical_trial_GBM)
```

```{r eval=FALSE}
write_csv(lincs_limma_gbm_res_GI1_fda_approved, "~/output/limma_gbm/220421_SR_LINCS_GBM_LIMMA_RES_tau_fda_approved.csv")
```



```{r eval=FALSE}
#x<- 4/31
limma_CT_test_res <- clinical_trial_testing(101, "GI1", 16, 0.4666667 , clinical_trial_GBM)
```


```{r eval=FALSE}
limma_PRISM_test<- PRISM_testing(101,"GI1", lincs_limma_gbm_res_GI1_fda_approved$pert, drug_senstive_precentage_all_drugs)
```

```{r eval=FALSE}
TFL_PRISM_test
```


```{r}
clinical_trial_cancer_summary <- read_csv("~/output/220608_clinical_trial_cancer_summary.csv")
```

```{r}
clinical_trial_cancer_summary_v2 <- clinical_trial_cancer_summary %>% pivot_longer(c(CT, Not_Cl),names_to= "type" )
clinical_trial_cancer_summary_v2$type <- ifelse(clinical_trial_cancer_summary_v2$type == "CT", "Clinical Trial", "Not in Clinical Trial" )
```


```{r}
clinical_trial_cancer_summary$number <-  ifelse(clinical_trial_cancer_summary$significant== TRUE, (clinical_trial_cancer_summary$CT +clinical_trial_cancer_summary$Not_Cl), NA)
clinical_trial_cancer_summary$symbol <- ifelse(clinical_trial_cancer_summary$significant== TRUE, "*", "")
#clinical_trial_cancer_summary$cancer

labels <- clinical_trial_cancer_summary_v2$significant == TRUE & clinical_trial_cancer_summary_v2$type =="Clinical Trial"
labels_v2 <- ifelse(labels == "TRUE", "*", "")
clinical_trial_cancer_summary_v2$labels_v2<- labels_v2
```


```{r}
t <- ggplot(clinical_trial_cancer_summary_v2,aes(x=method,y=value,fill=type, label= value))+
  geom_bar(stat = "identity",color="white")+
  facet_wrap(~cancer,nrow=1) +                                                              # Add values on top of bars
  geom_text(size = 5, position = position_stack(vjust = 0.5)) + scale_fill_manual(values= c("#FDE725FF","#21908CFF")) + ylab("Number of Drug Candidates")
t + geom_text(aes(label=labels_v2),vjust=- 15,  size= 10) +ylim(0, 90)

```



drug analsysis for deseq and limma drugs
LINCS pathway & Drug targets

```{r}
drug_analysis <- function(drug_name, target_list,  tpm_df, sample_vector, deseq_results, se, cell_lincs= "__GI1__trt_cp", result_path){
  #drug target expression
  tpm_sub <- tpm_df[rownames(tpm_df) %in% target_list,]
  #print(tpm_sub[1,])
  tpm_sub$genes <- rownames(tpm_sub)
  tpm_sub_v2 <- tpm_sub %>%
  pivot_longer(!genes, names_to = "sample", values_to = "tpm")
  tpm_sub_v2$type <- rep(sample_vector, nrow(tpm_sub))
  name<- drug_name
  y_max<- max(tpm_sub_v2$tpm) +5
  
  
  deseq_sub <-  deseq_results[ deseq_results$Symbol %in% unique( tpm_sub$genes),]
  #deseq_sub<- deseq_sub[complete.cases(deseq_sub),]
  stat_table <- deseq_sub[,c(7,6)]
  stat_table$group1 <- rep("Primary Tumor" ,  nrow(tpm_sub))
  stat_table$group2 <- rep("Solid Tissue Normal" ,  nrow(tpm_sub))
  stat_table$padj <- ifelse(stat_table$padj < 0.05, formatC(stat_table$padj, format = "e", digits = 2), "")
  colnames(stat_table)<- c("genes", "padj" ,  "group1" ,"group2")
  
  
  file_name<- paste0(result_path, "/", drug_name, "_drug_target_expression_deseq2_padj.png")
  
  ggplot(tpm_sub_v2, aes(x=genes, y=tpm, color=type)) + geom_boxplot()+ stat_pvalue_manual(stat_table, x="genes" , label = "{padj}", y.position= y_max,  size = 3) + labs(title=name,x="Drug Targets", y = "Gene Expression (TPM)", color= "Sample Type") + scale_colour_manual(values =  c("#440154FF","#228C8DFF"), aesthetics = c("colour", "fill"))+theme_classic()
  ggsave(file_name, width = 20, height = 8)
  
  #pathway enrichment
  lincs_name<- paste0(drug_name, cell_lincs)
  sub <- se[,grep(lincs_name, colnames(se))]
  up <- sub[sub >= 2  ]
  up<- names(up[order(-up)])
  down<- sub[ sub <= -2 ]
  down <- names(down[order(down)])
  #print(down)
  downset_pathway_results <- gost(query = down, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  downset_pathway_results<- downset_pathway_results$result
  
  upset_pathway_results <- gost(query = up, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  upset_pathway_results<- upset_pathway_results$result
  
  pathway_results<- rbind(upset_pathway_results, downset_pathway_results)
  pathway_results$set<- c(rep("Up", nrow(upset_pathway_results)), rep("Down", nrow(downset_pathway_results)))
  file_name<- paste0(result_path, "/", drug_name, "_drug_pathways.csv")
  write.csv2(as.data.frame(pathway_results[,-14]), file_name )
  
  file_name<- paste0(result_path, "/", drug_name, "_drug_pathways.png")
  
  #making adjustments here
  #pathway_results$set <- factor(pathway_results$set, levels = c("up", "down"))
  
  if(nrow(pathway_results)<50){
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value))+geom_tile()+scale_fill_viridis(direction=-1)+theme_classic()+ labs(title=name,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
    
  }else{
    pathway_results<- pathway_results[pathway_results$source %in% c("KEGG","REAC","GO:MF" ),]
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value)) + geom_tile()+ scale_fill_viridis(direction=-1)+ theme_classic() + labs(title=name,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
  }
  ggsave(file_name, width = 12, height = 14)
  
}
```

```{r}
Counts_to_tpm <- function(counts, featureLength) {
  # Ensure valid arguments.
  stopifnot(length(featureLength) == nrow(counts))
  # Compute effective lengths of features in each library.
  effLen <- featureLength
  # Process one column at a time.
  tpm <- do.call(cbind, lapply(1:ncol(counts), function(i) {
    rate = log(counts[,i]) - log(effLen)
    denom = log(sum(exp(rate)))
    exp(rate - denom + log(1e6))
  }))
  # Copy the row and column names from the original matrix.
  colnames(tpm) <- colnames(counts)
  rownames(tpm) <- rownames(counts)
  return(tpm)
}
```


```{r}
recount3_gbm_gtex_tpm_df <- readRDS("~/output/recount3_gbm_gtex_tpm_df.rds")
```


```{r}
library(tidyr)
```

```{r}
library(signatureSearch)
library(HDF5Array)
se <- SummarizedExperiment(HDF5Array("~/data/lincs_2020.h5", name="assay"))
```

```{r}
rownames(se) <- HDF5Array("~/data/lincs_2020.h5", name="rownames")
colnames(se) <- HDF5Array("~/data/lincs_2020.h5", name="colnames")
```

```{r}
se_asssay<- assay(se)
```

```{r}
library(gprofiler2)
```

```{r}
deseq2_gbm_normal_gtx_res <- read_csv("~/output/deseq2_gbm/Deseq2_gbm_normal_gtx_res.csv", 
    col_names = FALSE, skip = 1)
deseq2_gbm_normal_gtx_res<- as.data.frame(deseq2_gbm_normal_gtx_res)
rownames(deseq2_gbm_normal_gtx_res) <- deseq2_gbm_normal_gtx_res[,1]
deseq2_gbm_normal_gtx_res<- deseq2_gbm_normal_gtx_res[,-1]
colnames(deseq2_gbm_normal_gtx_res)<- c("baseMean", "log2FoldChange",	"lfcSE",	"stat",	"pvalue",	"padj")
```

```{r}
#SRP118922
library(recount3)
human_projects<- available_projects()
test<- create_rse(human_projects[(human_projects$project == "SRP118922"),])
gene_info <- test@rowRanges
rm(test)
```

```{r}
dim(as.data.frame(gene_info))
```

```{r}
identical(gene_info$gene_id, rownames(deseq2_gbm_normal_gtx_res))
```

```{r}
deseq2_gbm_normal_gtx_res$Symbol<- gene_info$gene_name
```

```{r}
GBM_GTEX_metadata <- readRDS("~/output/TF_L_GBM/GBM_GTEX_metadata.rds")
```


```{r}
#lincs_limma_gbm_res_GI1_fda_approved$pert

for (i in 1:nrow(lincs_limma_gbm_res_GI1_fda_approved) ){
  targets<- as.vector(unlist(strsplit(lincs_limma_gbm_res_GI1_fda_approved$t_gn_sym[i], "; ")))
  #print(targets)
  drug_analysis( lincs_limma_gbm_res_GI1_fda_approved$pert[i], targets, as.data.frame(recount3_gbm_gtex_tpm_df), GBM_GTEX_metadata$status, deseq2_gbm_normal_gtx_res, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/limma_gbm/candidate_plots")
}

```


```{r}
for (i in 1:nrow(lincs_deseq_gbm_res_GI1_fda_approved) ){
  targets<- as.vector(unlist(strsplit(lincs_deseq_gbm_res_GI1_fda_approved$t_gn_sym[i], "; ")))
  #print(targets)
  drug_analysis( lincs_deseq_gbm_res_GI1_fda_approved$pert[i], targets, as.data.frame(recount3_gbm_gtex_tpm_df), GBM_GTEX_metadata$status, deseq2_gbm_normal_gtx_res, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/deseq2_gbm/candidate_plots")
}
for (i in 5:nrow(lincs_deseq_gbm_res_GI1_fda_approved) ){
  targets<- as.vector(unlist(strsplit(lincs_deseq_gbm_res_GI1_fda_approved$t_gn_sym[i], "; ")))
  #print(targets)
  drug_analysis( lincs_deseq_gbm_res_GI1_fda_approved$pert[i], targets, as.data.frame(recount3_gbm_gtex_tpm_df), GBM_GTEX_metadata$status, deseq2_gbm_normal_gtx_res, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/deseq2_gbm/candidate_plots")
}
for (i in 12:nrow(lincs_deseq_gbm_res_GI1_fda_approved) ){
  targets<- as.vector(unlist(strsplit(lincs_deseq_gbm_res_GI1_fda_approved$t_gn_sym[i], "; ")))
  #print(targets)
  drug_analysis( lincs_deseq_gbm_res_GI1_fda_approved$pert[i], targets, as.data.frame(recount3_gbm_gtex_tpm_df), GBM_GTEX_metadata$status, deseq2_gbm_normal_gtx_res, se= se_asssay, cell_lincs= "__GI1__trt_cp", "~/output/deseq2_gbm/candidate_plots")
}
```


#tfl_Prism
```{r}
primary_paad_res_sub <-primary_paad_res[ primary_paad_res$Var2 %in% lincs_deseq_gbm_res_GI1C_fda_approved$pert,]
```


```{r eval=FALSE}
write.csv(primary_paad_res_sub , file= "~/output/TF_L_GBM/220602_prism_tfl_candidates.csv" )
```

#deseq2_Prism

```{r}
primary_paad_res_sub <-primary_paad_res[ primary_paad_res$Var2 %in% lincs_deseq_gbm_res_GI1_fda_approved$pert,]
```


```{r eval=FALSE}
write.csv(primary_paad_res_sub , file= "~/output/deseq2_gbm/220602_prism_deseq2_candidates.csv" )
```

#limma_Prism

```{r}
primary_paad_res_sub <-primary_paad_res[ primary_paad_res$Var2 %in% lincs_limma_gbm_res_GI1_fda_approved$pert,]
```


```{r eval=FALSE}
write.csv(primary_paad_res_sub , file= "~/output/limma_gbm/220602_prism_limma_candidates.csv" )
```

```{r}
dim(drug_senstive_precentage_all_drugs)
```



```{r}
fraction_cell_line <- drug_senstive_precentage_all_drugs[1:30,]
```


```{r}
fraction_cell_line
```

# fraction first

data wrangle the cancers
```{r}
#Glioblastoma
##deseq2
drug_senstive_precentage_gbm_deseq2_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lincs_deseq_gbm_res_GI1_fda_approved$pert,]
drug_senstive_precentage_gbm_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_gbm_deseq2_drugs))
##limma
drug_senstive_precentage_gbm_limma_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lincs_limma_gbm_res_GI1_fda_approved$pert,]
drug_senstive_precentage_gbm_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_gbm_limma_drugs))
##tfl
drug_senstive_precentage_gbm_tfl_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lincs_deseq_gbm_res_GI1C_fda_approved$pert,]
drug_senstive_precentage_gbm_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_gbm_tfl_drugs))

drug_senstive_precentage_gbm_methods<- rbind(drug_senstive_precentage_gbm_tfl_drugs, drug_senstive_precentage_gbm_limma_drugs, drug_senstive_precentage_gbm_deseq2_drugs)
drug_senstive_precentage_gbm_methods$cancer <- rep("Glioblastima", nrow(drug_senstive_precentage_gbm_methods))
```

```{r}
#Liver hepatocellular carcinoma
liver_deseq_tau <- read_csv("~/output/liver_cancer/deseq2_res/220602_SR_LINCS_LIHC_DESEQ2_RES_tau.csv")
liver_deseq_tau_fda_approved <- liver_deseq_tau[liver_deseq_tau$fda_approved == TRUE, ]

liver_limma_tau <- read_csv("~/output/liver_cancer/limma_res/220602_SR_LINCS_LIHC_limma_RES_tau.csv")
liver_limma_tau_fda_approved <- liver_limma_tau[liver_limma_tau$fda_approved == TRUE,]

liver_limma_tau <- read_csv("~/output/liver_cancer/limma_res/220602_SR_LINCS_LIHC_limma_RES_tau.csv")
liver_limma_tau_fda_approved <- liver_limma_tau[liver_limma_tau$fda_approved == TRUE,]

liver_tfl_tau <- read_csv("~/output/liver_cancer/TFL_res/220602_SR_LINCS_LIHC_TFL_RES_tau.csv")
liver_tfl_tau_fda_approved <- liver_tfl_tau[liver_tfl_tau$fda_approved == TRUE,]

##deseq2
drug_senstive_precentage_lihc_deseq2_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% liver_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_lihc_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_lihc_deseq2_drugs))
##limma
drug_senstive_precentage_lihc_limma_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% liver_limma_tau_fda_approved$pert,]
drug_senstive_precentage_lihc_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_lihc_limma_drugs))
##tfl
drug_senstive_precentage_lihc_tfl_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% liver_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_lihc_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_lihc_tfl_drugs))

drug_senstive_precentage_lihc_methods<- rbind(drug_senstive_precentage_lihc_tfl_drugs, drug_senstive_precentage_lihc_limma_drugs, drug_senstive_precentage_lihc_deseq2_drugs)
drug_senstive_precentage_lihc_methods$cancer <- rep("Liver hepatocellular carcinoma", nrow(drug_senstive_precentage_lihc_methods))
```

```{r}
#lung adenocaracionoma
lung_deseq_tau <- read_csv("~/output/lung_cancer/deseq2_res/220602_SR_LINCS_LUAD_DESEQ2_RES_tau.csv")
lung_deseq_tau_fda_approved <- lung_deseq_tau[lung_deseq_tau$fda_approved == TRUE, ]

lung_limma_tau <- read_csv("~/output/lung_cancer/limma_res/220602_SR_LINCS_LUAD_limma_RES_tau.csv")
lung_limma_tau_fda_approved <- lung_limma_tau[lung_limma_tau$fda_approved == TRUE,]

lung_limma_tau <- read_csv("~/output/lung_cancer/limma_res/220602_SR_LINCS_LUAD_limma_RES_tau.csv")
lung_limma_tau_fda_approved <- lung_limma_tau[lung_limma_tau$fda_approved == TRUE,]

lung_tfl_tau <- read_csv("~/output/lung_cancer/TFL_res/220602_SR_LINCS_LUAD_TFL_RES_tau.csv")
lung_tfl_tau_fda_approved <- lung_tfl_tau[lung_tfl_tau$fda_approved == TRUE,]

##deseq2
drug_senstive_precentage_luad_deseq2_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lung_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_luad_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_luad_deseq2_drugs))
##limma
drug_senstive_precentage_luad_limma_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lung_limma_tau_fda_approved$pert,]
drug_senstive_precentage_luad_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_luad_limma_drugs))
##tfl
drug_senstive_precentage_luad_tfl_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% lung_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_luad_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_luad_tfl_drugs))

drug_senstive_precentage_luad_methods<- rbind(drug_senstive_precentage_luad_tfl_drugs, drug_senstive_precentage_luad_limma_drugs, drug_senstive_precentage_luad_deseq2_drugs)
drug_senstive_precentage_luad_methods$cancer <- rep("Lung adenocaracionoma", nrow(drug_senstive_precentage_luad_methods))



```


```{r}
#pancreatic adenicarcinoma
pancreas_deseq_tau <- read_csv("~/output/pancreas_cancer/deseq2_res/220602_SR_LINCS_PAAD_DESEQ2_RES_tau.csv")
pancreas_deseq_tau_fda_approved <- pancreas_deseq_tau[pancreas_deseq_tau$fda_approved == TRUE, ]

pancreas_limma_tau <- read_csv("~/output/pancreas_cancer/limma_res/220602_SR_LINCS_PAAD_limma_RES_tau.csv")
pancreas_limma_tau_fda_approved <- pancreas_limma_tau[pancreas_limma_tau$fda_approved == TRUE,]

pancreas_limma_tau <- read_csv("~/output/pancreas_cancer/limma_res/220602_SR_LINCS_PAAD_limma_RES_tau.csv")
pancreas_limma_tau_fda_approved <- pancreas_limma_tau[pancreas_limma_tau$fda_approved == TRUE,]

pancreas_tfl_tau <- read_csv("~/output/pancreas_cancer/TFL_res/220602_SR_LINCS_PAAD_TFL_RES_tau.csv")
pancreas_tfl_tau_fda_approved <- pancreas_tfl_tau[pancreas_tfl_tau$fda_approved == TRUE,]

##deseq2
drug_senstive_precentage_paad_deseq2_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% pancreas_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_paad_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_paad_deseq2_drugs))
##limma
drug_senstive_precentage_paad_limma_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% pancreas_limma_tau_fda_approved$pert,]
drug_senstive_precentage_paad_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_paad_limma_drugs))
##tfl
drug_senstive_precentage_paad_tfl_drugs<-drug_senstive_precentage_all_drugs[ drug_senstive_precentage_all_drugs$drug_list %in% pancreas_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_paad_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_paad_tfl_drugs))

drug_senstive_precentage_paad_methods<- rbind(drug_senstive_precentage_paad_tfl_drugs, drug_senstive_precentage_paad_limma_drugs, drug_senstive_precentage_paad_deseq2_drugs)
drug_senstive_precentage_paad_methods$cancer <- rep("Pancreatic adenicarcinoma", nrow(drug_senstive_precentage_paad_methods))

```

```{r}
drug_senstive_precentage_all_methods_cancers <- rbind(drug_senstive_precentage_paad_methods, drug_senstive_precentage_gbm_methods, drug_senstive_precentage_lihc_methods, drug_senstive_precentage_luad_methods)
```

```{r}
t <- ggplot(drug_senstive_precentage_all_methods_cancers,aes(x=method, y=drug_fraction ,fill=method))+
  #geom_point()+
  geom_violin() +
  geom_boxplot(width = 0.1, fill = "grey", color = "black") +
  facet_wrap(~cancer,nrow=1) + scale_fill_manual(values= c("#440154FF" ,"#21908CFF" ,"#FDE725FF")) + ylab("Fraction of Sensitive Cell Lines")
#t + geom_text(aes(label=labels_v2),vjust=- 15,  size= 10) +ylim(0, 90)
t
```

```{r}
primary_paad_res_v2 <- primary_paad_res[!is.na(primary_paad_res$log_fold_change),]


drug_list <- as.vector(unique(primary_paad_res_v2$Var2))
drug_median<- c()
for (i in 1:length(drug_list)){
  cells <-primary_paad_res_v2$log_fold_change[primary_paad_res_v2$Var2 %in% drug_list[i]]
  drug_median[i] <- median(cells)
}
drug_prism_median_all_drugs <- data.frame( drug_list, drug_median)
```


```{r}
#Glioblastoma
##deseq2
drug_senstive_precentage_gbm_deseq2_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lincs_deseq_gbm_res_GI1_fda_approved$pert,]
drug_senstive_precentage_gbm_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_gbm_deseq2_drugs))
##limma
drug_senstive_precentage_gbm_limma_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lincs_limma_gbm_res_GI1_fda_approved$pert,]
drug_senstive_precentage_gbm_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_gbm_limma_drugs))
##tfl
drug_senstive_precentage_gbm_tfl_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lincs_deseq_gbm_res_GI1C_fda_approved$pert,]
drug_senstive_precentage_gbm_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_gbm_tfl_drugs))

drug_senstive_precentage_gbm_methods<- rbind(drug_senstive_precentage_gbm_tfl_drugs, drug_senstive_precentage_gbm_limma_drugs, drug_senstive_precentage_gbm_deseq2_drugs)
drug_senstive_precentage_gbm_methods$cancer <- rep("Glioblastima", nrow(drug_senstive_precentage_gbm_methods))
```

```{r}
#Liver hepatocellular carcinoma

##deseq2
drug_senstive_precentage_lihc_deseq2_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% liver_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_lihc_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_lihc_deseq2_drugs))
##limma
drug_senstive_precentage_lihc_limma_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% liver_limma_tau_fda_approved$pert,]
drug_senstive_precentage_lihc_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_lihc_limma_drugs))
##tfl
drug_senstive_precentage_lihc_tfl_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% liver_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_lihc_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_lihc_tfl_drugs))

drug_senstive_precentage_lihc_methods<- rbind(drug_senstive_precentage_lihc_tfl_drugs, drug_senstive_precentage_lihc_limma_drugs, drug_senstive_precentage_lihc_deseq2_drugs)
drug_senstive_precentage_lihc_methods$cancer <- rep("Liver hepatocellular carcinoma", nrow(drug_senstive_precentage_lihc_methods))
```

```{r}
#lung adenocaracionoma

##deseq2
drug_senstive_precentage_luad_deseq2_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lung_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_luad_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_luad_deseq2_drugs))
##limma
drug_senstive_precentage_luad_limma_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lung_limma_tau_fda_approved$pert,]
drug_senstive_precentage_luad_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_luad_limma_drugs))
##tfl
drug_senstive_precentage_luad_tfl_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% lung_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_luad_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_luad_tfl_drugs))

drug_senstive_precentage_luad_methods<- rbind(drug_senstive_precentage_luad_tfl_drugs, drug_senstive_precentage_luad_limma_drugs, drug_senstive_precentage_luad_deseq2_drugs)
drug_senstive_precentage_luad_methods$cancer <- rep("Lung adenocaracionoma", nrow(drug_senstive_precentage_luad_methods))



```


```{r}
#pancreatic adenicarcinoma

##deseq2
drug_senstive_precentage_paad_deseq2_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% pancreas_deseq_tau_fda_approved$pert,]
drug_senstive_precentage_paad_deseq2_drugs$method <- rep("DESeq2", nrow(drug_senstive_precentage_paad_deseq2_drugs))
##limma
drug_senstive_precentage_paad_limma_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% pancreas_limma_tau_fda_approved$pert,]
drug_senstive_precentage_paad_limma_drugs$method <- rep("limma", nrow(drug_senstive_precentage_paad_limma_drugs))
##tfl
drug_senstive_precentage_paad_tfl_drugs<-drug_prism_median_all_drugs[ drug_prism_median_all_drugs$drug_list %in% pancreas_tfl_tau_fda_approved $pert,]
drug_senstive_precentage_paad_tfl_drugs$method <- rep("Transfer Learning", nrow(drug_senstive_precentage_paad_tfl_drugs))

drug_senstive_precentage_paad_methods<- rbind(drug_senstive_precentage_paad_tfl_drugs, drug_senstive_precentage_paad_limma_drugs, drug_senstive_precentage_paad_deseq2_drugs)
drug_senstive_precentage_paad_methods$cancer <- rep("Pancreatic adenicarcinoma", nrow(drug_senstive_precentage_paad_methods))

```

```{r}
drug_senstive_precentage_all_methods_cancers <- rbind(drug_senstive_precentage_paad_methods, drug_senstive_precentage_gbm_methods, drug_senstive_precentage_lihc_methods, drug_senstive_precentage_luad_methods)
```



```{r}
t <- ggplot(drug_senstive_precentage_all_methods_cancers,aes(x=method, y=drug_median ,fill=method))+
  #geom_point()+
  geom_violin() + geom_hline(yintercept=0.3, linetype="dashed", color = "red") +
  geom_boxplot(width = 0.1, fill = "grey", color = "black") +
  facet_wrap(~cancer,nrow=1) + scale_fill_manual(values= c("#440154FF" ,"#21908CFF" ,"#FDE725FF")) + ylab("Median log2fold change (PRISM)")
#t + geom_text(aes(label=labels_v2),vjust=- 15,  size= 10) +ylim(0, 90)
t
```


update figures for TRansfer Learning Figures
```{r}
lincs_deseq_gbm_res_GI1C_fda_approved <- read_csv( "~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau_fda_approved.csv")
```


```{r}

lincs_deseq_gbm_res_GI1C_fda_approved_order <- lincs_deseq_gbm_res_GI1C_fda_approved[order(-lincs_deseq_gbm_res_GI1C_fda_approved$NCS),]
lincs_deseq_gbm_res_GI1C_fda_approved$pert <- factor(lincs_deseq_gbm_res_GI1C_fda_approved$pert, levels = lincs_deseq_gbm_res_GI1C_fda_approved_order$pert)
p<-ggplot(data=lincs_deseq_gbm_res_GI1C_fda_approved, aes(x=pert, y=NCS, fill=jlf_tau, shape= clinical_trial_GBM)) +
  geom_bar(stat="identity", color = "black")+ scale_fill_viridis(direction=-1) + geom_point(aes(y = NCS - 0.15), position = position_dodge(0.9), size= 4, show.legend = TRUE)
p + coord_flip()  + ylab("Normalized Connectivity Score") + xlab("LINCS Small Molecules") +labs(fill = "Tau [-100,100]", shape= "Clinical Trials")

ggsave("~/output/TF_L_GBM/220613_ggplot_TFL_tau_GBM_approved_candidates.png")
```

```{r}

primary_paad_res_sub <-primary_paad_res[ primary_paad_res$Var2 %in% lincs_deseq_gbm_res_GI1C_fda_approved$pert,]


drug_list <- as.vector(unique(primary_paad_res_sub$Var2))
drug_fraction<- c()
for (i in 1:length(drug_list)){
  cells <-primary_paad_res_sub$Sensitive[primary_paad_res_sub$Var2 %in% drug_list[i]]
  cells<- cells[!is.na(cells)]
  if( length(cells) < 12){
    print(drug_list[i])
  }
  #x<- table(cells)
  drug_fraction[i] <- length(cells[cells== TRUE])/ length(cells)
}
test <- ifelse(drug_fraction > 0.75, TRUE, FALSE)
drug_senstive_precentage_all_drugs <- data.frame(drug_fraction, drug_list, test)
drug_senstive_precentage_all_drugs$drug_list<- factor(drug_senstive_precentage_all_drugs$drug_list, levels= unique(drug_senstive_precentage_all_drugs$drug_list[order(drug_senstive_precentage_all_drugs$drug_fraction)]))
drug_senstive_precentage_all_drugs$precent <- (drug_senstive_precentage_all_drugs$drug_fraction * 100)
ggplot(drug_senstive_precentage_all_drugs, aes( precent, drug_list, fill= test ))+ geom_bar(stat="identity", color = "black") + scale_fill_viridis_d() + ylab("Drug Candidates") + xlab("Precent of Sensitive Cell Lines") +labs(fill = ">= 75%")
ggsave("~/output/TF_L_GBM/220613_ggplot_TFL_candidates_prism_screen1_sensitive_cell_lines.png")
```
```{r}
limma_gbm_list <- readRDS("~/output/limma_gbm/SR_gene_list_gbm_limma.rds")
deseq_gbm_list <- readRDS("~/output/deseq2_gbm/SR_gene_list_gbm_deseq2.rds")
tfl_gbm_list <- readRDS("~/output/TF_L_GBM/SR_gene_list_gbm_tfl.rds")
```

compare gene list across the different methods
```{r}
library(VennDiagram)
```
```{r}
# Prepare a palette of 3 colors with R colorbrewer:
myCol <- c("#440154FF" , "#31688EFF" ,"#35B779FF")
```
```{r}
venn_dia_methods <- function(limma_list, deseq2_list, tfl_list, file_name='~/output/liver_cancer/SR_liver_all_gene_venn_diagram.png' ){
venn.diagram(
        x = list(limma_list, deseq2_list, tfl_list),
        category.names = c("limma" , "DESeq2" , "Transfer Learning"),
        filename = file_name,
        output=TRUE,
        
        # Output features
        imagetype="png" ,
        height = 1000 , 
        width = 1000 , 
        resolution = 300,
        compression = "lzw",
        
        # Circles
        lwd = 2,
        lty = 'blank',
        fill = myCol,
        
        # Numbers
        cex = .4,
        fontface = "bold",
        fontfamily = "sans",
        
        # Set names
        cat.cex = 0.3,
        cat.fontface = "bold",
        #cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.04, 0.04, 0.04),
        cat.fontfamily = "sans",
        rotation = 1
)
}
```

```{r}
venn_dia_methods(limma_gbm_list$up, deseq_gbm_list$up, tfl_gbm_list$up, file_name='~/output/gbm_plots/SR_up_genes_venn_diagram.png' )
```

```{r}
venn_dia_methods(limma_gbm_list$down, deseq_gbm_list$down, tfl_gbm_list$down, file_name='~/output/gbm_plots/SR_down_genes_venn_diagram.png' )
```

```{r}
venn_dia_methods(unlist(limma_gbm_list), unlist(deseq_gbm_list), unlist(tfl_gbm_list), file_name='~/output/gbm_plots/SR_all_genes_venn_diagram.png' )
```


```{r}
method_up_down_gene_set_analysis<- function(up, down,result_path, method, name){
  library(gprofiler2)
  downset_pathway_results <- gost(query = down, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  downset_pathway_results<- downset_pathway_results$result
  
  upset_pathway_results <- gost(query = up, 
                organism = "hsapiens", ordered_query = TRUE, 
                multi_query = FALSE, significant = TRUE, exclude_iea = FALSE, 
                measure_underrepresentation = FALSE, evcodes = FALSE, 
                user_threshold = 0.05, correction_method = "g_SCS", 
                domain_scope = "annotated", custom_bg = NULL, 
                numeric_ns = "", sources = NULL, as_short_link = FALSE)
  upset_pathway_results<- upset_pathway_results$result
  
  pathway_results<- rbind(upset_pathway_results, downset_pathway_results)
  pathway_results$set<- c(rep("Up", nrow(upset_pathway_results)), rep("Down", nrow(downset_pathway_results)))
  file_name<- paste0(result_path, "/", method, "_pathways.csv")
  write.csv2(as.data.frame(pathway_results[,-14]), file_name )
  
  file_name<- paste0(result_path, "/", method, "_pathways.png")
  
  #making adjustments here
  #pathway_results$set <- factor(pathway_results$set, levels = c("up", "down"))
  if(nrow(pathway_results)<50){
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value))+geom_tile()+scale_fill_viridis(direction=-1)+theme_classic()+ labs(title=name,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
    
  }else{
    pathway_results<- pathway_results[pathway_results$source %in% c("KEGG","REAC","GO:MF" ),]
    ggplot(pathway_results, aes(x=set, y=term_name, fill=p_value)) + geom_tile()+ scale_fill_viridis(direction=-1)+ theme_classic() + labs(title=name,x="Drug Gene Sets", y = "g:Profiler Gene Sets", fill= "p-value")
  }
  ggsave(file_name, width = 12, height = 14)
  return(as.data.frame(pathway_results[,-14]))
}
```

```{r}
limma_gbm_pathway_res <- method_up_down_gene_set_analysis(limma_gbm_list$up, limma_gbm_list$down, "~/output/gbm_plots/", "limma", "GBM_cancer_limma_input_genes_SR")
```

```{r}
deseq2_gbm_pathway_res<- method_up_down_gene_set_analysis(deseq_gbm_list$up, deseq_gbm_list$down, "~/output/gbm_plots/", "DESEq2", "gbm_cancer_deseq2_input_genes_SR")
```

```{r}
tfl_gbm_pathway_res<- method_up_down_gene_set_analysis(tfl_gbm_list$up, tfl_gbm_list$down, "~/output/gbm_plots/", "TFL", "gbm_cancer_tfl_input_genes_SR")
```


```{r}
limma<- limma_gbm_pathway_res$term_id[ limma_gbm_pathway_res$set == "Up"]
deseq2<- deseq2_gbm_pathway_res$term_id[ deseq2_gbm_pathway_res$set == "Up"]
tfl<-tfl_gbm_pathway_res$term_id[ tfl_gbm_pathway_res$set == "Up"]
venn_dia_methods(limma, deseq2, tfl, file_name='~/output/gbm_plots/SR_gbm_Up_pathway_venn_diagram.png' )
```

```{r}
limma<- limma_gbm_pathway_res$term_id[ limma_gbm_pathway_res$set == "Down"]
deseq2<- deseq2_gbm_pathway_res$term_id[ deseq2_gbm_pathway_res$set == "Down"]
tfl<-tfl_gbm_pathway_res$term_id[ tfl_gbm_pathway_res$set == "Down"]
venn_dia_methods(limma, deseq2, tfl, file_name='~/output/gbm_plots/SR_gbm_Down_pathway_venn_diagram.png' )
```

```{r}
limma<- limma_gbm_pathway_res$term_id
deseq2<- deseq2_gbm_pathway_res$term_id
tfl<-tfl_gbm_pathway_res$term_id
venn_dia_methods(limma, deseq2, tfl, file_name='~/output/gbm_plots/SR_gbm_all_pathway_venn_diagram.png' )
```


```{r eval=FALSE}
lincs_tfl_gbm_res_GI1_fda_approved <- read_csv( "~/output/TF_L_GBM/220207_lincs_transfer_gbm_res_GI1_tau_fda_approved.csv")
lincs_limma_gbm_res_GI1_fda_approved <- read_csv("~/output/limma_gbm/220421_SR_LINCS_GBM_LIMMA_RES_tau_fda_approved.csv")
lincs_deseq2_gbm_res_GI1_fda_approved <- read_csv("~/output/deseq2_gbm/220427_lincs_deseq_gbm_res_GI1_tau_fda_approved.csv")
```


```{r}
venn_dia_methods(lincs_limma_gbm_res_GI1_fda_approved$pert, lincs_deseq2_gbm_res_GI1_fda_approved$pert, lincs_tfl_gbm_res_GI1_fda_approved$pert, file_name='~/output/gbm_plots/SR_drug_candidates_venn_diagram.png' )
```








